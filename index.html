
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Controle de Rotinas ‚Äì Estoque | Minerva Foods</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<!-- EMAILJS -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<!-- GR√ÅFICOS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- EXPORT EXCEL -->
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>

<style>
:root{
  --minerva-red:#7A1417;--minerva-dark:#4a0c0e;--minerva-gold:#C69C6D;
  --bg:#eef1f5;--card-bg:#fff;--text-main:#333;
  --success-bg:#d1e7dd;--success-text:#0f5132;
  --warning-bg:#fff3cd;--warning-text:#664d03;
  --info:#0d6efd;--danger:#dc3545;
  --inventario-color: #6f42c1; /* Cor roxa para diferenciar Invent√°rio */
  --devolucao-color: #e67e22; /* Cor laranja para Devolu√ß√£o */
}
*{box-sizing:border-box;font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif}
body{margin:0;background:var(--bg);color:var(--text-main);font-size:13px}

/* LOGIN */
.login-overlay{position:fixed;inset:0;background:linear-gradient(135deg,var(--minerva-red) 0%,var(--minerva-dark) 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
.login-container{background:#fff;padding:40px;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.3);width:100%;max-width:400px;text-align:center}
.login-logo{color:var(--minerva-red);font-size:28px;font-weight:800;margin-bottom:10px;text-transform:uppercase}
.login-subtitle{color:#666;margin-bottom:30px;font-size:14px}
.login-form input{width:100%;padding:12px;margin-bottom:15px;border:2px solid #ddd;border-radius:6px;font-size:14px;transition:border-color .3s}
.login-form input:focus{outline:none;border-color:var(--minerva-red)}
.login-btn{width:100%;padding:12px;background:var(--minerva-red);color:#fff;border:none;border-radius:6px;font-size:16px;font-weight:600;cursor:pointer;transition:background .3s;margin-bottom:10px}
.login-btn:hover{background:var(--minerva-dark)}
.login-btn:disabled{background:#ccc;cursor:not-allowed}
.login-offline-alert{display:none;margin-top:10px;padding:10px 12px;border-radius:8px;background:rgba(255,255,255,.12);color:#fff;font-size:12px;text-align:left;line-height:1.35;border:1px solid rgba(255,255,255,.18)}
.loading{display:none;margin:20px 0}
.spinner{border:3px solid #f3f3f3;border-top:3px solid var(--minerva-red);border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

.toggle-link {
  display: block;
  margin-top: 15px;
  color: var(--minerva-red);
  font-size: 12px;
  text-decoration: underline;
  cursor: pointer;
}
.toggle-link:hover { color: var(--minerva-dark); }

/* NOVA: Links de navega√ß√£o entre formul√°rios */
.login-links {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 15px;
}
.login-links .toggle-link {
  margin: 0;
  padding: 8px 12px;
  background: rgba(122,20,23,0.1);
  border-radius: 6px;
  text-decoration: none;
  transition: all 0.3s;
}
.login-links .toggle-link:hover {
  background: rgba(122,20,23,0.2);
  transform: translateY(-1px);
}

/* Status Firebase no header */
.connection-status{background:rgba(255,255,255,.15);color:#fff;padding:8px 12px;border-radius:20px;font-size:12px;display:flex;align-items:center;gap:6px}
.connection-dot{width:8px;height:8px;border-radius:50%;background:#4CAF50;animation:pulse 2s infinite}
.connection-status.disconnected .connection-dot{background:#f44336;animation:none}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

.main-app{display:none}

/* HEADER AJUSTADO (Mobile Friendly) */
header {
  background: linear-gradient(135deg,var(--minerva-red) 0%,var(--minerva-dark) 100%);
  color: #fff;
  padding: 10px 20px 0 20px;
  display: flex;
  flex-wrap: wrap; /* Permite quebrar linha */
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,.2);
  gap: 15px;
}

.header-left { flex: 1; min-width: 200px; padding-bottom: 10px; }
.header-left h1 { margin: 0; font-weight: 800; font-size: 24px; letter-spacing: 1px; line-height: 1.1; text-transform: uppercase; }
.header-left h2 { margin: 0; font-weight: 400; font-size: 14px; opacity: .9; margin-top: 2px; }
.date-display { font-size: 12px; opacity: .7; margin-top: 4px; font-weight: 600; }

.header-right { display: flex; align-items: center; gap: 15px; padding-bottom: 10px; }
.online-counter { background: rgba(255,255,255,.15); padding: 6px 10px; border-radius: 20px; font-size: 11px; display: flex; align-items: center; gap: 6px; }
.online-indicator { width: 8px; height: 8px; background: #4CAF50; border-radius: 50%; animation: pulse 2s infinite; }
.user-info { display: flex; flex-direction: column; align-items: flex-end; font-size: 12px; }
.user-role { background: var(--minerva-gold); color: var(--minerva-dark); padding: 2px 8px; border-radius: 10px; font-weight: 600; font-size: 10px; }
.user-role.master { background: linear-gradient(45deg,#FFD700,#FFA500); color: #333; text-shadow: 0 1px 1px rgba(255,255,255,.5); border: 1px solid #FFD700; }
.logout-btn { background: rgba(255,255,255,.2); color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background .3s; }
.logout-btn:hover { background: rgba(255,255,255,.3); }

/* NAV - Linha separada */
nav { width: 100%; display: flex; justify-content: center; gap: 5px; padding-bottom: 10px; border-top: 1px solid rgba(255,255,255,0.15); padding-top: 10px; flex-wrap: wrap; }
nav button { background: none; border: none; color: rgba(255,255,255,.7); font-size: 13px; cursor: pointer; padding: 6px 14px; border-radius: 4px; transition: .3s; white-space: nowrap; font-weight: 600; }
nav button:hover { background: rgba(255,255,255,0.1); color: #fff; }
nav button.active { background: rgba(255,255,255,.2); color: #fff; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

/* CONTENT */
section{display:none;padding:15px;width:99%;max-width:100%;margin:0 auto}
section.active{display:block}
.card{background:var(--card-bg);border-radius:8px;padding:15px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,.06);border-top:3px solid var(--minerva-red)}

/* ROLES */
.admin-only,.master-only,.privileged-only{display:none}
body.user-admin .admin-only{display:inline-block}
body.user-master .admin-only{display:inline-block}
body.user-master .master-only{display:inline-block}
body.user-master .master-only.block{display:block}
body.user-admin .privileged-only{display:inline-block}
body.user-admin .privileged-only.flex{display:flex}
body.user-admin .privileged-only.block{display:block}
body.user-master .privileged-only{display:inline-block}
body.user-master .privileged-only.flex{display:flex}
body.user-master .privileged-only.block{display:block}

/* KPI */
.kpi-filters-container{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;background:#f8f9fa;padding:15px;border-radius:6px;border:1px solid #ddd;margin-bottom:20px}
.filter-group{display:flex;flex-direction:column;gap:4px}
.filter-group label{font-size:11px;font-weight:bold;color:#555;text-transform:uppercase}
.filter-group select,.filter-group input{padding:6px;border:1px solid #ccc;border-radius:4px;font-size:12px;min-width:130px}
.filter-group button{padding:6px 15px;background:var(--minerva-red);color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold;height:30px}
.filter-group button:hover{background:var(--minerva-dark)}
.kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.chart-container{position:relative;height:300px;width:100%}
.kpi-card-big{background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.06);border-top:3px solid var(--minerva-gold)}
.sla-box{text-align:center;padding:40px}
.sla-value{font-size:42px;font-weight:800;color:var(--minerva-red)}
.sla-label{font-size:16px;color:#666;text-transform:uppercase;letter-spacing:1px}
.status-legend{display:flex;justify-content:center;gap:15px;margin-top:10px;font-size:12px;font-weight:bold}
.legend-item span{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:5px}

/* TASKS - GRID REDEFINIDO V2 (% ap√≥s a√ß√µes) */
/* Ordem: Prio | Rotina | Analista | A√ß√µes | % | Status | Inicio | Fim */
.task-header{
  display:grid;
  grid-template-columns: .5fr 1.8fr 1fr 1.4fr .4fr 1.2fr .5fr .5fr;
  gap:8px;
  padding:0 8px 8px;
  border-bottom:2px solid #eee;
  margin-bottom:8px;
  font-weight:bold;
  color:var(--minerva-red);
  text-transform:uppercase;
  font-size:11px
}
.task{
  display:grid;
  grid-template-columns: .5fr 1.8fr 1fr 1.4fr .4fr 1.2fr .5fr .5fr;
  gap:8px;
  align-items:center;
  background:#fff;
  padding:4px 8px;
  margin-bottom:4px;
  border:1px solid #eee;
  border-radius:4px;
  font-size:12px;
  transition:background .3s
}

.task:hover{border-color:#ccc}
.task span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.prio-badge{font-size:10px;padding:2px 6px;border-radius:4px;color:#fff;font-weight:bold;text-align:center}
.p-alta{background:#dc3545}
.p-media{background:#ffc107;color:#333}
.p-baixa{background:#6c757d}
.task input,.task select{padding:3px 6px;font-size:11px;border:1px solid #ccc;border-radius:3px;width:100%;background:#fff}
.task input:focus,.task select:focus{outline:none;border-color:var(--minerva-red)}
.task div{display:flex;gap:4px}
.task button{padding:3px 8px;border:none;border-radius:3px;font-size:10px;color:#fff;cursor:pointer;font-weight:600;text-transform:uppercase}
.task button:hover{opacity:.8}
button:disabled{opacity:.3;cursor:not-allowed;filter:grayscale(100%);pointer-events:none}
.start{background:var(--info)}
.finish{background:var(--success-text)}
.partial{background:#e0a800}
.edit{background:#666}
.delete{background:var(--danger)}
.row-done{background:var(--success-bg);border-left:3px solid var(--success-text);color:var(--success-text)}
.row-partial{background:var(--warning-bg);border-left:3px solid var(--warning-text);color:var(--warning-text)}

/* Buttons */
.actions-bar{display:flex;gap:10px;margin-bottom:15px}
.primary-btn{background:var(--minerva-red);color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:600}
.primary-btn:hover{background:#5e0d11}
.panel-btn{background:#374151;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:600}
.panel-btn:hover{background:#1f2937}
.reset-btn{background:#e0a800;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:600}
.reset-btn:hover{background:#d39e00}
.clear-btn{background:var(--danger);color:#fff;padding:5px 10px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;font-size:11px}
.save-btn{background:#28a745;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:600;width:100%;margin-top:10px}
.save-btn:hover{background:#218838}
.excel-btn{background:#217346;color:#fff;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;font-size:11px;margin-right:5px}
.excel-btn:hover{background:#154b2e}
.kpi-filters-container .excel-btn{height:30px}

/* History */
.history-container{max-height:300px;overflow-y:auto;border:1px solid #eee;border-radius:4px}
.table{width:100%;border-collapse:collapse;font-size:12px}
.table th{background:#fff;position:sticky;top:0;z-index:1;text-align:left;padding:6px 8px;border-bottom:2px solid #eee}
.table td{border-bottom:1px solid #eee;padding:6px 8px}

/* Modals */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#fff;padding:20px;border-radius:8px;width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 10px 25px rgba(0,0,0,.2)}
.modal h3{margin-top:0;color:var(--minerva-red)}
.modal-content input,.modal-content select{width:100%;padding:8px;margin-bottom:10px;border:1px solid #ccc;border-radius:4px}

/* Panel */
.panel-section{margin-bottom:25px;border-bottom:1px solid #eee;padding-bottom:15px}
.panel-section:last-child{border-bottom:none}
.panel-title{font-size:14px;font-weight:bold;color:var(--text-main);margin-bottom:10px}
.list-container{max-height:180px;overflow-y:auto;margin-bottom:15px;border:1px solid #eee;border-radius:4px}
.list-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #eee;gap:10px}
.list-item:last-child{border-bottom:none}
.icon-btn{cursor:pointer;padding:4px 8px;font-size:12px;margin-left:5px;border-radius:3px;border:none;color:#fff}
.btn-edit{background:#666}
.btn-del{background:var(--danger)}
.badge{font-size:10px;font-weight:700;border-radius:999px;padding:2px 8px;display:inline-block;border:1px solid rgba(0,0,0,.15)}
.badge.master{background:#ffd54a;color:#333}
.badge.admin{background:#7A1417;color:#fff}
.badge.user{background:#6c757d;color:#fff}

/* Governance */
.governance-log{max-height:250px;overflow-y:auto;border:1px solid #eee;border-radius:4px;background:#f9f9f9}
.log-entry{padding:8px 12px;border-bottom:1px solid #e0e0e0;font-size:12px;display:flex;justify-content:space-between;align-items:center}
.log-entry:last-child{border-bottom:none}
.log-timestamp{color:#666;font-size:11px}

/* Responsive */
@media(max-width:768px){
  .kpi-grid{grid-template-columns:1fr}
  .header-right{flex-direction:column;gap:10px}
}

/* Toast */
.toast{position:fixed;top:20px;right:20px;background:var(--minerva-red);color:#fff;padding:12px 20px;border-radius:6px;z-index:10000;animation:slideIn .3s ease-out}
.toast.success{background:#28a745}
.toast.error{background:#dc3545}
.toast.warning{background:#ffc107;color:#333}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}

/* =========================================
   ESTILOS MOBILE GEST√ÉO (NOVA ABA)
   ========================================= */
.mob-controls-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
  background: #fff;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

/* NOVO: bot√µes de filtro (tipo) */
.mob-type-bar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.mob-filter-btn{
  flex:1;
  min-width: 120px; /* Ajustado para caber 4 abas */
  border: 1px solid #e5e7eb;
  background: #f8f9fa;
  border-radius: 10px;
  padding: 10px 12px;
  cursor: pointer;
  text-align: left;
  transition: .2s;
  opacity: 0.7; /* Visualmente indica que est√° "off" por padr√£o */
}
.mob-filter-btn:hover{ border-color:#d1d5db; transform: translateY(-1px); opacity: 1; }
.mob-filter-btn.active{
  border-color: rgba(122,20,23,.45);
  background: rgba(122,20,23,.06);
  box-shadow: 0 6px 14px rgba(122,20,23,.08);
  opacity: 1;
}
.mob-filter-title{
  font-size: 13px;
  font-weight: 800;
  color: #111827;
  text-transform: uppercase;
  letter-spacing: .4px;
}
.mob-filter-sub{
  font-size: 11px;
  font-weight: 700;
  color: #6b7280;
  margin-top: 4px;
}

/* NOVO: bot√µes de status (executando/fila/conclu√≠dos) */
.mob-status-bar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.mob-status-btn{
  flex:1;
  min-width: 110px;
  border: 1px solid #e5e7eb;
  background: #fff;
  border-radius: 12px;
  padding: 10px 10px;
  cursor: pointer;
  text-align: center;
  transition: .2s;
}
.mob-status-btn:hover{ border-color:#d1d5db; transform: translateY(-1px); }
.mob-status-btn.active{
  border-color: rgba(13,110,253,.35);
  box-shadow: 0 6px 16px rgba(13,110,253,.10);
}
.mob-status-btn.active.status-running{ border-color: rgba(13,110,253,.50); }
.mob-status-btn.active.status-pending{ border-color: rgba(107,114,128,.45); }
.mob-status-btn.active.status-done{ border-color: rgba(15,81,50,.45); }

.mob-summary-bar {
  display: flex;
  justify-content: space-between;
  border-top: 1px solid #eee;
  padding-top: 12px;
}
.mob-kpi-item {
  text-align: center;
  flex: 1;
}
.mob-kpi-value {
  font-size: 20px;
  font-weight: 800;
  color: var(--minerva-red);
}
.mob-kpi-label {
  font-size: 10px;
  text-transform: uppercase;
  color: #666;
  font-weight: 600;
}

.mob-section-title {
  color: #333;
  font-size: 14px;
  font-weight: 800;
  text-transform: uppercase;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.mob-running-card {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
  margin-bottom: 20px;
  padding: 16px;
  border-left: 6px solid #4CAF50; /* Verde running */
  position: relative;
  animation: pulse-border 2s infinite;
}
@keyframes pulse-border {
  0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
  70% { box-shadow: 0 0 0 6px rgba(76, 175, 80, 0); }
  100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
}

.mob-running-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
}
.mob-running-title {
  font-size: 16px;
  font-weight: 800;
  color: #222;
  line-height: 1.3;
}
.mob-analyst-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  background: #f8f9fa;
  padding: 8px;
  border-radius: 8px;
}
.mob-avatar-icon {
  width: 32px;
  height: 32px;
  background: var(--minerva-red);
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 14px;
}
.mob-analyst-name {
  font-size: 14px;
  font-weight: 700;
  color: #333;
}

.mob-timer-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
  color: #555;
  border-top: 1px solid #eee;
  padding-top: 10px;
}
.mob-live-timer {
  font-family: monospace;
  font-size: 16px;
  font-weight: 700;
  color: var(--minerva-red);
  background: #fff0f0;
  padding: 2px 6px;
  border-radius: 4px;
}

/* LISTA PENDENTE COMPACTA */
.mob-pending-list {
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.mob-pending-item {
  padding: 12px 15px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.mob-pending-item:last-child { border-bottom: none; }
.mob-pending-left { display: flex; align-items: center; gap: 10px; }
.mob-prio-dot {
  width: 10px; height: 10px; border-radius: 50%;
  flex-shrink: 0;
}
.bg-prio-alta { background: #dc3545; }
.bg-prio-media { background: #ffc107; }
.bg-prio-baixa { background: #6c757d; }

.mob-pending-name {
  font-size: 13px;
  font-weight: 600;
  color: #333;
}
.mob-pending-ctx {
  font-size: 10px;
  color: #999;
  font-weight: 600;
  text-transform: uppercase;
}

/* NOVO: lista de conclu√≠dos (mobile) */
.mob-done-list{
  background:#fff;
  border-radius: 10px;
  overflow:hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.mob-done-item{
  padding: 12px 15px;
  border-bottom: 1px solid #eee;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.mob-done-item:last-child{border-bottom:none}
.mob-done-top{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:flex-start;
}
.mob-done-title{
  font-size: 13px;
  font-weight: 800;
  color:#111827;
  line-height: 1.25;
}
.mob-done-meta{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  font-size: 11px;
  color:#6b7280;
  font-weight: 700;
}
.mob-pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.12);
  background:#f9fafb;
  color:#374151;
  font-size:10px;
  font-weight:800;
  text-transform: uppercase;
}
.mob-pill.done{ background: rgba(15,81,50,.08); border-color: rgba(15,81,50,.25); color: #0f5132; }
.mob-pill.partial{ background: rgba(249,168,37,.12); border-color: rgba(249,168,37,.30); color: #664d03; }
.mob-pill.ctx-pc{ background: rgba(122,20,23,.06); border-color: rgba(122,20,23,.20); color: #7A1417; }
.mob-pill.ctx-an{ background: rgba(13,110,253,.08); border-color: rgba(13,110,253,.22); color: #0d6efd; }
.mob-pill.ctx-inv{ background: rgba(111, 66, 193, 0.08); border-color: rgba(111, 66, 193, 0.22); color: #6f42c1; }
.mob-pill.ctx-dev{ background: rgba(230, 126, 34, 0.08); border-color: rgba(230, 126, 34, 0.22); color: #e67e22; }

.mob-done-bottom{
  display:flex;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  font-size: 12px;
  color:#374151;
}
.mob-done-strong{ font-weight: 800; }

/* =========================================
   NOVO: PROGRESSO DA ABA (HEADER)
   - aparece s√≥ em pc / analistas / inventario / devolucao
   - calcula "iniciadas" = status != pending
   - caminh√£o + ba√∫ preenchendo pelo %
   ========================================= */
.tab-progress{
  display:none; /* controlado no JS */
  align-items:center;
  gap:8px;
  background: rgba(255,255,255,.15);
  padding: 6px 10px;
  border-radius: 20px;
  border: 1px solid rgba(255,255,255,.18);
  color:#fff;
  min-width: 150px;
}
.tab-progress-truck svg{ width:56px; height:24px; display:block; }
.tab-progress-text{ display:flex; flex-direction:column; line-height:1.1; }
.tab-progress-title{ font-size:10px; font-weight:800; letter-spacing:.3px; opacity:.9; }
.tab-progress-value{ font-size:11px; font-weight:800; }

@media(max-width:768px){
  .tab-progress{ min-width: 130px; padding: 6px 8px; }
  .tab-progress-truck svg{ width:52px; height:22px; }
}


/* ===========================
   ROTINAS RECORRENTES (LEMBRETES)
=========================== */

.recurring-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.15);
  font-size:10px;
  font-weight:900;
  text-transform:uppercase;
  background: rgba(13,110,253,.08);
  color:#0d6efd;
}
.recurring-row{
  border-left: 4px solid #0d6efd !important;
  background: rgba(13,110,253,.05);
}
.recurring-row.due{
  background: rgba(220,53,69,.10);
  border-left-color: #dc3545 !important;
  animation: recurringBlink 1.1s infinite;
}
@keyframes recurringBlink{
  0%{ box-shadow: 0 0 0 0 rgba(220,53,69,.35); }
  50%{ box-shadow: 0 0 0 6px rgba(220,53,69,.00); }
  100%{ box-shadow: 0 0 0 0 rgba(220,53,69,.35); }
}
.recurring-actions{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.recurring-done-btn{
  background:#0d6efd;
  color:#fff;
  border:none;
  padding:3px 8px;
  border-radius:3px;
  font-size:10px;
  font-weight:800;
  cursor:pointer;
  text-transform:uppercase;
}
.recurring-del-btn{
  background:#dc3545;
  color:#fff;
  border:none;
  padding:3px 8px;
  border-radius:3px;
  font-size:10px;
  font-weight:800;
  cursor:pointer;
  text-transform:uppercase;
}


.recurring-badge.paused{
  background: rgba(107,114,128,.12);
  color:#6b7280;
  border-color: rgba(107,114,128,.25);
}



/* Form do cadastro de recorrentes (responsivo) */
.recurring-form-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:560px){
  .recurring-form-grid{grid-template-columns:1fr}
}



/* ===== RECORRENTES: EXTRA GRANDE E CHAMATIVO (OVERRIDE) ===== */

/* Aumenta bem a ‚Äúlinha‚Äù do lembrete nas abas */
.task.recurring-row{
  padding: 14px 12px !important;
  font-size: 16px !important;
  border: 2px solid rgba(0,0,0,.08) !important;
  border-left-width: 10px !important;
}

/* Nome do lembrete bem grande */
.task.recurring-row > span:first-of-type{
  font-size: 20px !important;
  font-weight: 900 !important;
  letter-spacing: .2px !important;
  line-height: 1.2 !important;
}

/* Colunas menores (analista/status/hor√°rio) tamb√©m aumentam */
.task.recurring-row span{
  font-weight: 800 !important;
}

/* Badge ‚ÄúRECORRENTE/PAUSADO‚Äù maior */
.task.recurring-row .recurring-badge{
  font-size: 12px !important;
  padding: 4px 10px !important;
  font-weight: 900 !important;
}

/* Prioridade maior */
.task.recurring-row .prio-badge{
  font-size: 12px !important;
  padding: 5px 10px !important;
  border-radius: 6px !important;
}

/* Bot√µes maiores */
.task.recurring-row .finish,
.task.recurring-row .delete{
  padding: 8px 12px !important;
  font-size: 12px !important;
  border-radius: 8px !important;
  font-weight: 900 !important;
}

/* Quando estiver VENCIDO: fundo vermelho Minerva escuro + pisca forte */
.task.recurring-row.due{
  background: #7A1417 !important;
  color: #fff !important;
  border-left-color: #4a0c0e !important;
  animation: recurringUrgentBlink 0.85s infinite !important;
}
.task.recurring-row.due .recurring-badge{
  background: rgba(255,255,255,.18) !important;
  color: #fff !important;
  border-color: rgba(255,255,255,.35) !important;
}
.task.recurring-row.due .prio-badge{
  background: #2b0607 !important;
  color: #fff !important;
}

@keyframes recurringUrgentBlink{
  0%   { filter: brightness(1);    box-shadow: 0 0 0 0 rgba(0,0,0,.35); }
  50%  { filter: brightness(1.18); box-shadow: 0 0 0 12px rgba(0,0,0,0); }
  100% { filter: brightness(1);    box-shadow: 0 0 0 0 rgba(0,0,0,.35); }
}



/* ===== RECORRENTES: FICAR GRANDE APENAS QUANDO ALARMAR (OVERRIDE FINAL) ===== */

/* Estado normal: s√≥ um pouco destacado (sem ‚Äúgigante‚Äù) */
.task.recurring-row{
  padding: 10px 10px !important;
  font-size: 13px !important;
  border: 2px solid rgba(0,0,0,.08) !important;
  border-left-width: 6px !important;
}
.task.recurring-row > span:first-of-type{
  font-size: 14px !important;
  font-weight: 900 !important;
  line-height: 1.2 !important;
}
.task.recurring-row .recurring-badge{
  font-size: 11px !important;
  padding: 3px 8px !important;
}
.task.recurring-row .prio-badge{
  font-size: 11px !important;
  padding: 4px 8px !important;
}
.task.recurring-row .finish,
.task.recurring-row .delete{
  padding: 6px 10px !important;
  font-size: 11px !important;
  border-radius: 8px !important;
}

/* Somente quando VENCIDO: fica bem grande e mais chamativo */
.task.recurring-row.due{
  padding: 18px 14px !important;
  font-size: 16px !important;
  border-left-width: 12px !important;
}
.task.recurring-row.due > span:first-of-type{
  font-size: 22px !important;
  letter-spacing: .2px !important;
}
.task.recurring-row.due .recurring-badge{
  font-size: 13px !important;
  padding: 5px 12px !important;
}
.task.recurring-row.due .prio-badge{
  font-size: 12px !important;
  padding: 6px 12px !important;
}
.task.recurring-row.due .finish,
.task.recurring-row.due .delete{
  padding: 10px 14px !important;
  font-size: 12px !important;
}



/* ===== RECORRENTES: TAMANHO NORMAL IGUAL AS OUTRAS (E GRANDE S√ì NO ALARME) ===== */

/* Igualar visual ao padr√£o das tasks */
.task.recurring-row:not(.due){
  padding: 4px 8px !important;
  font-size: 12px !important;
  border: 1px solid #eee !important;
  border-left: 3px solid #0d6efd !important;
  background: #fff !important;
  color: inherit !important;
  box-shadow: none !important;
}
.task.recurring-row:not(.due) span{
  font-weight: 600 !important;
}
.task.recurring-row:not(.due) > span:first-of-type{
  font-size: 12px !important;
  font-weight: 600 !important;
}
.task.recurring-row:not(.due) .recurring-badge{
  font-size: 10px !important;
  padding: 2px 8px !important;
}
.task.recurring-row:not(.due) .prio-badge{
  font-size: 10px !important;
  padding: 2px 6px !important;
  border-radius: 4px !important;
}
.task.recurring-row:not(.due) .finish,
.task.recurring-row:not(.due) .delete{
  padding: 3px 8px !important;
  font-size: 10px !important;
  border-radius: 3px !important;
}

/* Mant√©m o ALARME grande */
.task.recurring-row.due{
  background: #7A1417 !important;
  color: #fff !important;
  border: 2px solid rgba(0,0,0,.12) !important;
  border-left: 12px solid #4a0c0e !important;
  padding: 18px 14px !important;
  font-size: 16px !important;
}
.task.recurring-row.due > span:first-of-type{
  font-size: 22px !important;
  font-weight: 900 !important;
}
.task.recurring-row.due .recurring-badge{
  font-size: 13px !important;
  padding: 5px 12px !important;
  font-weight: 900 !important;
  background: rgba(255,255,255,.18) !important;
  color: #fff !important;
  border-color: rgba(255,255,255,.35) !important;
}
.task.recurring-row.due .prio-badge{
  background: #2b0607 !important;
  color: #fff !important;
  font-size: 12px !important;
  padding: 6px 12px !important;
}
.task.recurring-row.due .finish,
.task.recurring-row.due .delete{
  padding: 10px 14px !important;
  font-size: 12px !important;
  border-radius: 8px !important;
  font-weight: 900 !important;
}




/* =========================================
   AUDITORIA DE POSI√á√ÉO ‚Äì LAYOUT PROFISSIONAL (MINERVA)
   Mobile-first: mostra 1 c√¢mara por vez
   ========================================= */
#auditoria{padding:0}
#auditoria .audit-shell{padding:14px}

#auditoria .audit-top{
  background: linear-gradient(180deg, rgba(122,20,23,.08), rgba(255,255,255,.0));
  border: 1px solid rgba(0,0,0,.06);
  border-radius: 16px;
  padding: 14px;
}

#auditoria .audit-title-main{font-weight:900;letter-spacing:.2px;color:var(--minerva-red);font-size:18px}
#auditoria .audit-title-sub{margin-top:4px;color:#6b7280;font-size:12px}

#auditoria .audit-filters{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
#auditoria .audit-filter label{display:block;font-weight:800;margin:0 0 6px 0;color:#374151;font-size:12px}
#auditoria .audit-filter select, #auditoria .audit-filter input{
  width:100%;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;outline:none
}
#auditoria .audit-filter select:focus, #auditoria .audit-filter input:focus{
  border-color: var(--minerva-red);
  box-shadow: 0 0 0 3px rgba(122,20,23,.12);
}
#auditoria .audit-hint{margin-top:6px;color:#6b7280;font-size:11px;line-height:1.25}

#auditoria .audit-buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
#auditoria .audit-btn{border:none;border-radius:12px;padding:11px 12px;font-weight:900;cursor:pointer}
#auditoria .audit-btn-primary{background:var(--minerva-red);color:#fff;box-shadow:0 8px 20px rgba(122,20,23,.25)}
#auditoria .audit-btn-dark{background:#4b5563;color:#fff}
#auditoria .audit-btn-ghost{background:#fff;border:1px solid #e5e7eb;color:#374151}

#auditoria .audit-kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
#auditoria .audit-kpi{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:16px;padding:12px;text-align:center}
#auditoria .audit-kpi-value{font-size:28px;font-weight:900;color:var(--minerva-red);line-height:1}
#auditoria .audit-kpi-label{margin-top:8px;font-size:11px;color:#6b7280;font-weight:800;letter-spacing:.6px}

#auditoria .audit-body{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}

#auditoria .audit-column{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:16px;overflow:hidden;width:100%;max-width:980px}
#auditoria .audit-col-head{background:linear-gradient(90deg, rgba(122,20,23,.12), rgba(122,20,23,.03));padding:12px;display:flex;align-items:center;justify-content:space-between;gap:10px}
#auditoria .audit-col-title{font-weight:900;color:#111827}
#auditoria .audit-col-meta{font-size:12px;color:#6b7280;font-weight:800}

#auditoria .audit-list{display:flex;flex-direction:column;gap:10px;padding:12px}
#auditoria .audit-row{border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:12px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
#auditoria .audit-row-left{min-width:0}
#auditoria .audit-pos{font-weight:900;color:#111827;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#auditoria .audit-sub{margin-top:2px;color:#6b7280;font-size:11px;font-weight:700;display:flex;gap:10px;flex-wrap:wrap}
#auditoria .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;background:#f9fafb;border-radius:999px;padding:5px 9px}

#auditoria .audit-actions{display:flex;gap:8px}
#auditoria .audit-act{border:none;border-radius:10px;padding:10px 12px;font-weight:900;cursor:pointer;min-width:72px}
#auditoria .audit-ok{background:#16a34a;color:#fff}
#auditoria .audit-nok{background:#ef4444;color:#fff}

#auditoria .audit-row.audit-locked{position:relative}
#auditoria .audit-row.audit-locked::after{content:"Auditado";position:absolute;top:10px;right:12px;font-size:10px;font-weight:900;color:#6b7280}
#auditoria .audit-row.audit-locked .audit-act{opacity:.55;cursor:not-allowed}

#auditoria .audit-row.audit-locked[data-status="ok"]{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.06)}
#auditoria .audit-row.audit-locked[data-status="nok"]{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.06)}

#auditoria .audit-history{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:16px;overflow:hidden}
#auditoria .audit-history-head{padding:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;background:linear-gradient(90deg, rgba(122,20,23,.06), rgba(255,255,255,0))}
#auditoria .audit-history-title{font-weight:900;color:#111827}
#auditoria .audit-history-actions{display:flex;gap:8px;flex-wrap:wrap}
#auditoria .audit-mini{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:8px 10px;font-weight:900;cursor:pointer;color:#374151}

#auditoria .audit-history-filters{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px;border-top:1px solid rgba(0,0,0,.06)}
#auditoria .audit-history-table{padding:12px;border-top:1px solid rgba(0,0,0,.06)}
#auditoria .audit-history-note{padding:0 12px 12px;color:#6b7280;font-size:11px}

#auditoria .audit-table{width:100%;border-collapse:collapse;font-size:12px}
#auditoria .audit-table th{font-size:11px;color:#6b7280;text-align:left;padding:8px;border-bottom:1px solid #eef2f7}
#auditoria .audit-table td{padding:8px;border-bottom:1px solid #eef2f7;color:#111827}

#auditoria .audit-admin{padding:12px;border-top:1px solid rgba(0,0,0,.06)}
#auditoria .audit-admin-title{font-weight:900;color:#111827;margin-bottom:8px}
#auditoria .audit-admin-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
#auditoria .audit-admin-row input[type=file]{flex:1;min-width:220px}
#auditoria .audit-paste textarea{width:100%;margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px}
#auditoria .audit-admin-actions{display:flex;gap:10px;margin-top:8px;justify-content:flex-end}
#auditoria .audit-admin-hint{margin-top:8px;color:#6b7280;font-size:11px;line-height:1.25}


#auditoria .audit-history-bottom{margin-top:12px}
#auditoria .audit-history-bottom-inner{max-width:none}
#auditoria .audit-admin-details{margin-top:12px}
#auditoria .audit-admin-summary{cursor:pointer;font-weight:900;color:#111827;padding:10px 12px;border:1px dashed rgba(0,0,0,.18);border-radius:12px;background:#fff}
#auditoria .audit-admin-details[open] .audit-admin-summary{border-style:solid}

#auditoria .audit-finalize{padding:0 12px 14px;display:flex;flex-direction:column;gap:8px}
#auditoria .audit-finalize-hint{color:#6b7280;font-size:11px;line-height:1.25}
@media(min-width:900px){
  #auditoria .audit-filters{grid-template-columns:repeat(4,1fr)}
  #auditoria .audit-kpis{grid-template-columns:repeat(4,1fr)}
  }

#auditoria .audit-col-picker{padding:12px;border-top:1px solid rgba(0,0,0,.06)}

</style>
</head>

<body>
<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-container">
    <div class="login-logo">Minerva Foods</div>
    <div class="login-subtitle">Controle de Rotinas Operacionais</div>

    <!-- FORM LOGIN -->
    <form class="login-form" id="loginForm">
      <input type="email" id="loginEmail" name="username" placeholder="E-mail corporativo" autocomplete="username" required>
      <input type="password" id="loginPassword" name="password" placeholder="Senha" autocomplete="current-password" required>
      <button class="login-btn" id="loginBtn" type="submit">üöÄ ENTRAR NO SISTEMA</button>
      
      <!-- Links de navega√ß√£o -->
      <div class="login-links">
        <a class="toggle-link" onclick="showChangePasswordUI()">Alterar senha</a>
        <a class="toggle-link" onclick="showForgotPasswordUI()">Esqueci minha senha</a>
      </div>
    </form>

    <!-- FORM TROCAR SENHA (HIDDEN) -->
    <form class="login-form" id="changePassForm" style="display:none;" onsubmit="event.preventDefault(); tryChangePassword();">
      <h3 style="color:var(--minerva-red); margin-top:0;">Alterar Senha</h3>
      <input type="email" id="cpEmail" placeholder="Seu E-mail" required>
      <input type="password" id="cpOldPass" placeholder="Senha Atual" required>
      <input type="password" id="cpNewPass" placeholder="Nova Senha" minlength="4" required>
      
      <button class="login-btn" type="submit">SALVAR NOVA SENHA</button>
      <div class="login-links">
        <a class="toggle-link" onclick="hideChangePasswordUI()">Voltar para Login</a>
      </div>
    </form>

    <!-- FORM ESQUECI SENHA (HIDDEN) -->
    <form class="login-form" id="forgotPassForm" style="display:none;" onsubmit="event.preventDefault(); tryForgotPassword();">
      <h3 style="color:var(--minerva-red); margin-top:0;">Recuperar Senha</h3>
      <p style="font-size:12px; color:#666; margin-bottom:20px; line-height:1.4;">
        Insira seu e-mail abaixo. Se encontrado no sistema, enviaremos uma nova senha tempor√°ria.
      </p>
      <input type="email" id="fpEmail" placeholder="Seu E-mail" required>
      
      <button class="login-btn" id="forgotPassBtn" type="submit">üìß ENVIAR NOVA SENHA</button>
      <div class="login-links">
        <a class="toggle-link" onclick="hideForgotPasswordUI()">Voltar para Login</a>
      </div>
    </form>

    <div class="loading" id="loginLoading">
      <div class="spinner"></div>
      <p>Conectando...</p>
    </div>

    <div class="login-offline-alert" id="loginOfflineAlert">
      <strong>Modo offline bloqueado.</strong><br>
      N√£o foi poss√≠vel conectar ao Firebase. Verifique a internet/VPN e recarregue a p√°gina.
    </div>
  </div>
</div>

<!-- APP -->
<div class="main-app" id="mainApp">
<header>
  <div class="header-left">
    <h1>Minerva Foods</h1>
    <h2>Controle de rotinas Operacionais Estoque</h2>
    <div class="date-display" id="dateDisplay"></div>
  </div>

  <div class="header-right">
    <div class="connection-status" id="connectionStatus">
      <div class="connection-dot"></div>
      <span id="connectionText">Conectando...</span>
    </div>

    <div class="online-counter">
      <div class="online-indicator"></div>
      <span id="onlineCount">0 online</span>
    </div>

    <!-- NOVO: PROGRESSO POR ABA -->
    <div class="tab-progress" id="tabProgress" title="Progresso da aba (iniciadas/total)">
      <div class="tab-progress-truck" aria-hidden="true">
        <svg viewBox="0 0 96 40" role="img">
          <!-- chassis -->
          <rect x="8" y="26" width="64" height="6" rx="3" fill="rgba(255,255,255,.75)"/>
          <!-- cabine -->
          <rect x="10" y="14" width="18" height="12" rx="2" fill="rgba(255,255,255,.85)"/>
          <rect x="13" y="16" width="10" height="6" rx="1" fill="rgba(122,20,23,.25)"/>

          <!-- ba√∫ (moldura) -->
          <rect x="30" y="12" width="46" height="14" rx="2" fill="rgba(255,255,255,.18)" stroke="rgba(255,255,255,.75)" stroke-width="1"/>
          <!-- ba√∫ (progresso preenchido) -->
          <clipPath id="cargoClip">
            <rect x="31" y="13" width="44" height="12" rx="2"/>
          </clipPath>
          <rect id="cargoFill" x="31" y="13" width="0" height="12" fill="rgba(198,156,109,.95)" clip-path="url(#cargoClip)"/>

          <!-- rodas -->
          <circle cx="22" cy="33" r="4" fill="rgba(255,255,255,.9)"/>
          <circle cx="22" cy="33" r="2" fill="rgba(122,20,23,.65)"/>
          <circle cx="60" cy="33" r="4" fill="rgba(255,255,255,.9)"/>
          <circle cx="60" cy="33" r="2" fill="rgba(122,20,23,.65)"/>
        </svg>
      </div>

      <div class="tab-progress-text">
        <div class="tab-progress-title" id="tabProgressTitle">OPERACIONAIS</div>
        <div class="tab-progress-value" id="tabProgressValue">0/0 ‚Ä¢ 0%</div>
      </div>
    </div>

    <div class="user-info">
      <div id="userDisplayName">Usu√°rio</div>
      <div class="user-role" id="userRole">USER</div>
    </div>

    <button class="logout-btn" onclick="logoutUser()">Sair</button>
  </div>

  <!-- NAV (Mobile apenas ADMIN/MASTER) + IDs para n√£o quebrar active) + √çCONES ADICIONADOS -->
  <nav>
    <button id="navPcBtn" class="active" onclick="openTab('pc')">üì¶ ROTINAS OPERACIONAIS</button>
    <button id="navAnalistasBtn" onclick="openTab('analistas')">üíª ROTINAS ANALISTAS</button>
    <button id="navDevolucaoBtn" onclick="openTab('devolucao')">üîÑ ROTINAS DEVOLU√á√ÉO</button>
    <button id="navAuditBtn" onclick="openTab('auditoria')">üßæ AUDITORIA POSI√á√ÉO</button>
    <button id="navInventarioBtn" onclick="openTab('inventario')">üìã INVENT√ÅRIO AQ</button>
    <button id="navMobileBtn" class="privileged-only" onclick="openTab('mobile')">üì± MOBILE</button>
    <button id="navKpiBtn" onclick="openTab('kpi')">üìä KPI / DASHBOARD</button>
    <button id="navGovBtn" class="master-only" onclick="openTab('governance')">üîê GOVERNAN√áA</button>
  </nav>
</header>

<section id="pc" class="active">
  <div class="card">
    <div class="actions-bar">
      <button class="primary-btn privileged-only" onclick="openModal('pc')">+ NOVA ROTINA</button>
      <button class="panel-btn privileged-only" onclick="openManagementPanel('pc')">‚öôÔ∏è PAINEL GERENCIAL</button>
      <button class="reset-btn privileged-only" onclick="resetRotinas('pc')">REINICIAR ROTINAS</button>
    </div>

    <div class="task-header">
      <span>Prioridade</span>
      <span>Rotina</span>
      <span>Analista</span>
      <span>A√ß√µes</span>
      <span>%</span>
      <span>Status/Justificativa</span>
      <span>In√≠cio</span>
      <span>Fim</span>
    </div>

    <div id="tasks"></div>
  </div>
</section>

<section id="analistas">
  <div class="card">
    <div class="actions-bar">
      <button class="primary-btn privileged-only" onclick="openModal('analistas')">+ NOVA ROTINA (ANALISTA)</button>
      <button class="panel-btn privileged-only" onclick="openManagementPanel('analistas')">‚öôÔ∏è PAINEL GERENCIAL</button>
      <button class="reset-btn privileged-only" onclick="resetRotinas('analistas')">REINICIAR ROTINAS</button>
    </div>

    <div class="task-header">
      <span>Prioridade</span>
      <span>Rotina</span>
      <span>Analista</span>
      <span>A√ß√µes</span>
      <span>%</span>
      <span>Status/Justificativa</span>
      <span>In√≠cio</span>
      <span>Fim</span>
    </div>

    <div id="tasksAnalistas"></div>
  </div>
</section>

<!-- SE√á√ÉO DEVOLU√á√ÉO MOVIDA PARA ANTES DO INVENT√ÅRIO -->
<section id="devolucao">
  <div class="card" style="border-top-color: var(--devolucao-color);">
    <div class="actions-bar">
      <button class="primary-btn privileged-only" onclick="openModal('devolucao')">+ NOVA ROTINA (DEVOLU√á√ÉO)</button>
      <button class="panel-btn privileged-only" onclick="openManagementPanel('devolucao')">‚öôÔ∏è PAINEL GERENCIAL</button>
      <button class="reset-btn privileged-only" onclick="resetRotinas('devolucao')">REINICIAR ROTINAS</button>
    </div>

    <div class="task-header" style="color: var(--devolucao-color);">
      <span>Prioridade</span>
      <span>Rotina</span>
      <span>Analista</span>
      <span>A√ß√µes</span>
      <span>%</span>
      <span>Status/Justificativa</span>
      <span>In√≠cio</span>
      <span>Fim</span>
    </div>

    <div id="tasksDevolucao"></div>
  </div>
</section>

<section id="inventario">
  <div class="card" style="border-top-color: var(--inventario-color);">
    <div class="actions-bar">
      <button class="primary-btn privileged-only" onclick="openModal('inventario')">+ NOVA ROTINA (INVENT√ÅRIO)</button>
      <button class="panel-btn privileged-only" onclick="openManagementPanel('inventario')">‚öôÔ∏è PAINEL GERENCIAL</button>
      <button class="reset-btn privileged-only" onclick="resetRotinas('inventario')">REINICIAR ROTINAS</button>
    </div>

    <div class="task-header" style="color: var(--inventario-color);">
      <span>Prioridade</span>
      <span>Rotina</span>
      <span>Analista</span>
      <span>A√ß√µes</span>
      <span>%</span>
      <span>Status/Justificativa</span>
      <span>In√≠cio</span>
      <span>Fim</span>
    </div>

    <div id="tasksInventario"></div>
  </div>
</section>

<section id="mobile">
  <div style="margin-bottom:15px; text-align:center;">
    <h3 style="color:var(--minerva-red); margin:0;">Painel de Monitoramento</h3>
    <p style="font-size:12px; color:#666;">Vis√£o em tempo real da opera√ß√£o</p>
  </div>

  <div class="mob-controls-container">
    <!-- Filtros por tipo (Operacional / Analistas / Invent√°rio / Devolu√ß√£o / Todos) -->
    <div class="mob-type-bar">
      <button id="mobTypePcBtn" class="mob-filter-btn" onclick="toggleMobileType('pc')">
        <div class="mob-filter-title">üì¶ Operacional</div>
        <div id="mobCountPc" class="mob-filter-sub">0 rotinas</div>
      </button>

      <button id="mobTypeAnalistasBtn" class="mob-filter-btn" onclick="toggleMobileType('analistas')">
        <div class="mob-filter-title">üíª Analistas</div>
        <div id="mobCountAnalistas" class="mob-filter-sub">0 rotinas</div>
      </button>

      <button id="mobTypeDevolucaoBtn" class="mob-filter-btn" onclick="toggleMobileType('devolucao')">
        <div class="mob-filter-title" style="color: var(--devolucao-color);">üîÑ Devolu√ß√£o</div>
        <div id="mobCountDevolucao" class="mob-filter-sub">0 rotinas</div>
      </button>

      <button id="mobTypeInventarioBtn" class="mob-filter-btn" onclick="toggleMobileType('inventario')">
        <div class="mob-filter-title" style="color: var(--inventario-color);">üìã Invent√°rio</div>
        <div id="mobCountInventario" class="mob-filter-sub">0 rotinas</div>
      </button>
    </div>

    <div style="text-align:center; margin-top:5px;">
        <button id="mobTypeAllBtn" class="mob-filter-btn" style="min-width:120px; display:inline-block; padding: 6px 12px;" onclick="setMobileTypeAll()">
            <div class="mob-filter-title" style="font-size:11px;">üåç Ativar Todos</div>
        </button>
    </div>

    <!-- Filtros por status (Executando / Fila / Conclu√≠dos) -->
    <div class="mob-status-bar">
      <button id="mobStatusRunningBtn" class="mob-status-btn" onclick="setMobileStatusFilter('running')">
        <div id="mobKpiRunning" class="mob-kpi-value" style="color:#0d6efd">0</div>
        <div class="mob-kpi-label">Executando</div>
      </button>

      <button id="mobStatusPendingBtn" class="mob-status-btn" onclick="setMobileStatusFilter('pending')">
        <div id="mobKpiPending" class="mob-kpi-value" style="color:#666">0</div>
        <div class="mob-kpi-label">Fila</div>
      </button>

      <button id="mobStatusDoneBtn" class="mob-status-btn" onclick="setMobileStatusFilter('done')">
        <div id="mobKpiDone" class="mob-kpi-value" style="color:#0f5132">0</div>
        <div class="mob-kpi-label">Conclu√≠dos</div>
      </button>
    </div>
  </div>

  <!-- Executando -->
  <div id="mobileRunningSection">
    <div class="mob-section-title">
      <span>üü¢ Em Execu√ß√£o Agora</span>
    </div>
    <div id="mobileRunningContainer"></div>
  </div>

  <!-- Fila -->
  <div id="mobilePendingSection">
    <div class="mob-section-title" style="margin-top:0;">
      <span>üïí Fila de Espera (Pendentes)</span>
    </div>
    <div id="mobilePendingContainer" class="mob-pending-list"></div>
  </div>

  <!-- Conclu√≠dos -->
  <div id="mobileDoneSection">
    <div class="mob-section-title" style="margin-top:0;">
      <span>‚úÖ Conclu√≠dos (Hoje)</span>
    </div>
    <div id="mobileDoneContainer" class="mob-done-list"></div>
  </div>
</section>





<section id="auditoria">
  <div class="audit-shell">
    <div class="audit-top">
      <div class="audit-title">
        <div class="audit-title-main">Auditoria de Posi√ß√£o</div>
        <div class="audit-title-sub">Mobile-first: selecione uma c√¢mara por vez, sorteie e registre OK/NOK.</div>
      </div>

      <div class="audit-filters">
        <div class="audit-filter">
          <label for="auditQty">Quantidade por c√¢mara</label>
          <select id="auditQty">
            <option value="5">5 posi√ß√µes</option>
            <option value="10" selected>10 posi√ß√µes</option>
            <option value="15">15 posi√ß√µes</option>
            <option value="20">20 posi√ß√µes</option>
          </select>
        </div>

        <div class="audit-filter">
          <label for="auditNivelSelect">A partir do n√≠vel</label>
          <select id="auditNivelSelect">
            <option value="1" selected>N√≠vel 1 (ch√£o) em diante</option>
            <option value="all">Ambos os n√≠veis</option>
            <option value="gt1">Somente acima do 1</option>
          </select>
        </div>

        <div class="audit-filter">
          <label for="auditConsSelect">Conserva√ß√£o</label>
          <select id="auditConsSelect">
            <option value="AMBOS" selected>Ambos (Congelado + Resfriado)</option>
            <option value="CONGELADO">Congelado</option>
            <option value="RESFRIADO">Resfriado</option>
          </select>
        </div>
      </div>

      <div class="audit-buttons">
        <button id="auditDrawBtn" class="audit-btn audit-btn-primary" type="button">üé≤ NOVO SORTEIO</button>
        <button id="auditRefreshBtn" class="audit-btn audit-btn-dark" type="button">üîÑ ATUALIZAR</button>
        <button id="auditExportBtn" class="audit-btn audit-btn-dark" type="button">üì• EXPORTAR EXCEL</button>
        <button id="auditClearBtn" class="audit-btn audit-btn-ghost" type="button">üßπ LIMPAR</button>
      </div>

      <div class="audit-kpis">
        <div class="audit-kpi">
          <div id="auditKpiTotal" class="audit-kpi-value">0</div>
          <div class="audit-kpi-label">TOTAL POSI√á√ïES</div>
        </div>
        <div class="audit-kpi">
          <div id="auditKpiOk" class="audit-kpi-value">0</div>
          <div class="audit-kpi-label">CONFORMES (OK)</div>
        </div>
        <div class="audit-kpi">
          <div id="auditKpiNok" class="audit-kpi-value">0</div>
          <div class="audit-kpi-label">N√ÉO CONFORMES (NOK)</div>
        </div>
        <div class="audit-kpi">
          <div id="auditKpiPct" class="audit-kpi-value">0%</div>
          <div class="audit-kpi-label">% CONFORMIDADE</div>
        </div>
      </div>
    </div>

    <div class="audit-body">
      <div class="audit-column">
        <div class="audit-col-head">
          <div class="audit-col-title">C√¢mara selecionada</div>
          <div id="auditColMeta" class="audit-col-meta">0% (0/0)</div>
        </div>

        <div class="audit-col-picker audit-filter">
          <label for="auditCameraSelect">C√¢mara</label>
          <select id="auditCameraSelect">
            <option value="01">C√¢mara 01</option>
            <option value="02">C√¢mara 02</option>
            <option value="03">C√¢mara 03</option>
          </select>
          <div id="auditCameraHint" class="audit-hint">Carregue a lista para habilitar as c√¢maras dispon√≠veis.</div>
        </div>
        <div id="auditResults" class="audit-list"></div>
<div class="audit-finalize">  <button id="auditFinalizeBtn" class="audit-btn audit-btn-primary" type="button">‚úÖ FINALIZADO</button>  <div class="audit-finalize-hint">Salva no hist√≥rico quando todas as posi√ß√µes estiverem marcadas (OK/NOK).</div></div>
      </div>

      
    </div>

    <div class="audit-history-bottom">
<div class="audit-history audit-history-bottom-inner">
        <div class="audit-history-head">
          <div class="audit-history-title">Hist√≥rico de execu√ß√£o</div>
          <div class="audit-history-actions">
            <button id="auditHistoryReloadBtn" class="audit-mini" type="button">Recarregar</button>
            <button id="auditHistoryExportBtn" class="audit-mini" type="button">Exportar</button>            <button id="auditHistoryClearBtn" class="audit-mini" type="button">Zerar execu√ß√µes</button>

          </div>
        </div>

        <div class="audit-history-filters">
          <div class="audit-filter">
            <label for="auditHistCamera">C√¢mara</label>
            <select id="auditHistCamera">
              <option value="ALL" selected>Todas</option>
              <option value="01">C√¢mara 01</option>
              <option value="02">C√¢mara 02</option>
              <option value="03">C√¢mara 03</option>
            </select>
          </div>
          <div class="audit-filter">
            <label for="auditHistRange">Per√≠odo</label>
            <select id="auditHistRange">
              <option value="today">Hoje</option>
              <option value="7" selected>√öltimos 7 dias</option>
              <option value="30">√öltimos 30 dias</option>
              <option value="all">Tudo</option>
            </select>
          </div>
        </div>

        <div id="auditHistoryTable" class="audit-history-table"></div>
        <div class="audit-history-note">* O hist√≥rico √© salvo no Firebase e segue as permiss√µes do sistema.</div>

        <details id="auditAdminDetails" class="audit-admin-details" style="display:none;">
  <summary class="audit-admin-summary">‚öôÔ∏è Administra√ß√£o (Admin/Master)</summary>
  <div class="audit-admin">
          <div class="audit-admin-title">Importa√ß√£o da lista fixa (Admin/Master)</div>
          <div class="audit-admin-row">
            <input id="auditFile" type="file" accept=".txt" />
            <button id="auditPasteToggle" class="audit-mini" type="button">Colar texto</button>
            <button id="auditSavePositionsBtn" class="audit-btn audit-btn-dark" type="button">‚¨ÜÔ∏è Salvar posi√ß√µes no Firebase</button>
          </div>
          <div id="auditPasteBox" class="audit-paste" style="display:none;">
            <textarea id="auditText" rows="6" placeholder="Cole aqui: CAMARA;POSICAO;NIVEL;CONSERVACAO (1 por linha)"></textarea>
            <div class="audit-admin-actions">
              <button id="auditLoadTextBtn" class="audit-mini" type="button">Carregar lista</button>
              <button id="auditClearTextBtn" class="audit-mini" type="button">Limpar</button>
            </div>
          </div>
          <div class="audit-admin-hint">Formato recomendado: <b>CAMARA;POSICAO;NIVEL;CONSERVACAO</b>. CONSERVACAO: <b>RESFRIADO</b>, <b>CONGELADO</b> ou <b>AMBOS</b>. Se vier vazio, assume <b>AMBOS</b>.</div>
        </div>
</details>
      </div>
    </div>

  </div>
</section>
<section id="kpi">
  <div class="card">
    <h3 style="margin:0 0 10px 0; color:var(--minerva-red)">Dashboard de Performance</h3>

    <div class="kpi-filters-container">
      <div class="filter-group">
        <label>Data In√≠cio:</label>
        <input type="date" id="kpiDateStart" onchange="updateCharts()">
      </div>
      <div class="filter-group">
        <label>Data Fim:</label>
        <input type="date" id="kpiDateEnd" onchange="updateCharts()">
      </div>
      <div class="filter-group">
        <label>Tipo de Rotina:</label>
        <select id="kpiFilter" onchange="updateCharts()">
          <option value="all">Vis√£o Geral (Todos)</option>
          <option value="pc">Operacionais</option>
          <option value="analistas">Analistas</option>
          <option value="devolucao">Devolu√ß√£o</option>
          <option value="inventario">Invent√°rio AQ</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Analista:</label>
        <select id="kpiAnalista" onchange="updateCharts()">
          <option value="">Todos</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Status:</label>
        <select id="kpiStatus" onchange="updateCharts()">
          <option value="all">Todos (Conclu√≠dos/Parciais)</option>
          <option value="done">Apenas Conclu√≠dos</option>
          <option value="partial">Apenas Parciais</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Prioridade:</label>
        <select id="kpiPrioridade" onchange="updateCharts()">
          <option value="all">Todas</option>
          <option value="alta">Alta</option>
          <option value="media">M√©dia</option>
          <option value="baixa">Baixa</option>
        </select>
      </div>

      <div class="filter-group">
        <label>&nbsp;</label>
        <button onclick="updateCharts()">Filtrar</button>
      </div>

      <div class="filter-group privileged-only">
        <label>&nbsp;</label>
        <button class="excel-btn" onclick="exportKpiDashboardToExcel()">üì• EXCEL (DASHBOARD)</button>
      </div>
    </div>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card-big">
      <h3 style="text-align:center; color:var(--text-main); margin-bottom:15px;">üìä Status (Per√≠odo Selecionado)</h3>
      <div class="chart-container"><canvas id="chartStatus"></canvas></div>
      <div id="statusLegend" class="status-legend"></div>
    </div>

    <div class="kpi-card-big">
      <h3 style="text-align:center; color:var(--text-main); margin-bottom:15px;">üèÜ Ranking de Produtividade</h3>
      <div class="chart-container"><canvas id="chartRanking"></canvas></div>
    </div>

    <div class="kpi-card-big">
      <h3 style="text-align:center; color:var(--text-main); margin-bottom:15px;">üõë Top Motivos (Paradas)</h3>
      <div class="chart-container"><canvas id="chartMotivos"></canvas></div>
    </div>

    <div class="kpi-card-big">
      <h3 style="text-align:center; color:var(--text-main); margin-bottom:15px;">‚ö° Velocidade M√©dia (SLA)</h3>
      <div class="sla-box">
        <div id="slaValue" class="sla-value">00h 00m 00s</div>
        <div class="sla-label">Tempo M√©dio por Tarefa</div>
        <p style="font-size:12px; color:#999; margin-top:10px;">Considera apenas tarefas conclu√≠das.</p>
      </div>
    </div>
  </div>
</section>

<section id="governance">
  <div class="card">
    <h3 style="margin:0 0 15px 0; color:var(--minerva-red)">üìã Relat√≥rio de Governan√ßa</h3>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <h4>Log de A√ß√µes Administrativas</h4>
      <div>
        <button class="excel-btn master-only" onclick="exportGovernanceToExcel()">üì• EXCEL</button>
        <button class="clear-btn master-only" onclick="clearGovernanceLog()">LIMPAR LOG</button>
      </div>
    </div>

    <div class="governance-log" id="governanceLog"></div>
  </div>
</section>

<div class="card" style="width:99%;margin:0 auto 20px auto;" id="historyCard">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <h3 style="margin:0;color:var(--minerva-red)">Hist√≥rico de Execu√ß√£o - <span id="historyTitle">OPERACIONAIS</span></h3>
    <div>
      <button class="excel-btn privileged-only" onclick="exportToExcel()">üì• EXCEL (ATUAL)</button>
      <button class="clear-btn privileged-only" onclick="clearHistory()">LIMPAR HIST√ìRICO</button>
    </div>
  </div>

  <div class="history-container">
    <table class="table" id="historyTable">
      <thead>
        <tr>
          <th>Data</th><th>Rotina</th><th>Analista</th><th>Prioridade</th><th>Status/Justificativa</th>
          <th>In√≠cio</th><th>Fim</th><th>Dura√ß√£o</th><th>%</th><th>Status</th>
        </tr>
      </thead>
      <tbody id="history"></tbody>
    </table>
  </div>
</div>

<!-- Modal Rotina -->
<div class="modal" id="modal">
  <div class="modal-content" style="width:400px;">
    <h3 id="modalTitle">Gerenciar Rotina</h3>
    <input id="rotinaInput" placeholder="Nome da rotina...">
    <select id="rotinaPrio">
      <option value="alta">üî• Alta</option>
      <option value="media" selected>üü° M√©dia</option>
      <option value="baixa">üîµ Baixa</option>
    </select>
    <div style="text-align:right;">
      <button class="primary-btn" style="background:#ccc;color:#333;" onclick="closeModal()">Cancelar</button>
      <button class="primary-btn" onclick="saveRotina()">Salvar</button>
    </div>
  </div>
</div>

<!-- Modal Painel -->
<div class="modal" id="panelModal">
  <div class="modal-content">
    <h3>Painel Gerencial</h3>

    <div id="sectionPrio" class="panel-section">
      <div class="panel-title">üî• Prioridades das Rotinas (<span id="panelContextTitle"></span>)</div>
      <div class="list-container" id="prioList"></div>
      <button class="save-btn" onclick="savePriorities()">üíæ SALVAR PRIORIDADES</button>
    </div>

    <div id="sectionMotivos" class="panel-section">
      <div class="panel-title">üìã Motivos de Status/Justificativa</div>
      <div style="display:flex;gap:5px;margin-bottom:10px;">
        <input id="newMotivoInput" placeholder="Novo Motivo..." style="margin-bottom:0;">
        <button class="primary-btn" onclick="addMotivo()">Adicionar</button>
      </div>
      <div class="list-container" id="motivosList"></div>
    </div>

    <div id="sectionTeam" class="panel-section">
      <div class="panel-title">üë• Equipe Operacional</div>
      <div style="display:flex;gap:5px;margin-bottom:10px;">
        <input id="newAnalistaInput" placeholder="Novo Analista..." style="margin-bottom:0;">
        <button class="primary-btn" onclick="addAnalista()">Adicionar</button>
      </div>
      <div class="list-container" id="teamList"></div>
    </div>

    <div id="sectionPerms" class="panel-section master-only block">
      <div class="panel-title">üîê Permiss√µes (ADMIN)</div>
      <div style="display:flex;gap:5px;margin-bottom:10px;">
        <input id="newAdminEmailInput" placeholder="E-mail para ADMIN..." style="margin-bottom:0;">
        <button class="primary-btn" onclick="addAdminEmail()">Adicionar</button>
      </div>
      <div class="list-container" id="adminList"></div>
      <small style="color:#666;display:block;margin-top:6px;">
        Obs.: sem Firebase Authentication, isso controla apenas o acesso via interface/login local (n√£o √© seguran√ßa de backend).
      </small>
    </div>

    <div id="sectionUsers" class="panel-section master-only block">
      <div class="panel-title">üë§ Usu√°rios e Senhas (MASTER)</div>

      <div style="background:#f8f9fa;border:1px solid #e5e7eb;padding:12px;border-radius:8px;margin-bottom:10px;">
        <div style="font-weight:700;margin-bottom:6px;">Cadastrar novo usu√°rio</div>
        <div class="recurring-form-grid">
          <input id="newUserName" placeholder="Nome" style="margin:0;">
          <input id="newUserEmail" placeholder="E-mail" style="margin:0;">
          <input id="newUserPassword" placeholder="Senha" style="margin:0;" type="password">
          <select id="newUserRole" style="margin:0;">
            <option value="user">USER</option>
            <option value="admin">ADMIN</option>
          </select>
        </div>
        <button class="primary-btn" style="margin-top:10px;" onclick="addNewUser()">Cadastrar</button>
      </div>

      <div style="font-weight:700;margin-bottom:6px;">Usu√°rios cadastrados</div>
      <div class="list-container" id="usersList"></div>
      <small style="color:#666;display:block;margin-top:6px;">
        Obs.: as senhas ficam salvas no Firebase (texto puro) porque n√£o usamos Firebase Authentication.
      </small>
    </div>

    

    <div id="sectionRecurring" class="panel-section">
      <div class="panel-title">‚è∞ Rotinas Recorrentes (Lembretes)</div>

      <div style="background:#f8f9fa;border:1px solid #e5e7eb;padding:12px;border-radius:8px;margin-bottom:10px;">
        <div style="font-weight:800;margin-bottom:8px;">Cadastrar lembrete recorrente</div>

        <div class="recurring-form-grid">
          <input id="recName" placeholder="Ex.: Enviar relat√≥rio WhatsApp" style="margin:0;">

<div style="margin:0; display:flex; flex-direction:column; gap:6px;">
  <div style="font-size:11px;font-weight:800;color:#6b7280;text-transform:uppercase;letter-spacing:.3px;">Onde aparecer</div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
    <label style="display:flex;gap:6px;align-items:center;font-weight:800;font-size:12px;">
      <input type="checkbox" id="recCtxPc" checked> Operacionais
    </label>
    <label style="display:flex;gap:6px;align-items:center;font-weight:800;font-size:12px;">
      <input type="checkbox" id="recCtxAnalistas"> Analistas
    </label>
    <label style="display:flex;gap:6px;align-items:center;font-weight:800;font-size:12px;">
      <input type="checkbox" id="recCtxInventario"> Invent√°rio
    </label>
    <label style="display:flex;gap:6px;align-items:center;font-weight:800;font-size:12px;">
      <input type="checkbox" id="recCtxDevolucao"> Devolu√ß√£o
    </label>
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;">
    <button type="button" class="panel-btn" style="padding:6px 10px;" onclick="recSelectAllCtx(true)">Marcar todos</button>
    <button type="button" class="panel-btn" style="padding:6px 10px;" onclick="recSelectAllCtx(false)">Desmarcar todos</button>
  </div>
</div>


          <input id="recIntervalMin" type="number" min="1" step="1" placeholder="Intervalo (min) ex.: 10 / 60" style="margin:0;">
          <select id="recPrioridade" style="margin:0;">
            <option value="alta" selected>üî• Alta</option>
            <option value="media">üü° M√©dia</option>
            <option value="baixa">üîµ Baixa</option>
          </select>

          <select id="recAnalista" style="margin:0;">
            <option value="TODOS">TODOS</option>
          </select>

          <button class="primary-btn" style="margin:0;" onclick="addRecurringRoutine()" type="button">Cadastrar</button>
        </div>

        <small style="color:#666;display:block;margin-top:8px;line-height:1.3;">
          Quando vencer, a rotina fica <b>piscando</b> na aba correspondente at√© clicar em <b>Feito</b> (reagenda automaticamente para o pr√≥ximo intervalo).
        </small>
      </div>

            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin:8px 0 10px 0;">
        <button class="reset-btn" onclick="pauseAllRecurring()" title="Desativa todos os lembretes recorrentes">‚è∏Ô∏è PAUSAR TODOS</button>
        <button class="save-btn" style="width:auto;margin:0;" onclick="resumeAllRecurring()" title="Reativa todos os lembretes recorrentes e reagenda a partir de agora">‚ñ∂Ô∏è REATIVAR TODOS</button>
      </div>

<div class="list-container" id="recurringList"></div>
    </div>

<div style="text-align:right;margin-top:10px;">
      <button class="primary-btn" style="background:#ccc;color:#333;" onclick="closePanelModal()">Fechar Painel</button>
    </div>
  </div>
</div>

</div>

<script>
/* ===========================
   FIREBASE
=========================== */
const firebaseConfig = {
  apiKey: "AIzaSyDg92nX83l0yAA2KjjRgIB-m-C-a8YywYo",
  authDomain: "rotinas-estoque.firebaseapp.com",
  databaseURL: "https://rotinas-estoque-default-rtdb.firebaseio.com",
  projectId: "rotinas-estoque",
  storageBucket: "rotinas-estoque.firebasestorage.app",
  messagingSenderId: "1094421347742",
  appId: "1:1094421347742:web:9fc64ec3c4226b7df2aa8f",
  measurementId: "G-YMWTY70911"
};

let app, db, isFirebaseConnected = false;

try {
  app = firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  isFirebaseConnected = true;
  updateConnectionStatus(true, 'Online - Conectado ao Firebase');
} catch (error) {
  console.error('Erro ao conectar com Firebase:', error);
  isFirebaseConnected = false;
  updateConnectionStatus(false, 'Offline - Acesso bloqueado');
}

/* ===========================
   CONFIGURA√á√ÉO EMAILJS
=========================== */
const EMAILJS_PUBLIC_KEY = "WKR3sBHmhn6gEfigq";
const EMAILJS_SERVICE_ID = "service_nvobyei";
const EMAILJS_TEMPLATE_ID = "template_7g8aj6j";

// Inicializa EmailJS
try {
  emailjs.init(EMAILJS_PUBLIC_KEY);
} catch (error) {
  console.error('Erro ao inicializar EmailJS:', error);
}

function enforceOnlineOnlyUI() {
  const offlineAlert = document.getElementById('loginOfflineAlert');
  const loginBtn = document.getElementById('loginBtn');

  if (!isFirebaseConnected) {
    if (offlineAlert) offlineAlert.style.display = 'block';
    if (loginBtn) loginBtn.disabled = true;
  } else {
    if (offlineAlert) offlineAlert.style.display = 'none';
    if (loginBtn) loginBtn.disabled = false;
  }
}

function updateConnectionStatus(connected, message) {
  const statusEl = document.getElementById('connectionStatus');
  const textEl = document.getElementById('connectionText');
  if (!statusEl || !textEl) return;

  if (connected) statusEl.classList.remove('disconnected');
  else statusEl.classList.add('disconnected');

  textEl.textContent = message;
}

/* ===========================
   CONFIG / USERS
=========================== */
const MASTER_EMAIL = 'diego.cordeiro@minervafoods.com';

const COLL_PERMISSIONS = 'permissions';
const COLL_USERS = 'users_credentials';
const COLL_ROTINAS_PC = 'rotinas_pc';
const COLL_ROTINAS_ANALISTAS = 'rotinas_analistas';
const COLL_ROTINAS_INVENTARIO = 'rotinas_inventario';
const COLL_ROTINAS_DEVOLUCAO = 'rotinas_devolucao'; // NOVA COLE√á√ÉO
const COLL_HISTORY = 'history';
const COLL_CONFIG = 'config';
const COLL_GOV = 'governance';
const COLL_HISTORY_ARCHIVE = 'history_archive';
const COLL_RECURRING = 'recurring_routines';

// Labels amig√°veis para registrar origem das a√ß√µes (abas)
const VIEW_LABELS = {
  pc: 'ROTINAS OPERACIONAIS',
  analistas: 'ROTINAS ANALISTAS',
  devolucao: 'ROTINAS DEVOLU√á√ÉO',
  inventario: 'INVENT√ÅRIO AQ',
  mobile: 'MOBILE',
  kpi: 'KPI / DASHBOARD',
  auditoria: 'AUDITORIA DE POSI√á√ÉO',
  governance: 'GOVERNAN√áA'
};
function getViewLabel(viewId) {
  return VIEW_LABELS[viewId] || String(viewId || '-').toUpperCase();
}


let recurringRoutines = [];
let recurringMonitorInterval = null;

let permissionsLoaded = false;
let usersLoaded = false;

let adminEmails = ['roni.silva@minervafoods.com'];

let usersList = [
  { email: 'diego.cordeiro@minervafoods.com', name: 'Diego Cordeiro', password: 'CHANGE_ME' },
  { email: 'roni.silva@minervafoods.com', name: 'Roni Silva', password: 'CHANGE_ME' },
  { email: 'analistas@minervafoods.com', name: 'Equipe Analistas', password: 'CHANGE_ME' }
];
let usersMap = {};

/* ===========================
   APP STATE
=========================== */
let currentUser = null;
let currentUserRole = 'user';
let currentView = 'pc';
let onlineUsers = 0;
let realTimeListeners = {};
const taskActionLocks = new Set();
let mobileTimerInterval = null;

const DEFAULT_ROTINAS_PC = [
  "FEFO SEPARA√á√ÉO ESPECIFICO","FEFO SEPARA√á√ÉO CRITICO","VENCIDOS NO ESTOQUE",
  "AUDITORIA DE POSI√á√ÉO PICKING","ARMAZENAMENTO ONDA DE ABASTECIMENTO",
  "PONTA DE ESTOQUE","DE-PARA PICKING","RETORNO DE CAIXAS PARA DEVOLU√á√ÉO",
  "FANTASMINHA","MIGRA√á√ÉO DE ENDERE√áO PARA PERDIDOS","BAIXA PARA OPERA√á√ÉO",
  "INSER√á√ÉO DE ISCAS","CONFERENCIA A√äREO","ONDA REVERSA"
];

const DEFAULT_ROTINAS_ANALISTAS = [
  "FECHAMENTO DE OPS", "LAN√áAMENTO DE CUSTOS EXTRAS", "ACOMPANHAMENTO DE ANDAMENTO FEFO",
  "ACOMPANHAMENTO DE VENCIDOS RETIRADOS DO ESTOQUE", "% DE DIVERGENCIA DA AUDITORIA DE POSI√á√ÉO",
  "RETIRADA DE N√ÉO LOCALIZADAS", "TROCA ENTRE NEGOCIOS", "ARMAZENAGEM DA ONDA",
  "ACOMPANHAMENTO PONTA DE ESTOQUE", "% DE-PARA DO PICKING", "RETIRADA DAS SOLICITA√á√ïES DE FANTASMINHA",
  "BAIXA PENDENTE PARA OPERA√á√ÉO", "ISCAS INSERIDAS", "CONFER√äNCIA 429 SQL", "CONFERENCIA DO AEREO POR CAMARA"
];

const DEFAULT_ROTINAS_INVENTARIO = [
    "EMAIL INFORMATIVO A TODOS OS SETORES DA EXECU√á√ÉO DO INVENT√ÅRIO",
    "VERIFICAR VERS√ïES DOS COLETORES MOBILE",
    "EXTRA√á√ÉO DE RELATORIO WMS",
    "EXTRA√á√ÉO DE RELATORIO SQL",
    "BARRAS TIPO C",
    "BARRAS TIPO 28",
    "BARRAS TIPO 30",
    "FOLHAS OU FITAS PARA IDENTIFICA√á√ÉO DE PALETES INVENT√ÅRIADOS",
    "VERIFICA√á√ÉO DE OP'S DE DESCARGA EM ABERTO",
    "VERIFICA√á√ÉO DE OP'S DE DEVOLU√á√ÉO EM ABERTO",
    "EXCLUS√ÉO DE OPS NO ROMANEIO",
    "VERIFICA√á√ÉO DE ITENS SEM ENDERE√áO",
    "VERIFICAR COM COORPORATIVO SE OS RELATORIOS FORAM EXTRAIDOS",
    "ZERAR CAMARAS A INVENTARIAR",
    "TESTE DE PALETIZA√á√ÉO",
    "TESTE DE PALETIZAR O MESMO PALETE J√Å INVENT√ÅRIADO",
    "TESTE DE ENDERE√áAR PALETE N√ÉO INVENT√ÅRIADO",
    "TESTE BIPAR RG J√Å INVENT√ÅRIADO"
];

// NOVAS ROTINAS DE DEVOLU√á√ÉO
const DEFAULT_ROTINAS_DEVOLUCAO = [
  "ANALISE DE ATENDIMENTOS EM ATRASO",
  "PROGRAMAR CHARQUE",
  "PROGRAMAR GRAXARIA",
  "REUNI√ÉO DE ATENDIMENTOS EM ATRASO",
  "PRODUTO PARADO EM TSP",
  "PRODUTO SEM ENDERE√áO ORIGEM DEVOLU√á√ÉO"
];

const DEFAULT_ANALISTAS = ["LIVIA PORTA","WILLIAN SILAS","RODRIGO PRADO","EVERTON MORAES","PAULO AFONSO","ERICK SALES"];
const DEFAULT_MOTIVOS = ["FALTA DE TEMPO","SISTEMA INDISPON√çVEL","SEM DEMANDA","AGUARDANDO OUTRA √ÅREA"];

let rotinasPC = [];
let rotinasAnalistas = [];
let rotinasInventario = [];
let rotinasDevolucao = []; // NOVO ARRAY

// history = efetivo (master: vis√≠vel + archive; admin/user: s√≥ vis√≠vel)
let history = [];
let visibleHistory = [];
let archiveHistory = [];

let analistas = [...DEFAULT_ANALISTAS];
let motivos = [...DEFAULT_MOTIVOS];
let governanceLog = [];

let chartStatus = null;
let chartRanking = null;
let chartMotivos = null;

function todayLocalIso() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

const TODAY_ISO = todayLocalIso();
const TODAY_STR = new Date().toLocaleDateString('pt-BR');
document.getElementById('dateDisplay').innerText = TODAY_STR;

function nowTimeStr() {
  return new Date().toLocaleTimeString('pt-BR', { hour12: false });
}
function isPrivileged() { return currentUserRole === 'admin' || currentUserRole === 'master'; }

/* ===========================
   DETEC√á√ÉO DE MOBILE (AUTO-ABRIR ABA)
=========================== */
function isProbablyMobile() {
  const byScreen = window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
  const byUA = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || '');
  const byTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
  return byScreen || byUA || byTouch;
}

/* ===========================
   PARCIAL UI MODE
=========================== */
const partialModeByTaskId = {};
const partialDraftByTaskId = {};

function isPartialMode(taskId) { return !!partialModeByTaskId[String(taskId)]; }

function ensureDraft(taskId) {
  const k = String(taskId);
  if (!partialDraftByTaskId[k]) partialDraftByTaskId[k] = { percent: '', motivo: '' };
  return partialDraftByTaskId[k];
}

function enterPartialMode(taskId) {
  partialModeByTaskId[String(taskId)] = true;
  ensureDraft(taskId);
}

function exitPartialMode(taskId) {
  const k = String(taskId);
  delete partialModeByTaskId[k];
  delete partialDraftByTaskId[k];
}

function onPercentDraftInput(context, taskId, value) {
  const d = ensureDraft(taskId);
  d.percent = String(value || '');

  const motivo = String(d.motivo || '').trim();
  const percent = String(d.percent || '').trim();

  if (!motivo && !percent) {
    exitPartialMode(taskId);
    render();
  }
}

function onMotivoDraftChange(context, taskId, value) {
  const d = ensureDraft(taskId);
  d.motivo = String(value || '');

  const motivo = String(d.motivo || '').trim();
  const percent = String(d.percent || '').trim();

  if (!motivo && !percent) {
    exitPartialMode(taskId);
    render();
  }
}

/* ===========================
   PRIORIDADE / ORDENA√á√ÉO
=========================== */
const PRIORITY_ORDER = { alta: 0, media: 1, baixa: 2 };

function ensureOrderIndex(list) {
  let changed = false;
  list.forEach((t, i) => {
    if (typeof t.orderIndex !== 'number') { t.orderIndex = i; changed = true; }
  });
  return changed;
}

// Ordena s√≥ pendentes/em andamento por prioridade; done/partial ficam no fim na ordem atual
function sortByStatusAndPriority(context) {
  let list;
  if (context === 'pc') list = rotinasPC;
  else if (context === 'analistas') list = rotinasAnalistas;
  else if (context === 'inventario') list = rotinasInventario;
  else list = rotinasDevolucao;

  const active = [];
  const finished = [];

  for (const t of list) {
    if (t && (t.status === 'done' || t.status === 'partial')) finished.push(t);
    else active.push(t);
  }

  ensureOrderIndex(active);

  active.sort((a, b) => {
    const pa = PRIORITY_ORDER[a.prioridade] ?? 99;
    const pb = PRIORITY_ORDER[b.prioridade] ?? 99;
    if (pa !== pb) return pa - pb;
    return (a.orderIndex ?? 0) - (b.orderIndex ?? 0);
  });

  list.splice(0, list.length, ...active, ...finished);
}

function applyDefaultPrioritiesAndOrder(context) {
  let list;
  if (context === 'pc') list = rotinasPC;
  else if (context === 'analistas') list = rotinasAnalistas;
  else if (context === 'inventario') list = rotinasInventario;
  else list = rotinasDevolucao;

  ensureOrderIndex(list);

  list.sort((a,b) => (a.orderIndex ?? 0) - (b.orderIndex ?? 0));

  if (context === 'pc') {
    list.forEach((t, i) => {
      t.prioridade = i < 5 ? 'alta' : (i < 10 ? 'media' : 'baixa');
    });
  } else {
    // Analistas, Invent√°rio e Devolu√ß√£o tudo Alta por padr√£o
    list.forEach(t => { t.prioridade = 'alta'; });
  }

  list.sort((a,b) => {
    const pa = PRIORITY_ORDER[a.prioridade] ?? 99;
    const pb = PRIORITY_ORDER[b.prioridade] ?? 99;
    if (pa !== pb) return pa - pb;
    return (a.orderIndex ?? 0) - (b.orderIndex ?? 0);
  });
}

function resetRoutineFields(task) {
  task.status = 'pending';
  delete task.inicio;
  delete task.fim;
  delete task.analista;
  delete task.percent;
  delete task.inicioTs;

  // NOVO: limpa dados usados pelo "Conclu√≠dos" do MOBILE (via STATUS)
  delete task.fimTs;
  delete task.lastMotivo;
  delete task.durationSec;
  delete task.duracao;

  if (task && task.id) exitPartialMode(task.id);
}

/* ===========================
   FIRESTORE HELPERS
=========================== */
async function saveToFirebase(collection, data) {
  if (!isFirebaseConnected) throw new Error('Firebase offline (bloqueado)');
  await db.collection(collection).doc('data').set(data);
  return true;
}
async function loadFromFirebase(collection) {
  if (!isFirebaseConnected) throw new Error('Firebase offline (bloqueado)');
  const doc = await db.collection(collection).doc('data').get();
  return doc.exists ? doc.data() : null;
}


// Salva apenas as rotinas recorrentes (n√£o depende do saveData completo)
async function saveRecurringOnly() {
  if (!isFirebaseConnected) throw new Error('Firebase offline (bloqueado)');
  await db.collection(COLL_RECURRING).doc('data').set({ items: recurringRoutines, lastUpdate: new Date() });
}

// Salva somente as rotinas (por aba) no Firestore
async function saveRotinasContext(context) {
  if (!isFirebaseConnected) throw new Error('Firebase offline (bloqueado)');

  let list;
  let coll;
  if (context === 'pc') { list = rotinasPC; coll = COLL_ROTINAS_PC; }
  else if (context === 'analistas') { list = rotinasAnalistas; coll = COLL_ROTINAS_ANALISTAS; }
  else if (context === 'inventario') { list = rotinasInventario; coll = COLL_ROTINAS_INVENTARIO; }
  else { list = rotinasDevolucao; coll = COLL_ROTINAS_DEVOLUCAO; }

  ensureOrderIndex(list);
  await saveToFirebase(coll, { rotinas: list, lastUpdate: new Date(), lastDateIso: TODAY_ISO, lastDate: TODAY_STR });
}

// Salva somente o hist√≥rico vis√≠vel
async function saveVisibleHistory() {
  if (!isFirebaseConnected) throw new Error('Firebase offline (bloqueado)');
  await saveToFirebase(COLL_HISTORY, { history: visibleHistory, lastUpdate: new Date() });
}

// Salva somente configura√ß√£o (analistas/motivos)
async function saveConfigOnly() {
  if (!isFirebaseConnected) throw new Error('Firebase offline (bloqueado)');
  await saveToFirebase(COLL_CONFIG, { analistas, motivos, lastUpdate: new Date() });
}


// garante acesso global (evita problemas de escopo)
window.saveRecurringOnly = saveRecurringOnly;

function normalizeEmail(email) { return String(email || '').trim().toLowerCase(); }

function rebuildUsersMap() {
  usersMap = {};
  usersList.forEach(u => {
    const e = normalizeEmail(u.email);
    if (!e) return;
    usersMap[e] = { email: e, name: String(u.name || '').trim() || e, password: String(u.password || '') };
  });
}

/* ===========================
   HISTORY / ARCHIVE
=========================== */
function localIsoDate(d = new Date()) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function toJsDateMaybe(ts) {
  if (!ts) return null;
  if (ts instanceof Date) return ts;
  if (typeof ts === 'object' && typeof ts.toDate === 'function') return ts.toDate();
  const d = new Date(ts);
  return isNaN(d.getTime()) ? null : d;
}

function safeTime(ts) {
  const d = toJsDateMaybe(ts);
  return d ? d.getTime() : 0;
}

function rebuildEffectiveHistory() {
  if (currentUserRole === 'master') {
    const map = new Map();
    (Array.isArray(archiveHistory) ? archiveHistory : []).forEach(h => {
      if (h && typeof h.id !== 'undefined') map.set(String(h.id), h);
    });
    (Array.isArray(visibleHistory) ? visibleHistory : []).forEach(h => {
      if (h && typeof h.id !== 'undefined') map.set(String(h.id), h);
    });

    history = Array.from(map.values()).sort((a,b) => safeTime(b.timestamp) - safeTime(a.timestamp));
  } else {
    history = Array.isArray(visibleHistory) ? visibleHistory.slice() : [];
  }
}

function addVisibleIntoArchiveMemoryIfMissing() {
  if (currentUserRole !== 'master') return;

  const ids = new Set((archiveHistory || []).map(h => String(h?.id)));
  (visibleHistory || []).forEach(h => {
    const id = String(h?.id);
    if (!id || ids.has(id)) return;
    archiveHistory.unshift(h);
    ids.add(id);
  });

  archiveHistory.sort((a,b) => safeTime(b.timestamp) - safeTime(a.timestamp));
}

function matchTypeForPurge(entry, purgeType) {
  const t = entry?.type;
  if (purgeType === 'pc') return (!t || t === 'pc');
  if (purgeType === 'analistas') return (t === 'analistas');
  if (purgeType === 'inventario') return (t === 'inventario');
  if (purgeType === 'devolucao') return (t === 'devolucao');
  return false;
}

async function archiveHistoryEntry(entry) {
  if (!isFirebaseConnected) throw new Error('Firebase offline (bloqueado)');
  if (!entry || typeof entry !== 'object') return;

  const dateIso = entry.dateIso || localIsoDate(new Date());
  const docRef = db.collection(COLL_HISTORY_ARCHIVE).doc(dateIso);

  await db.runTransaction(async (tx) => {
    const doc = await tx.get(docRef);
    const data = doc.exists ? doc.data() : null;
    let arr = (data && Array.isArray(data.history)) ? data.history.slice() : [];

    const idStr = String(entry.id);
    const exists = arr.some(x => String(x?.id) === idStr);
    if (!exists) arr.unshift(entry);

    if (arr.length > 800) arr = arr.slice(0, 800);

    tx.set(docRef, { dateIso, history: arr, lastUpdate: new Date() }, { merge: true });
  });
}

async function loadArchiveHistoryForYear(year) {
  if (!isFirebaseConnected) throw new Error('Firebase offline (bloqueado)');

  const y = Number(year || (new Date()).getFullYear());
  const start = `${y}-01-01`;
  const end = `${y}-12-31`;

  const qs = await db.collection(COLL_HISTORY_ARCHIVE)
    .where(firebase.firestore.FieldPath.documentId(), '>=', start)
    .where(firebase.firestore.FieldPath.documentId(), '<=', end)
    .get();

  let arr = [];
  qs.forEach((doc) => {
    const data = doc.data();
    if (data && Array.isArray(data.history)) arr = arr.concat(data.history);
  });

  arr.sort((a,b) => safeTime(b.timestamp) - safeTime(a.timestamp));
  return arr;
}

/**
 * MASTER: purge permanente do arquivo anual (TODOS os anos) por aba.
 * - Ajuste importante: se o documento ficar vazio, deleta o documento inteiro (batch.delete),
 *   para evitar "restos" e garantir que some pro MASTER.
 */
async function purgeArchiveAllYearsByType(purgeType) {
  if (!isFirebaseConnected) throw new Error('Firebase offline (bloqueado)');
  if (currentUserRole !== 'master') throw new Error('Acesso negado');

  const snap = await db.collection(COLL_HISTORY_ARCHIVE).get();

  let batch = db.batch();
  let ops = 0;
  let docsTouched = 0;

  for (const doc of snap.docs) {
    const data = doc.data() || {};
    const arr = Array.isArray(data.history) ? data.history : [];
    const filtered = arr.filter(x => !matchTypeForPurge(x, purgeType));

    if (filtered.length !== arr.length) {
      docsTouched++;

      if (filtered.length === 0) {
        batch.delete(doc.ref);
      } else {
        batch.set(doc.ref, { history: filtered, lastUpdate: new Date() }, { merge: true });
      }

      ops++;
      if (ops >= 450) {
        await batch.commit();
        batch = db.batch();
        ops = 0;
      }
    }
  }

  if (ops > 0) await batch.commit();
  return docsTouched;
}

/* ===========================
   PERMISSIONS / USERS
=========================== */
async function loadPermissions() {
  if (permissionsLoaded) return;
  const p = await loadFromFirebase(COLL_PERMISSIONS);
  if (p && Array.isArray(p.adminEmails)) {
    adminEmails = p.adminEmails.map(normalizeEmail).filter(Boolean).filter(e => e !== MASTER_EMAIL);
  } else {
    await saveToFirebase(COLL_PERMISSIONS, { adminEmails: adminEmails.slice(), lastUpdate: new Date() });
  }
  permissionsLoaded = true;
}

async function savePermissions() {
  if (currentUserRole !== 'master') return;
  adminEmails = Array.from(new Set(adminEmails.map(normalizeEmail).filter(Boolean))).filter(e => e !== MASTER_EMAIL);
  await saveToFirebase(COLL_PERMISSIONS, { adminEmails: adminEmails.slice(), lastUpdate: new Date() });
}

async function loadUsers() {
  // Sempre for√ßa reload ao logar para ter certeza das senhas novas
  const u = await loadFromFirebase(COLL_USERS);
  if (u && Array.isArray(u.users)) {
    usersList = u.users.map(x => ({
      email: normalizeEmail(x.email),
      name: String(x.name || '').trim(),
      password: String(x.password || '')
    })).filter(x => x.email);
  } else {
    usersList = usersList.map(x => ({ email: normalizeEmail(x.email), name: x.name, password: x.password })).filter(x => x.email);
    await saveToFirebase(COLL_USERS, { users: usersList.slice(), lastUpdate: new Date() });
  }
  rebuildUsersMap();
  usersLoaded = true;
}

async function saveUsers() {
  // Nota: qualquer um pode chamar saveToFirebase se tiver conectado, 
  // mas nossa logica de UI protege. No backend real precisaria de Rules.
  // Aqui estamos permitindo que o usuario "troque" salvando a lista toda.
  
  const masterExists = usersList.some(u => normalizeEmail(u.email) === MASTER_EMAIL);
  if (!masterExists) usersList.push({ email: MASTER_EMAIL, name: 'Diego Cordeiro', password: usersMap[MASTER_EMAIL]?.password || '' });

  const seen = new Set();
  const cleaned = [];
  for (const u of usersList) {
    const e = normalizeEmail(u.email);
    if (!e || seen.has(e)) continue;
    seen.add(e);
    cleaned.push({ email: e, name: String(u.name || '').trim() || e, password: String(u.password || '') });
  }
  usersList = cleaned;
  rebuildUsersMap();

  await saveToFirebase(COLL_USERS, { users: usersList.slice(), lastUpdate: new Date() });
}

/* ===========================
   FUNC√ïES UI DE LOGIN
=========================== */
document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); loginUser(); });

function resolveRoleForEmail(email) {
  const e = normalizeEmail(email);
  if (e === MASTER_EMAIL) return 'master';
  if (adminEmails.includes(e)) return 'admin';
  return 'user';
}
function displayRoleForRole(role) {
  if (role === 'master') return 'MASTER';
  if (role === 'admin') return 'ADMIN';
  return 'USER';
}

// Navega√ß√£o entre formul√°rios
function showChangePasswordUI() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('changePassForm').style.display = 'block';
  document.getElementById('forgotPassForm').style.display = 'none';
  
  document.getElementById('cpEmail').value = '';
  document.getElementById('cpOldPass').value = '';
  document.getElementById('cpNewPass').value = '';
}

function hideChangePasswordUI() {
  document.getElementById('changePassForm').style.display = 'none';
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('forgotPassForm').style.display = 'none';
}

function showForgotPasswordUI() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('changePassForm').style.display = 'none';
  document.getElementById('forgotPassForm').style.display = 'block';
  
  document.getElementById('fpEmail').value = '';
}

function hideForgotPasswordUI() {
  document.getElementById('forgotPassForm').style.display = 'none';
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('changePassForm').style.display = 'none';
}

/* ===========================
   GERADOR DE SENHA ALEAT√ìRIA
=========================== */
function generateRandomPassword(length = 8) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

/* ===========================
   RECUPERA√á√ÉO DE SENHA POR EMAIL - VERS√ÉO FINAL
=========================== */
async function tryForgotPassword() {
  if (!isFirebaseConnected) { 
    showToast('Sistema offline. N√£o √© poss√≠vel recuperar senha.', 'error'); 
    return; 
  }

  const email = normalizeEmail(document.getElementById('fpEmail').value);
  
  if (!email || !email.includes('@')) { 
    showToast('Informe um e-mail v√°lido', 'warning'); 
    return; 
  }

  const btn = document.getElementById('forgotPassBtn');
  const loading = document.getElementById('loginLoading');
  
  // Desabilita bot√£o e mostra loading
  btn.disabled = true;
  btn.textContent = 'üìß ENVIANDO...';
  
  document.getElementById('forgotPassForm').style.display = 'none';
  loading.style.display = 'block';
  document.querySelector('#loginLoading p').textContent = "Verificando usu√°rio e enviando e-mail...";

  try {
    // 1. Carrega usu√°rios mais recentes do banco
    await loadUsers(); 

    // 2. Verifica se o usu√°rio existe
    const user = usersMap[email];
    if (!user) { 
      throw new Error('E-mail n√£o encontrado no sistema.'); 
    }

    // 3. Gera nova senha aleat√≥ria
    const newPassword = generateRandomPassword(8);
    
    // 4. Atualiza a senha na lista local
    usersList = usersList.map(u => 
      normalizeEmail(u.email) === email ? { ...u, password: newPassword } : u
    );
    rebuildUsersMap();

    // 5. Salva no Firebase
    await saveUsers();
    
    // 6. ENVIA EMAIL COM TODOS OS CAMPOS POSS√çVEIS (estrat√©gia "shotgun")
    const templateParams = {
      // Baseado na sua mensagem original
      to_name: user.name,
      new_password: newPassword,
      
      // Varia√ß√µes do nome
      user_name: user.name,
      nome: user.name,
      name: user.name,
      recipient_name: user.name,
      
      // Varia√ß√µes do email
      to_email: email,
      user_email: email,
      email: email,
      recipient_email: email,
      
      // Varia√ß√µes da senha
      password: newPassword,
      senha: newPassword,
      nova_senha: newPassword,
      password_new: newPassword,
      temp_password: newPassword,
      
      // Varia√ß√µes do remetente
      from_name: 'Diego M Cordeiro',
      sender: 'Diego M Cordeiro',
      remetente: 'Diego M Cordeiro',
      sender_name: 'Diego M Cordeiro',
      
      // Campos extras
      reply_to: 'diego.cordeiro@minervafoods.com',
      company: 'Minerva Foods',
      system_name: 'Sistema de Rotinas'
    };

    // 7. Envia o e-mail
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
    
    // 8. Log de governan√ßa
    if (governanceLog) {
      governanceLog.unshift({
        id: Date.now(),
        userId: 'SYSTEM',
        userName: 'Sistema',
        userRole: 'SYSTEM',
  viewId: currentView || null,
    viewLabel: getViewLabel(currentView),
        action: 'PASSWORD_RECOVERY',
        details: `Senha recuperada por e-mail para: ${email}`,
        target: email,
        timestamp: new Date(),
        date: TODAY_STR
      });
      if (governanceLog.length > 50) governanceLog = governanceLog.slice(0, 50);
      await saveToFirebase(COLL_GOV, { log: governanceLog, lastUpdate: new Date() });
    }

    showToast('Nova senha enviada por e-mail! Verifique sua caixa de entrada.', 'success');
    hideForgotPasswordUI();

  } catch (err) {
    console.error('Erro na recupera√ß√£o de senha:', err);
    
    let errorMessage = 'Erro ao recuperar senha. Tente novamente.';
    
    if (err.message && err.message.includes('n√£o encontrado')) {
      errorMessage = 'E-mail n√£o encontrado no sistema.';
    } else if (err.status === 422) {
      errorMessage = 'Erro nos campos do template. Verifique a configura√ß√£o no EmailJS.';
    } else if (err.message && (err.message.includes('EmailJS') || err.message.includes('Failed to send') || err.message.includes('network'))) {
      errorMessage = 'Erro ao enviar e-mail. Verifique sua conex√£o.';
    }
    
    showToast(errorMessage, 'error');
    document.getElementById('forgotPassForm').style.display = 'block';
  } finally {
    // Restaura estados
    loading.style.display = 'none';
    document.querySelector('#loginLoading p').textContent = "Conectando...";
    btn.disabled = false;
    btn.textContent = 'üìß ENVIAR NOVA SENHA';
  }
}

async function tryChangePassword() {
  if (!isFirebaseConnected) { showToast('Offline. N√£o √© poss√≠vel alterar senha.', 'error'); return; }

  const email = normalizeEmail(document.getElementById('cpEmail').value);
  const oldPass = document.getElementById('cpOldPass').value;
  const newPass = document.getElementById('cpNewPass').value;

  if (!email || !oldPass || !newPass) { showToast('Preencha todos os campos', 'warning'); return; }
  if (newPass.length < 4) { showToast('Nova senha deve ter no m√≠nimo 4 caracteres', 'warning'); return; }

  const loading = document.getElementById('loginLoading');
  document.getElementById('changePassForm').style.display = 'none';
  loading.style.display = 'block';
  document.querySelector('#loginLoading p').textContent = "Verificando e salvando...";

  try {
    // 1. Carrega usu√°rios mais recentes do banco
    await loadUsers(); 

    // 2. Verifica credenciais
    const user = usersMap[email];
    if (!user) { throw new Error('Usu√°rio n√£o encontrado.'); }
    if (user.password !== oldPass) { throw new Error('Senha ATUAL incorreta.'); }

    // 3. Atualiza senha na lista local
    usersList = usersList.map(u => normalizeEmail(u.email) === email ? { ...u, password: newPass } : u);
    rebuildUsersMap();

    // 4. Salva no Firebase
    await saveUsers();
    
    // 5. Log de governan√ßa (opcional, mas bom pra seguran√ßa)
    if (governanceLog) {
      governanceLog.unshift({
        id: Date.now(),
        userId: email,
        userName: user.name,
        userRole: 'SELF',
        action: 'CHANGE_OWN_PASSWORD',
        details: 'Usu√°rio alterou a pr√≥pria senha via tela de login',
        target: email,
        timestamp: new Date(),
        date: TODAY_STR
      });
      if (governanceLog.length > 50) governanceLog = governanceLog.slice(0, 50);
      await saveToFirebase(COLL_GOV, { log: governanceLog, lastUpdate: new Date() });
    }

    showToast('Senha alterada com sucesso! Fa√ßa login.', 'success');
    hideChangePasswordUI();

  } catch (err) {
    console.error(err);
    showToast(err.message || 'Erro ao alterar senha', 'error');
    document.getElementById('changePassForm').style.display = 'block';
  } finally {
    loading.style.display = 'none';
    document.querySelector('#loginLoading p').textContent = "Conectando...";
  }
}

async function loginUser() {
  if (!isFirebaseConnected) {
    showToast('Firebase offline. Acesso bloqueado.', 'error');
    enforceOnlineOnlyUI();
    return;
  }

  const email = normalizeEmail(document.getElementById('loginEmail').value);
  const password = String(document.getElementById('loginPassword').value || '');

  if (!email || !password) { showToast('Preencha email e senha', 'error'); return; }

  const loginBtn = document.getElementById('loginBtn');
  const loading = document.getElementById('loginLoading');

  loginBtn.disabled = true;
  loading.style.display = 'block';

  try {
    await loadPermissions();
    await loadUsers(); // Garante que pegou a senha mais nova do banco

    const user = usersMap[email];
    if (!user || user.password !== password) {
      showToast('Email ou senha incorretos!', 'error');
      loginBtn.disabled = false;
      loading.style.display = 'none';
      return;
    }

    const role = resolveRoleForEmail(email);

    currentUser = { email, name: user.name, displayRole: displayRoleForRole(role), isMaster: (email === MASTER_EMAIL) };
    currentUserRole = role;

    // SESSION STORAGE = APENAS NESTA ABA/SESS√ÉO
    sessionStorage.setItem('minerva_session_email', email);

    setupUserInterface();
    initializeApp();
  } catch(e) {
    console.error(e);
    showToast('Erro ao realizar login', 'error');
  } finally {
    loginBtn.disabled = false;
    loading.style.display = 'none';
  }
}

function setupUserInterface() {
  document.getElementById('loginOverlay').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';

  let bodyClass = 'user-user';
  if (currentUserRole === 'admin') bodyClass = 'user-admin';
  if (currentUserRole === 'master') bodyClass = 'user-master user-admin';
  document.body.className = bodyClass;

  document.getElementById('userDisplayName').textContent = currentUser.name;
  const roleElement = document.getElementById('userRole');
  roleElement.textContent = currentUser.displayRole;
  if (currentUser.isMaster) roleElement.classList.add('master');

  showToast(`Bem-vindo, ${currentUser.name}!`, 'success');
}

function logoutUser() {
  destroyRealtimeListeners();

  stopRecurringMonitor();

  // REMOVE SESS√ÉO
  sessionStorage.removeItem('minerva_session_email');

  document.getElementById('loginOverlay').style.display = 'flex';
  document.getElementById('mainApp').style.display = 'none';

  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
  
  // Garante que volta pro form de login, n√£o o de senha
  hideForgotPasswordUI();
  hideChangePasswordUI();

  // Restaura UI de login caso tenha vindo de auto-login
  document.getElementById('loginLoading').style.display = 'none';
  
  currentUser = null;
  currentUserRole = 'user';

  showToast('Logout realizado com sucesso', 'success');
}

/* ===========================
   REALTIME LISTENERS
=========================== */
function setupRealtimeListeners() {
  if (!isFirebaseConnected || !currentUser) return;

  realTimeListeners.rotinasPC = db.collection(COLL_ROTINAS_PC).doc('data').onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();
      rotinasPC = data.rotinas || [];
      ensureOrderIndex(rotinasPC);
      if (currentView === 'pc') render();
      if (currentView === 'mobile') renderMobileDashboard();
      updateHeaderProgress();
    }
  });

  realTimeListeners.rotinasAnalistas = db.collection(COLL_ROTINAS_ANALISTAS).doc('data').onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();
      rotinasAnalistas = data.rotinas || [];
      ensureOrderIndex(rotinasAnalistas);
      if (currentView === 'analistas') render();
      if (currentView === 'mobile') renderMobileDashboard();
      updateHeaderProgress();
    }
  });

  realTimeListeners.rotinasInventario = db.collection(COLL_ROTINAS_INVENTARIO).doc('data').onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();
      rotinasInventario = data.rotinas || [];
      ensureOrderIndex(rotinasInventario);
      if (currentView === 'inventario') render();
      if (currentView === 'mobile') renderMobileDashboard();
      updateHeaderProgress();
    }
  });

  // NOVO LISTENER: DEVOLU√á√ÉO
  realTimeListeners.rotinasDevolucao = db.collection(COLL_ROTINAS_DEVOLUCAO).doc('data').onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();
      rotinasDevolucao = data.rotinas || [];
      ensureOrderIndex(rotinasDevolucao);
      if (currentView === 'devolucao') render();
      if (currentView === 'mobile') renderMobileDashboard();
      updateHeaderProgress();
    }
  });

  realTimeListeners.history = db.collection(COLL_HISTORY).doc('data').onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();
      visibleHistory = data.history || [];

      if (currentUserRole === 'master') {
        addVisibleIntoArchiveMemoryIfMissing();
        rebuildEffectiveHistory();
      } else {
        rebuildEffectiveHistory();
      }

      if (currentView !== 'governance' && currentView !== 'mobile' && currentView !== 'kpi') renderHistory();
      updateCharts();
      if (currentView === 'mobile') renderMobileDashboard(); // Update counts / lista
      updateHeaderProgress();
    }
  });

  realTimeListeners.config = db.collection(COLL_CONFIG).doc('data').onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();
      analistas = data.analistas || [...DEFAULT_ANALISTAS];
      motivos = data.motivos || [...DEFAULT_MOTIVOS];
      populateAnalystFilter();
    }
  });

  realTimeListeners.recurring = db.collection(COLL_RECURRING).doc('data').onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();
      recurringRoutines = Array.isArray(data.items) ? data.items : [];
      if (currentView !== 'kpi' && currentView !== 'governance') render();
      if (currentView === 'mobile') renderMobileDashboard();
    }
  });


  if (currentUserRole === 'master') {
    realTimeListeners.governance = db.collection(COLL_GOV).doc('data').onSnapshot((doc) => {
      if (doc.exists) {
        const data = doc.data();
        governanceLog = data.log || [];
        if (currentView === 'governance') renderGovernanceLog();
      }
    });
  }

  setupOnlineTraking();
}

function setupOnlineTraking() {
  if (!isFirebaseConnected || !currentUser) return;

  const userRef = db.collection('users_online').doc(currentUser.email.replace(/[.#$[\]]/g, '_'));

  const setUserOnline = () => {
    userRef.set({
      name: currentUser.name,
      role: currentUser.displayRole,
      email: currentUser.email,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
      isOnline: true
    });
  };

  const setUserOffline = () => {
    userRef.update({
      isOnline: false,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp()
    });
  };

  setUserOnline();
  setInterval(setUserOnline, 30000);
  window.addEventListener('beforeunload', setUserOffline);

  realTimeListeners.usersOnline = db.collection('users_online').where('isOnline', '==', true)
    .onSnapshot((snapshot) => {
      onlineUsers = snapshot.size;
      document.getElementById('onlineCount').textContent = `${onlineUsers} online`;
    });
}

function destroyRealtimeListeners() {
  Object.values(realTimeListeners).forEach(unsubscribe => {
    if (typeof unsubscribe === 'function') unsubscribe();
  });
  realTimeListeners = {};

  if (isFirebaseConnected && currentUser) {
    const userRef = db.collection('users_online').doc(currentUser.email.replace(/[.#$[\]]/g, '_'));
    userRef.update({
      isOnline: false,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
}

/* ===========================
   INIT / LOAD DATA
=========================== */


/* ===========================
   AUTO-CLOSE (N√ÉO EXECUTADAS)
   - Executa quando algu√©m abre o painel (e pode ser chamado em a√ß√µes)
   - Fecha TODOS os dias pendentes desde o √∫ltimo fechamento registrado
   - Gera registros no HISTORY para rotinas N√ÉO INICIADAS
   - Abas: pc / analistas / devolucao

   OBS: como roda no front-end, ele usa o estado atual das rotinas.
=========================== */
let autoCloseCheckedOnce = false;
let autoCloseInProgress = false;

function isoToPtbr(dateIso){
  const s = String(dateIso || '');
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return new Date().toLocaleDateString('pt-BR');
  return `${m[3]}/${m[2]}/${m[1]}`;
}

function addDaysIso(dateIso, deltaDays){
  const s = String(dateIso || localIsoDate(new Date()));
  const d = new Date(s + 'T00:00:00');
  d.setDate(d.getDate() + (parseInt(deltaDays,10) || 0));
  return localIsoDate(d);
}

function isNotStartedTask(task){
  const st = String(task?.status || 'pending');
  if (st === 'pending') return true;
  if (!task?.inicioTs && (st !== 'in_progress' && st !== 'done' && st !== 'partial')) return true;
  return false;
}

async function appendVisibleHistoryEntries(entries){
  if (!entries || !entries.length) return;
  if (!isFirebaseConnected) throw new Error('Firebase offline (bloqueado)');

  const docRef = db.collection(COLL_HISTORY).doc('data');
  let updated = null;

  await db.runTransaction(async (tx) => {
    const doc = await tx.get(docRef);
    const data = doc.exists ? (doc.data() || {}) : {};
    let arr = Array.isArray(data.history) ? data.history.slice() : [];

    const ids = new Set(arr.map(x => String(x?.id)));
    for (const e of entries){
      const id = String(e?.id);
      if (!id || ids.has(id)) continue;
      arr.unshift(e);
      ids.add(id);
    }

    if (arr.length > 800) arr = arr.slice(0, 800);
    updated = arr;

    tx.set(docRef, { history: arr, lastUpdate: new Date() }, { merge: true });
  });

  if (updated) visibleHistory = updated;
  rebuildEffectiveHistory();
}

async function generateNotExecutedForDate(dateIso){
  const dateStr = isoToPtbr(dateIso);
  const ts = new Date(dateIso + 'T23:59:59');

  const tasksByCtx = [
    { ctx: 'pc', list: rotinasPC },
    { ctx: 'analistas', list: rotinasAnalistas },
    { ctx: 'devolucao', list: rotinasDevolucao }
  ];

  const newEntries = [];

  for (const {ctx, list} of tasksByCtx){
    const arr = Array.isArray(list) ? list : [];
    for (let i=0; i<arr.length; i++){
      const task = arr[i];
      if (!task) continue;
      if (!isNotStartedTask(task)) continue;

      const key = String(task.id || task.nome || ('IDX_'+i)).replace(/\s+/g,'_');
      const entryId = `AUTO__${dateIso}__${ctx}__${key}`;

      newEntries.push({
        id: entryId,
        type: ctx,
        data: dateStr,
        dateIso: dateIso,
        rotina: String(task.nome || task.rotina || 'ROTINA').trim(),
        analista: String(task.analista || '-'),
        motivo: 'N√ÉO INICIADA',
        inicio: '-',
        fim: '-',
        duracao: '-',
        durationSec: 0,
        percent: '-',
        status: 'N√£o executada',
        prioridade: task.prioridade || '-',
        timestamp: ts
      });
    }
  }

  if (!newEntries.length) return 0;

  // grava no arquivo e no archive di√°rio
  await appendVisibleHistoryEntries(newEntries);
  for (const e of newEntries){
    await archiveHistoryEntry(e);
    if (currentUserRole === 'master') archiveHistory.unshift(e);
  }
  if (currentUserRole === 'master') {
    archiveHistory.sort((a,b) => safeTime(b.timestamp) - safeTime(a.timestamp));
  }

  return newEntries.length;
}

async function autoClosePendingDays(trigger='init'){
  if (autoCloseInProgress) return;

  // evita rodar o tempo todo; pode chamar em a√ß√µes, mas s√≥ roda uma vez por sess√£o
  if (autoCloseCheckedOnce && trigger === 'action') return;

  autoCloseInProgress = true;
  try{
    if (!isFirebaseConnected) return;

    const todayIso = localIsoDate(new Date());
    const yesterdayIso = addDaysIso(todayIso, -1);

    // Se n√£o existe "ontem" v√°lido (ex.: datas quebradas), sai
    if (!yesterdayIso || yesterdayIso >= todayIso) return;

    const cfgRef = db.collection(COLL_CONFIG).doc('data');
    const cfgSnap = await cfgRef.get();
    const cfg = cfgSnap.exists ? (cfgSnap.data() || {}) : {};

    let lastClosed = String(cfg.lastAutoCloseDateIso || '');
    if (!/^\d{4}-\d{2}-\d{2}$/.test(lastClosed)) lastClosed = '';

    let startIso = lastClosed ? addDaysIso(lastClosed, 1) : yesterdayIso;

    // nada a fazer
    if (startIso > yesterdayIso) {
      autoCloseCheckedOnce = true;
      return;
    }

    // fecha todos os dias pendentes
    let cursor = new Date(startIso + 'T00:00:00');
    const end = new Date(yesterdayIso + 'T00:00:00');

    while (cursor <= end){
      const dIso = localIsoDate(cursor);
      const count = await generateNotExecutedForDate(dIso);

      await cfgRef.set({
        lastAutoCloseDateIso: dIso,
        lastAutoCloseAt: new Date(),
        lastAutoCloseBy: currentUser?.email || null,
        lastAutoCloseCount: count
      }, { merge: true });

      cursor.setDate(cursor.getDate() + 1);
    }

    autoCloseCheckedOnce = true;
  } catch(e){
    console.error('autoClosePendingDays falhou:', e);
  } finally {
    autoCloseInProgress = false;
  }
}
async function initializeApp() {
  try {
    await loadData();
    setupKpiFilters();
    setupRealtimeListeners();
    await autoClosePendingDays('init');
    render();
    updateCharts();
    if (currentUserRole === 'master') renderGovernanceLog();

    startRecurringMonitor();

    // AUTO-ABRIR MOBILE: somente em celular/tablet e somente ADMIN/MASTER
    if (isProbablyMobile() && isPrivileged()) {
      openTab('mobile');
    } else {
      updateHeaderProgress();
    }
  } catch (error) {
    console.error('Falha na inicializa√ß√£o (online-only):', error);
    showToast('Falha ao carregar dados do Firebase. Acesso bloqueado.', 'error');
    logoutUser();
    enforceOnlineOnlyUI();
  }
}

async function loadData() {
  await loadPermissions();
  await loadUsers();

  const savedPC = await loadFromFirebase(COLL_ROTINAS_PC);
  if (savedPC && savedPC.rotinas) {
    rotinasPC = savedPC.rotinas;
  } else {
    rotinasPC = DEFAULT_ROTINAS_PC.map((nome, i) => ({
      id: 'pc_' + i,
      nome,
      status: 'pending',
      prioridade: i < 5 ? 'alta' : (i < 10 ? 'media' : 'baixa'),
      orderIndex: i
    }));
    applyDefaultPrioritiesAndOrder('pc');
    await saveToFirebase(COLL_ROTINAS_PC, { rotinas: rotinasPC, lastUpdate: new Date(), lastDateIso: TODAY_ISO, lastDate: TODAY_STR });
  }

  const savedAnalistas = await loadFromFirebase(COLL_ROTINAS_ANALISTAS);
  if (savedAnalistas && savedAnalistas.rotinas) {
    rotinasAnalistas = savedAnalistas.rotinas;
  } else {
    rotinasAnalistas = DEFAULT_ROTINAS_ANALISTAS.map((nome, i) => ({
      id: 'an_' + i,
      nome,
      status: 'pending',
      prioridade: 'alta',
      orderIndex: i
    }));
    applyDefaultPrioritiesAndOrder('analistas');
    await saveToFirebase(COLL_ROTINAS_ANALISTAS, { rotinas: rotinasAnalistas, lastUpdate: new Date(), lastDateIso: TODAY_ISO, lastDate: TODAY_STR });
  }

  // CARREGAR INVENT√ÅRIO
  const savedInventario = await loadFromFirebase(COLL_ROTINAS_INVENTARIO);
  if (savedInventario && savedInventario.rotinas) {
    rotinasInventario = savedInventario.rotinas;
  } else {
    rotinasInventario = DEFAULT_ROTINAS_INVENTARIO.map((nome, i) => ({
      id: 'inv_' + i,
      nome,
      status: 'pending',
      prioridade: 'alta',
      orderIndex: i
    }));
    applyDefaultPrioritiesAndOrder('inventario');
    await saveToFirebase(COLL_ROTINAS_INVENTARIO, { rotinas: rotinasInventario, lastUpdate: new Date(), lastDateIso: TODAY_ISO, lastDate: TODAY_STR });
  }

  // CARREGAR DEVOLU√á√ÉO
  const savedDevolucao = await loadFromFirebase(COLL_ROTINAS_DEVOLUCAO);
  if (savedDevolucao && savedDevolucao.rotinas) {
    rotinasDevolucao = savedDevolucao.rotinas;
  } else {
    rotinasDevolucao = DEFAULT_ROTINAS_DEVOLUCAO.map((nome, i) => ({
      id: 'dev_' + i,
      nome,
      status: 'pending',
      prioridade: 'alta',
      orderIndex: i
    }));
    applyDefaultPrioritiesAndOrder('devolucao');
    await saveToFirebase(COLL_ROTINAS_DEVOLUCAO, { rotinas: rotinasDevolucao, lastUpdate: new Date(), lastDateIso: TODAY_ISO, lastDate: TODAY_STR });
  }

  ensureOrderIndex(rotinasPC);
  ensureOrderIndex(rotinasAnalistas);
  ensureOrderIndex(rotinasInventario);
  ensureOrderIndex(rotinasDevolucao);

  const savedHistory = await loadFromFirebase(COLL_HISTORY);
  visibleHistory = savedHistory ? (savedHistory.history || []) : [];

  if (currentUserRole === 'master') {
    const year = (new Date()).getFullYear();
    archiveHistory = await loadArchiveHistoryForYear(year);
    addVisibleIntoArchiveMemoryIfMissing();
  } else {
    archiveHistory = [];
  }

  rebuildEffectiveHistory();

  const savedConfig = await loadFromFirebase(COLL_CONFIG);
  if (savedConfig) {
    analistas = savedConfig.analistas || [...DEFAULT_ANALISTAS];
    motivos = savedConfig.motivos || [...DEFAULT_MOTIVOS];
  } else {
    await saveToFirebase(COLL_CONFIG, { analistas, motivos, lastUpdate: new Date() });
  }

  const savedGov = await loadFromFirebase(COLL_GOV);
  governanceLog = savedGov ? (savedGov.log || []) : [];

  // CARREGAR ROTINAS RECORRENTES
  const savedRecurring = await loadFromFirebase(COLL_RECURRING);
  if (savedRecurring && Array.isArray(savedRecurring.items)) {
    recurringRoutines = savedRecurring.items;
  } else {
    recurringRoutines = [];
    await saveToFirebase(COLL_RECURRING, { items: recurringRoutines, lastUpdate: new Date() });
  }

  const savedLastIso = savedPC?.lastDateIso;
  const savedLastStr = savedPC?.lastDate;

  if (savedLastIso) {
    if (savedLastIso !== TODAY_ISO) {
      await resetDailyData();
    }
  } else if (savedLastStr) {
    // compat com vers√µes antigas
    if (savedLastStr !== TODAY_STR) {
      await resetDailyData();
    } else {
      // mesmo dia, s√≥ faltava o ISO
      await saveToFirebase(COLL_ROTINAS_PC, { rotinas: rotinasPC, lastDateIso: TODAY_ISO, lastDateIso: TODAY_ISO, lastDate: TODAY_STR, lastUpdate: new Date() });
    }
  } else {
    // sem lastDate salvo: n√£o reseta, apenas grava o lastDate de hoje
    await saveToFirebase(COLL_ROTINAS_PC, { rotinas: rotinasPC, lastDateIso: TODAY_ISO, lastDateIso: TODAY_ISO, lastDate: TODAY_STR, lastUpdate: new Date() });
  }
}

async function resetDailyData() {
  rotinasPC.forEach(resetRoutineFields);
  rotinasAnalistas.forEach(resetRoutineFields);
  rotinasInventario.forEach(resetRoutineFields);
  rotinasDevolucao.forEach(resetRoutineFields);

  applyDefaultPrioritiesAndOrder('pc');
  applyDefaultPrioritiesAndOrder('analistas');
  applyDefaultPrioritiesAndOrder('inventario');
  applyDefaultPrioritiesAndOrder('devolucao');

  await saveToFirebase(COLL_ROTINAS_PC, { rotinas: rotinasPC, lastDateIso: TODAY_ISO, lastDate: TODAY_STR, lastUpdate: new Date() });
  await saveToFirebase(COLL_ROTINAS_ANALISTAS, { rotinas: rotinasAnalistas, lastDateIso: TODAY_ISO, lastDate: TODAY_STR, lastUpdate: new Date() });
  await saveToFirebase(COLL_ROTINAS_INVENTARIO, { rotinas: rotinasInventario, lastDateIso: TODAY_ISO, lastDate: TODAY_STR, lastUpdate: new Date() });
  await saveToFirebase(COLL_ROTINAS_DEVOLUCAO, { rotinas: rotinasDevolucao, lastDateIso: TODAY_ISO, lastDate: TODAY_STR, lastUpdate: new Date() });
}

async function saveData() {
  await Promise.all([
    saveToFirebase(COLL_ROTINAS_PC, { rotinas: rotinasPC, lastDateIso: TODAY_ISO, lastDate: TODAY_STR, lastUpdate: new Date() }),
    saveToFirebase(COLL_ROTINAS_ANALISTAS, { rotinas: rotinasAnalistas, lastDateIso: TODAY_ISO, lastDate: TODAY_STR, lastUpdate: new Date() }),
    saveToFirebase(COLL_ROTINAS_INVENTARIO, { rotinas: rotinasInventario, lastDateIso: TODAY_ISO, lastDate: TODAY_STR, lastUpdate: new Date() }),
    saveToFirebase(COLL_ROTINAS_DEVOLUCAO, { rotinas: rotinasDevolucao, lastDateIso: TODAY_ISO, lastDate: TODAY_STR, lastUpdate: new Date() }),
    saveToFirebase(COLL_HISTORY, { history: visibleHistory, lastUpdate: new Date() }),
    saveToFirebase(COLL_CONFIG, { analistas, motivos, lastUpdate: new Date() }),
    saveToFirebase(COLL_GOV, { log: governanceLog, lastUpdate: new Date() }),
    saveToFirebase(COLL_PERMISSIONS, { adminEmails: adminEmails.slice(), lastUpdate: new Date() }),
    ...(currentUserRole === 'master' ? [saveToFirebase(COLL_USERS, { users: usersList.slice(), lastUpdate: new Date() })] : [])
  ]);
}

/* ===========================
   GOVERNANCE
=========================== */
async function logGovernanceAction(action, details, target = null) {
  if (!isPrivileged()) return;

  governanceLog.unshift({
    id: Date.now(),
    userId: currentUser.email,
    userName: currentUser.name,
    userRole: currentUser.displayRole,
    action,
    details,
    target,
    timestamp: new Date(),
    date: TODAY_STR
  });

  if (governanceLog.length > 100) governanceLog = governanceLog.slice(0, 100);

  await saveToFirebase(COLL_GOV, { log: governanceLog, lastUpdate: new Date() });

  if (currentView === 'governance' && currentUserRole === 'master') renderGovernanceLog();
}

function renderGovernanceLog() {
  const el = document.getElementById('governanceLog');
  if (!el) return;

  if (!governanceLog.length) {
    el.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Nenhuma a√ß√£o registrada</div>';
    return;
  }

  el.innerHTML = governanceLog.map(log => {
    const dt = toJsDateMaybe(log.timestamp);
    const ts = dt ? dt.toLocaleString('pt-BR') : '-';
    const roleColor =
      log.userRole === 'MASTER' ? 'color:#FFD700; font-weight:700;' :
      log.userRole === 'ADMIN' ? 'color:#7A1417; font-weight:700;' : '';
    return `
      <div class="log-entry">
        <div>
          <div class="log-action">${escapeHtml(log.action || '')}</div>
          <div class="log-details">${escapeHtml(log.details || '')}</div>
          <div class="log-meta" style="margin-top:2px; color:#666; font-size:12px;">
            Aba: <strong>${escapeHtml(log.viewLabel || getViewLabel(log.viewId) || '-')}</strong>${log.target ? ` | Target: <strong>${escapeHtml(String(log.target))}</strong>` : ''}
          </div>
          <small style="color:#888;">Por: <span style="${roleColor}">${escapeHtml(log.userName||'')} (${escapeHtml(log.userRole||'')})</span></small>
        </div>
        <div class="log-timestamp">${escapeHtml(ts)}</div>
      </div>
    `;
  }).join('');
}

async function exportGovernanceToExcel() {
  if (currentUserRole !== 'master') { showToast('Acesso negado', 'error'); return; }
  if (!governanceLog.length) { showToast('Sem dados para exportar', 'warning'); return; }

  try {
    showToast('Exportando governan√ßa...', 'success');
    const wb = new ExcelJS.Workbook();
    wb.creator = 'Minerva Foods - Rotinas Estoque';
    wb.created = new Date();

    const ws = wb.addWorksheet('Governan√ßa');
    ws.columns = [
      { header: 'Data (PT-BR)', key: 'date', width: 14 },
      { header: 'Timestamp', key: 'timestamp', width: 22 },
      { header: 'Usu√°rio', key: 'userName', width: 22 },
      { header: 'E-mail', key: 'userId', width: 28 },
      { header: 'Role', key: 'userRole', width: 10 },
      { header: 'Aba', key: 'viewLabel', width: 20 },
      { header: 'ViewId', key: 'viewId', width: 12 },
      { header: 'A√ß√£o', key: 'action', width: 18 },
      { header: 'Detalhes', key: 'details', width: 45 },
      { header: 'Target', key: 'target', width: 14 },
    ];
    ws.getRow(1).fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FF7A1417' } };
    ws.getRow(1).font = { bold:true, color:{ argb:'FFFFFFFF' } };

    governanceLog.forEach((log) => {
      const dt = toJsDateMaybe(log.timestamp);
      ws.addRow({
        date: log.date || '',
        timestamp: dt ? dt.toLocaleString('pt-BR') : '',
        userName: log.userName || '',
        userId: log.userId || '',
        userRole: log.userRole || '',
        viewLabel: log.viewLabel || '',
        viewId: log.viewId || '',
        action: log.action || '',
        details: log.details || '',
        target: log.target || ''
      });
    });

    const buffer = await wb.xlsx.writeBuffer();
    saveAs(new Blob([buffer], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }),
      `Governanca_${TODAY_STR.replace(/\//g,'-')}.xlsx`);
  } catch (e) {
    console.error(e);
    showToast('Erro ao exportar governan√ßa', 'error');
  }
}

async function clearGovernanceLog() {
  if (currentUserRole !== 'master') { showToast('Acesso negado', 'error'); return; }
  if (!confirm('Limpar todo o log de governan√ßa?')) return;
  governanceLog = [];
  await logGovernanceAction('CLEAR_LOG', 'Log de governan√ßa limpo');
  renderGovernanceLog();
  showToast('Log de governan√ßa limpo', 'success');
}

/* ===========================
   ROTINAS
=========================== */
let currentContext = 'pc';
let currentEditId = null;

function lockKey(context, task, action) { return `${context}:${task?.id || ''}:${action}`; }
function moveTaskToEnd(list, index) { const t = list.splice(index, 1)[0]; list.push(t); }

async function startTask(context, index) {
  let list;
  if (context === 'pc') list = rotinasPC;
  else if (context === 'analistas') list = rotinasAnalistas;
  else if (context === 'inventario') list = rotinasInventario;
  else list = rotinasDevolucao;

  const task = list[index];

  const analistaSelect = document.getElementById(`analista-${context}-${index}`);
  if (!analistaSelect.value) { showToast('Selecione um analista!', 'warning'); analistaSelect.focus(); return; }

  if (task?.id) exitPartialMode(task.id);

  task.inicio = nowTimeStr();
  task.inicioTs = Date.now();
  task.status = 'in_progress';
  task.analista = analistaSelect.value;
  await saveRotinasContext(context);
render();
  showToast('Tarefa iniciada', 'success');
  autoClosePendingDays('action');
}

function calcDurationFromTimestamps(startTs, endTs) {
  if (!startTs || !endTs || endTs < startTs) return { text: '-', seconds: 0 };
  const diffSec = Math.floor((endTs - startTs) / 1000);
  return { text: formatSeconds(diffSec), seconds: diffSec };
}

async function finishTask(context, index) {
  let list;
  if (context === 'pc') list = rotinasPC;
  else if (context === 'analistas') list = rotinasAnalistas;
  else if (context === 'inventario') list = rotinasInventario;
  else list = rotinasDevolucao;

  const task = list[index];
  if (!task) return;

  if (task?.id && isPartialMode(task.id)) {
    showToast('Para concluir: limpe % e motivo (ou clique PARCIAL para finalizar como parcial).', 'warning');
    return;
  }

  if (task.status === 'done' || task.status === 'partial') { showToast('Tarefa j√° finalizada', 'warning'); return; }

  const lk = lockKey(context, task, 'finish');
  if (taskActionLocks.has(lk)) return;
  taskActionLocks.add(lk);

  try {
    if (!task.inicio) { showToast('Rotina n√£o iniciada!', 'error'); return; }

    const analistaSelect = document.getElementById(`analista-${context}-${index}`);
    const motivoSelect = document.getElementById(`motivo-${context}-${index}`);

    const analista = analistaSelect.value;
    const motivo = motivoSelect.value || "CONCLU√çDO";

    const fim = nowTimeStr();
    const endTs = Date.now();

    task.fim = fim;
    task.status = 'done';

    const dur = calcDurationFromTimestamps(task.inicioTs, endTs);

    // NOVO: grava dados no pr√≥prio task (para "Conclu√≠dos" do MOBILE via STATUS)
    task.fimTs = endTs;
    task.lastMotivo = motivo;
    task.durationSec = dur.seconds;
    task.duracao = dur.text;
    delete task.percent;

    const entry = {
      id: Date.now(),
      type: context,
      data: TODAY_STR,
      dateIso: localIsoDate(new Date()),
      rotina: task.nome,
      analista,
      motivo,
      inicio: task.inicio,
      fim,
      duracao: dur.text,
      durationSec: dur.seconds,
      percent: '-',
      status: 'Conclu√≠do',
      prioridade: task.prioridade,
      timestamp: new Date()
    };

    visibleHistory.unshift(entry);
    await archiveHistoryEntry(entry);
    if (currentUserRole === 'master') archiveHistory.unshift(entry);

    rebuildEffectiveHistory();

    moveTaskToEnd(list, index);
  await saveRotinasContext(context);
    await saveVisibleHistory();
render();
    updateCharts();
    showToast('Tarefa conclu√≠da', 'success');
    autoClosePendingDays('action');
  } finally {
    taskActionLocks.delete(lk);
  }
}

async function partialTask(context, index) {
  let list;
  if (context === 'pc') list = rotinasPC;
  else if (context === 'analistas') list = rotinasAnalistas;
  else if (context === 'inventario') list = rotinasInventario;
  else list = rotinasDevolucao;

  const task = list[index];
  if (!task) return;

  if (task.status === 'done' || task.status === 'partial') { showToast('Tarefa j√° finalizada', 'warning'); return; }
  if (!task.inicio) { showToast('Rotina n√£o iniciada!', 'error'); return; }

  if (task?.id && !isPartialMode(task.id)) {
    enterPartialMode(task.id);
    render();
    showToast('Modo PARCIAL ativado: informe % e Justificativa, depois clique PARCIAL novamente.', 'warning');
    return;
  }

  const lk = lockKey(context, task, 'partial');
  if (taskActionLocks.has(lk)) return;
  taskActionLocks.add(lk);

  try {
    const d = ensureDraft(task.id);
    const percent = String(d.percent || '').trim();
    const motivo = String(d.motivo || '').trim();

    if (!percent) { showToast('Informe a porcentagem!', 'warning'); return; }
    if (!motivo) { showToast('Selecione um motivo para finalizar como PARCIAL!', 'warning'); return; }

    const analistaSelect = document.getElementById(`analista-${context}-${index}`);
    const analista = analistaSelect.value;

    const fim = nowTimeStr();
    const endTs = Date.now();

    task.fim = fim;
    task.status = 'partial';
    task.percent = percent;

    const dur = calcDurationFromTimestamps(task.inicioTs, endTs);

    // NOVO: grava dados no pr√≥prio task (para "Conclu√≠dos" do MOBILE via STATUS)
    task.fimTs = endTs;
    task.lastMotivo = motivo;
    task.durationSec = dur.seconds;
    task.duracao = dur.text;

    const entry = {
      id: Date.now(),
      type: context,
      data: TODAY_STR,
      dateIso: localIsoDate(new Date()),
      rotina: task.nome,
      analista,
      motivo,
      inicio: task.inicio,
      fim,
      duracao: dur.text,
      durationSec: dur.seconds,
      percent: percent + '%',
      status: 'Parcial',
      prioridade: task.prioridade,
      timestamp: new Date()
    };

    visibleHistory.unshift(entry);
    await archiveHistoryEntry(entry);
    if (currentUserRole === 'master') archiveHistory.unshift(entry);

    rebuildEffectiveHistory();

    exitPartialMode(task.id);

    moveTaskToEnd(list, index);
  await saveRotinasContext(context);
    await saveVisibleHistory();
render();
    updateCharts();
    showToast('Tarefa marcada como parcial', 'success');
  } finally {
    taskActionLocks.delete(lk);
  }
}

/* ===========================
   NOVO: PROGRESSO NO HEADER (POR ABA)
   - progresso = "iniciadas" (status != pending) / total
=========================== */
function getListByContext(context){
  if (context === 'pc') return rotinasPC || [];
  if (context === 'analistas') return rotinasAnalistas || [];
  if (context === 'inventario') return rotinasInventario || [];
  if (context === 'devolucao') return rotinasDevolucao || [];
  return [];
}

function getTabLabel(context){
  if (context === 'all') return 'TODAS AS ABAS';
  if (context === 'pc') return 'OPERACIONAIS';
  if (context === 'analistas') return 'ANALISTAS';
  if (context === 'inventario') return 'INVENT√ÅRIO';
  if (context === 'devolucao') return 'DEVOLU√á√ÉO';
  return '';
}

function updateHeaderProgress(){
  const wrap = document.getElementById('tabProgress');
  const titleEl = document.getElementById('tabProgressTitle');
  const valueEl = document.getElementById('tabProgressValue');
  const cargoFill = document.getElementById('cargoFill');
  if (!wrap || !titleEl || !valueEl || !cargoFill) return;

  const allowed = (currentView === 'pc' || currentView === 'analistas' || currentView === 'inventario' || currentView === 'devolucao');
  wrap.style.display = allowed ? 'flex' : 'none';
  if (!allowed) return;

  const list = getListByContext(currentView);
  const total = list.length;
  const started = list.filter(t => t && t.status && t.status !== 'pending').length;
  const pct = total ? Math.round((started / total) * 100) : 0;

  titleEl.textContent = getTabLabel(currentView);
  valueEl.textContent = `${started}/${total} ‚Ä¢ ${pct}%`;

  // Preenche o "ba√∫" (largura m√°xima do ret√¢ngulo √© 44)
  const maxW = 44;
  cargoFill.setAttribute('width', String(Math.round((maxW * pct) / 100)));
}

/* ===========================
   UI / RENDER
=========================== */
function openTab(id) {
  // BLOQUEIOS
  if (id === 'mobile' && !isPrivileged()) {
    showToast('Acesso negado', 'error');
    return;
  }
  if (id === 'governance' && currentUserRole !== 'master') {
    showToast('Acesso negado', 'error');
    return;
  }

  currentView = id;

  // Limpa timer se sair da mobile
  if (mobileTimerInterval && id !== 'mobile') {
    clearInterval(mobileTimerInterval);
    mobileTimerInterval = null;
  }

  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  // ATIVO por ID - ORDEM AJUSTADA PARA REFLETIR A NOVA ORDEM DAS ABAS
  const navMap = {
    pc: 'navPcBtn',
    analistas: 'navAnalistasBtn',
    devolucao: 'navDevolucaoBtn',    // MOVIDO ANTES DO INVENT√ÅRIO
    inventario: 'navInventarioBtn',  // DEPOIS DA DEVOLU√á√ÉO
    mobile: 'navMobileBtn',
    auditoria: 'navAuditBtn',
    kpi: 'navKpiBtn',
    governance: 'navGovBtn'
  };
  const activeBtn = document.getElementById(navMap[id]);
  if (activeBtn) activeBtn.classList.add("active");

  const histCard = document.getElementById("historyCard");
  if (id === 'kpi' || id === 'governance' || id === 'mobile' || id === 'auditoria') {
    histCard.style.display = 'none';
    if (id === 'kpi') updateCharts();
    if (id === 'governance' && currentUserRole === 'master') renderGovernanceLog();
    if (id === 'mobile') renderMobileDashboard();
    if (id === 'auditoria') renderAuditoriaTab();
  } else {
    histCard.style.display = 'block';
    render();
  }

  // NOVO: sempre atualiza o progresso do header ao trocar de aba
  updateHeaderProgress();
}

function render() {
  // NOVO: atualiza sempre que renderizar (para refletir a√ß√µes em tempo real)
  updateHeaderProgress();
  refreshPanelIfOpen();

  if (currentView === 'mobile') {
    renderMobileDashboard();
    return;
  }

  sortByStatusAndPriority('pc');
  sortByStatusAndPriority('analistas');
  sortByStatusAndPriority('inventario');
  sortByStatusAndPriority('devolucao');

  renderList('pc', rotinasPC, document.getElementById("tasks"));
  renderList('analistas', rotinasAnalistas, document.getElementById("tasksAnalistas"));
  renderList('inventario', rotinasInventario, document.getElementById("tasksInventario"));
  renderList('devolucao', rotinasDevolucao, document.getElementById("tasksDevolucao"));

  // Ajuste do t√≠tulo do hist√≥rico
  let histTitle = 'OPERACIONAIS';
  if (currentView === 'analistas') histTitle = 'ANALISTAS';
  if (currentView === 'inventario') histTitle = 'INVENT√ÅRIO';
  if (currentView === 'devolucao') histTitle = 'DEVOLU√á√ÉO';

  document.getElementById("historyTitle").innerText = histTitle;
  renderHistory();
}

function renderList(context, list, container) {
  container.innerHTML = "";

  
// Renderiza recorrentes do contexto (no topo)
  const recForCtx = (recurringRoutines || []).filter(r => r && getRecurringContexts(r).includes(context));
  if (recForCtx.length) {
    const sortedRec = recForCtx.slice().sort((a,b) => {
      const aEnabled = (a && a.enabled !== false);
      const bEnabled = (b && b.enabled !== false);
      if (aEnabled !== bEnabled) return aEnabled ? -1 : 1;

      const ad = isRecurringDue(a) ? 0 : 1;
      const bd = isRecurringDue(b) ? 0 : 1;
      if (ad !== bd) return ad - bd;

      return Number(a.nextTs||0) - Number(b.nextTs||0);
    });

    sortedRec.forEach(r => {
      const enabled = (r && r.enabled !== false);
      const due = isRecurringDue(r);
      const next = formatTimeHHMM(r.nextTs);

      const badge = enabled
        ? '<span class="recurring-badge" style="margin-left:6px;">RECORRENTE</span>'
        : '<span class="recurring-badge paused" style="margin-left:6px;">PAUSADO</span>';

      const actions = (isPrivileged())
        ? (enabled
          ? `<button class="finish" onclick="markRecurringDone('${escapeHtml(r.id)}')">Feito</button>
             <button class="delete" onclick="pauseRecurring('${escapeHtml(r.id)}')">Pausar</button>
             <button class="delete" onclick="deleteRecurring('${escapeHtml(r.id)}')">Excluir</button>`
          : `<button class="finish" onclick="resumeRecurring('${escapeHtml(r.id)}')">Reativar</button>
             <button class="delete" onclick="deleteRecurring('${escapeHtml(r.id)}')">Excluir</button>` )
        : (enabled
          ? `<button class="finish" onclick="markRecurringDone('${escapeHtml(r.id)}')">Feito</button>`
          : ``);

      container.innerHTML += `
        <div class="task recurring-row ${ (enabled && due) ? 'due' : '' }" style="${enabled ? '' : 'opacity:.75;'}">
          <div class="prio-badge ${r.prioridade === 'alta' ? 'p-alta' : (r.prioridade === 'baixa' ? 'p-baixa' : 'p-media')}">
            ${(String(r.prioridade || 'media')).toUpperCase()}
          </div>

          <span title="${escapeHtml(r.nome)}">
            ‚è∞ ${escapeHtml(r.nome)} ${badge}
          </span>

          <span>${escapeHtml(r.analista || 'TODOS')}</span>

          <div>
            ${actions}
          </div>

          <span>-</span>

          <span style="font-weight:800;color:${(!enabled) ? '#6b7280' : (due ? '#dc3545' : '#0d6efd')};">
            ${(!enabled) ? 'PAUSADO' : (due ? 'VENCIDO' : 'Pr√≥ximo')}: ${escapeHtml(next)}
          </span>

          <span>${escapeHtml(next)}</span>
          <span>-</span>
        </div>
      `;
    });
  }

  const options =
 `<option value="">Selecione...</option>` + analistas.map(a => `<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');

  list.forEach((r, i) => {
    let rowClass = "task";
    if (r.status === 'done') rowClass += " row-done";
    else if (r.status === 'partial') rowClass += " row-partial";

    let badgeClass = "p-media";
    let badgeText = "M√©dia";
    if (r.prioridade === 'alta') { badgeClass = "p-alta"; badgeText = "ALTA"; }
    if (r.prioridade === 'baixa') { badgeClass = "p-baixa"; badgeText = "Baixa"; }

    const hasPriv = isPrivileged();
    const canFinish = (r.status === 'in_progress');
    const canPartial = (r.status === 'in_progress');

    const taskId = String(r.id || `${context}_${i}`);
    const partialMode = isPartialMode(taskId) && (r.status === 'in_progress');
    const draft = partialDraftByTaskId[taskId] || { percent:'', motivo:'' };

    const motivoDisabled = !partialMode;
    const percentDisabled = !partialMode;

    const motivosOptions = motivos.map(m => {
      const sel = (draft.motivo && draft.motivo === m) ? 'selected' : '';
      return `<option value="${escapeHtml(m)}" ${sel}>${escapeHtml(m)}</option>`;
    }).join('');

    const finishDisabled = (!canFinish) || partialMode;

    container.innerHTML += `
      <div class="${rowClass}">
        <div class="prio-badge ${badgeClass}">${escapeHtml(badgeText)}</div>

        <span title="${escapeHtml(r.nome)}">${escapeHtml(r.nome)}</span>

        <select id="analista-${context}-${i}">${options}</select>

        <div>
          <button class="start" ${r.status !== 'pending' ? 'disabled style="display:none"' : ''} onclick="startTask('${context}', ${i})">Iniciar</button>
          <button class="partial" ${canPartial ? '' : 'disabled'} onclick="partialTask('${context}', ${i})">Parcial</button>
          <button class="finish" ${finishDisabled ? 'disabled' : ''} onclick="finishTask('${context}', ${i})">Finalizar</button>
          ${hasPriv ? `
            <button class="edit" onclick="editRotina('${context}', ${i})">Editar</button>
            <button class="delete" onclick="removeRotina('${context}', ${i})">Excluir</button>
          ` : ''}
        </div>

        <input
          type="number"
          min="1"
          max="99"
          placeholder="%"
          value="${partialMode ? escapeHtml(draft.percent || '') : ''}"
          ${percentDisabled ? 'disabled' : ''}
          oninput="onPercentDraftInput('${context}', '${escapeHtml(taskId)}', this.value)"
        >

        <select
          id="motivo-${context}-${i}"
          style="width:100%"
          ${motivoDisabled ? 'disabled' : ''}
          onchange="onMotivoDraftChange('${context}', '${escapeHtml(taskId)}', this.value)"
        >
          <option value="">-- Selecione --</option>
          ${motivosOptions}
        </select>

        <span class="inicio">${escapeHtml(r.inicio || "-")}</span>
        <span class="fim">${escapeHtml(r.fim || "-")}</span>
      </div>
    `;

    setTimeout(() => {
      if (r.analista) {
        const sel = document.getElementById(`analista-${context}-${i}`);
        if (sel) sel.value = r.analista;
      }
      const ms = document.getElementById(`motivo-${context}-${i}`);
      if (ms && partialMode) ms.value = draft.motivo || '';
    }, 0);
  });
}

function renderHistory() {
  const filteredHistory = history.filter(h => {
    if (currentView === 'pc') return (!h.type || h.type === 'pc');
    if (currentView === 'analistas') return h.type === 'analistas';
    if (currentView === 'inventario') return h.type === 'inventario';
    if (currentView === 'devolucao') return h.type === 'devolucao';
    return false;
  });

  document.getElementById("history").innerHTML = filteredHistory.map(h => `
    <tr>
      <td>${escapeHtml(h.data)}</td>
      <td>${escapeHtml(h.rotina)}</td>
      <td>${escapeHtml(h.analista)}</td>
      <td>${escapeHtml(h.prioridade || '-')}</td>
      <td>${escapeHtml(h.motivo || "-")}</td>
      <td>${escapeHtml(h.inicio || "-")}</td>
      <td>${escapeHtml(h.fim || "-")}</td>
      <td>${escapeHtml(h.duracao || "-")}</td>
      <td>${escapeHtml(h.percent || "-")}</td>
      <td>${escapeHtml(h.status || "-")}</td>
    </tr>
  `).join("");
}

/* ===========================
   MODAL ROTINA
=========================== */
const modal = document.getElementById("modal");
const panelModal = document.getElementById("panelModal");

function openModal(context) {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  currentContext = context;
  currentEditId = null;
  document.getElementById('rotinaInput').value = "";
  document.getElementById('rotinaPrio').value = "media";
  modal.style.display = "flex";
}

function closeModal() { modal.style.display = "none"; }

function nextOrderIndexFor(list) {
  let max = -1;
  list.forEach(t => { if (typeof t.orderIndex === 'number' && t.orderIndex > max) max = t.orderIndex; });
  return max + 1;
}

async function saveRotina() {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }

  const nome = document.getElementById('rotinaInput').value.trim();
  const prioridade = document.getElementById('rotinaPrio').value;
  if (!nome) { showToast('Informe o nome da rotina', 'error'); return; }

  let list;
  if (currentContext === 'pc') list = rotinasPC;
  else if (currentContext === 'analistas') list = rotinasAnalistas;
  else if (currentContext === 'inventario') list = rotinasInventario;
  else list = rotinasDevolucao;

  if (currentEditId !== null) {
    const task = list.find(t => t.id === currentEditId);
    if (task) {
      const oldName = task.nome;
      task.nome = nome;
      task.prioridade = prioridade;
      await logGovernanceAction('UPDATE_ROUTINE', `Rotina atualizada: ${oldName} -> ${nome}`, currentContext);
    }
  } else {
    const newTask = {
      id: currentContext + '_' + Date.now(),
      nome,
      prioridade,
      status: 'pending',
      orderIndex: nextOrderIndexFor(list)
    };
    list.push(newTask);
    await logGovernanceAction('CREATE_ROUTINE', `Nova rotina criada: ${nome}`, currentContext);
  }

  closeModal();
  await saveRotinasContext(currentContext);
render();
  showToast('Rotina salva com sucesso', 'success');
}

function editRotina(context, i) {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  let list;
  if (context === 'pc') list = rotinasPC;
  else if (context === 'analistas') list = rotinasAnalistas;
  else if (context === 'inventario') list = rotinasInventario;
  else list = rotinasDevolucao;

  const task = list[i];
  currentContext = context;
  currentEditId = task.id;
  document.getElementById('rotinaInput').value = task.nome;
  document.getElementById('rotinaPrio').value = task.prioridade;
  modal.style.display = "flex";
}

async function removeRotina(context, i) {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  if (!confirm("Excluir rotina?")) return;

  let list;
  if (context === 'pc') list = rotinasPC;
  else if (context === 'analistas') list = rotinasAnalistas;
  else if (context === 'inventario') list = rotinasInventario;
  else list = rotinasDevolucao;

  const task = list[i];
  if (task?.id) exitPartialMode(task.id);

  list.splice(i, 1);

  await logGovernanceAction('DELETE_ROUTINE', `Rotina removida: ${task.nome}`, context);
  await saveRotinasContext(context);
render();
  showToast('Rotina removida', 'success');
}

async function resetRotinas(context) {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  let label = 'OPERACIONAIS';
  if(context === 'analistas') label = 'ANALISTAS';
  if(context === 'inventario') label = 'INVENT√ÅRIO';
  if(context === 'devolucao') label = 'DEVOLU√á√ÉO';

  if (!confirm(`Reiniciar todas as rotinas de ${label}?`)) return;

  let list;
  if (context === 'pc') list = rotinasPC;
  else if (context === 'analistas') list = rotinasAnalistas;
  else if (context === 'inventario') list = rotinasInventario;
  else list = rotinasDevolucao;

  list.forEach(resetRoutineFields);
  applyDefaultPrioritiesAndOrder(context);

  await logGovernanceAction('RESET_ROUTINES', `Rotinas reiniciadas: ${context}`, context);
  await saveRotinasContext(context);
render();
  showToast('Rotinas reiniciadas', 'success');
}

/**
 * LIMPAR HIST√ìRICO
 */
async function clearHistory() {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }

  let purgeType;
  if (currentView === 'pc') purgeType = 'pc';
  else if (currentView === 'analistas') purgeType = 'analistas';
  else if (currentView === 'inventario') purgeType = 'inventario';
  else purgeType = 'devolucao';

  if (!confirm(`Apagar hist√≥rico da aba ${purgeType.toUpperCase()}?`)) return;

  // 1) sempre limpa o VIS√çVEL (pra todo mundo)
  visibleHistory = (visibleHistory || []).filter(h => !matchTypeForPurge(h, purgeType));

  // 2) MASTER: limpa tamb√©m o ARQUIVO (todos os anos)
  if (currentUserRole === 'master') {
    try {
      showToast('MASTER: limpando tamb√©m o arquivo anual...', 'warning');

      await purgeArchiveAllYearsByType(purgeType);

      // zera mem√≥ria local
      archiveHistory = (archiveHistory || []).filter(h => !matchTypeForPurge(h, purgeType));

      // n√£o re-injeta nada (vis√≠vel j√° est√° limpo desse tipo)
      rebuildEffectiveHistory();

      // some imediatamente na UI
      renderHistory();
      updateCharts();

      await logGovernanceAction('MASTER_PURGE_HISTORY', `MASTER limpou hist√≥rico: ${purgeType}`);
      showToast('Hist√≥rico removido (vis√≠vel + arquivo anual)', 'success');
    } catch (e) {
      console.error(e);
      showToast('Erro ao limpar arquivo anual (MASTER)', 'error');
    }
  } else {
    rebuildEffectiveHistory();
    await logGovernanceAction('CLEAR_HISTORY', `Hist√≥rico limpo (vis√≠vel): ${purgeType}`);
    showToast('Hist√≥rico limpo (vis√≠vel)', 'success');
  }

  // salva o vis√≠vel
  await saveVisibleHistory();
// garante UI atualizada mesmo para ADMIN/USER
  rebuildEffectiveHistory();
  renderHistory();
  updateCharts();
}

/* ===========================
   PAINEL
=========================== */
function openManagementPanel(context) {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  currentContext = context;

  let label = 'OPERACIONAIS';
  if(context === 'analistas') label = 'ANALISTAS';
  if(context === 'inventario') label = 'INVENT√ÅRIO';
  if(context === 'devolucao') label = 'DEVOLU√á√ÉO';

  document.getElementById('panelContextTitle').innerText = label;

  renderPrioList();
  renderTeamList();
  renderMotivosList();

  if (currentUserRole === 'master') {
    renderAdminList();
    renderUsersList();
  }

  panelModal.style.display = "flex";
}



function refreshPanelIfOpen(){
  try {
    const pm = document.getElementById('panelModal');
    if (!pm) return;
    const open = (pm.style.display === 'flex');
    if (!open) return;

    // Re-render conte√∫dos do painel em tempo real
    if (typeof renderPrioList === 'function') renderPrioList();
    if (typeof renderTeamList === 'function') renderTeamList();
    if (typeof renderMotivosList === 'function') renderMotivosList();
    if (typeof renderRecurringList === 'function') renderRecurringList();

    if (currentUserRole === 'master') {
      if (typeof renderAdminList === 'function') renderAdminList();
      if (typeof renderUsersList === 'function') renderUsersList();
    }
  } catch (e) {
    console.warn('refreshPanelIfOpen falhou:', e);
  }
}
async function closePanelModal() { panelModal.style.display = "none"; await saveRecurringOnly(); }

function renderPrioList() {
  let list;
  if (currentContext === 'pc') list = rotinasPC;
  else if (currentContext === 'analistas') list = rotinasAnalistas;
  else if (currentContext === 'inventario') list = rotinasInventario;
  else list = rotinasDevolucao;

  document.getElementById('prioList').innerHTML = list.map((r) => `
    <div class="list-item">
      <span style="font-size:12px;">${escapeHtml(r.nome)}</span>
      <select onchange="tempChangePriority('${escapeHtml(r.id)}', this.value)" style="width:100px; padding:4px;">
        <option value="alta" ${r.prioridade === 'alta' ? 'selected' : ''}>üî• Alta</option>
        <option value="media" ${r.prioridade === 'media' ? 'selected' : ''}>üü° M√©dia</option>
        <option value="baixa" ${r.prioridade === 'baixa' ? 'selected' : ''}>üîµ Baixa</option>
      </select>
    </div>
  `).join("");
}
function tempChangePriority(taskId, value) {
  let list;
  if (currentContext === 'pc') list = rotinasPC;
  else if (currentContext === 'analistas') list = rotinasAnalistas;
  else if (currentContext === 'inventario') list = rotinasInventario;
  else list = rotinasDevolucao;

  const task = list.find(t => t.id === taskId);
  if (task) task.prioridade = value;
}
async function savePriorities() {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }

  sortByStatusAndPriority(currentContext);

  await logGovernanceAction('UPDATE_PRIORITIES', `Prioridades atualizadas: ${currentContext}`);
  await saveRotinasContext(currentContext);
render();
  showToast('Prioridades salvas!', 'success');
}

function renderTeamList() {
  document.getElementById('teamList').innerHTML = analistas.map((a, i) => `
    <div class="list-item">
      <span>${escapeHtml(a)}</span>
      <div>
        <button class="icon-btn btn-edit" onclick="editAnalista(${i})">Editar</button>
        <button class="icon-btn btn-del" onclick="deleteAnalista(${i})">X</button>
      </div>
    </div>
  `).join("");
}
function renderMotivosList() {
  document.getElementById('motivosList').innerHTML = motivos.map((m, i) => `
    <div class="list-item">
      <span>${escapeHtml(m)}</span>
      <button class="icon-btn btn-del" onclick="deleteMotivo(${i})">X</button>
    </div>
  `).join("");
}

function renderAdminList() {
  if (currentUserRole !== 'master') return;
  const container = document.getElementById('adminList');
  if (!container) return;

  const list = adminEmails.map(normalizeEmail).filter(Boolean).filter(e => e !== MASTER_EMAIL);
  if (!list.length) { container.innerHTML = `<div style="padding:10px; color:#666;">Nenhum ADMIN cadastrado.</div>`; return; }

  container.innerHTML = list.map((email) => `
    <div class="list-item">
      <span>${escapeHtml(email)}</span>
      <button class="icon-btn btn-del" onclick="removeAdminEmail('${escapeHtml(email)}')">Remover</button>
    </div>
  `).join("");
}
async function addAdminEmail() {
  if (currentUserRole !== 'master') { showToast('Acesso negado', 'error'); return; }
  const input = document.getElementById('newAdminEmailInput');
  const email = normalizeEmail(input.value);

  if (!email || !email.includes('@')) { showToast('Informe um e-mail v√°lido', 'warning'); return; }
  if (email === MASTER_EMAIL) { showToast('MASTER n√£o pode ser ADMIN', 'warning'); return; }
  if (adminEmails.includes(email)) { showToast('E-mail j√° est√° como ADMIN', 'warning'); return; }

  adminEmails.push(email);
  input.value = '';

  await savePermissions();
  await logGovernanceAction('ADD_ADMIN', `ADMIN adicionado: ${email}`, 'permissions');
  renderAdminList();
  renderUsersList();
  showToast('Permiss√£o ADMIN adicionada', 'success');
}
async function removeAdminEmail(email) {
  if (currentUserRole !== 'master') { showToast('Acesso negado', 'error'); return; }
  const e = normalizeEmail(email);
  if (!confirm(`Remover ADMIN: ${e}?`)) return;

  adminEmails = adminEmails.filter(x => normalizeEmail(x) !== e);

  await savePermissions();
  await logGovernanceAction('REMOVE_ADMIN', `ADMIN removido: ${e}`, 'permissions');
  renderAdminList();
  renderUsersList();
  showToast('Permiss√£o ADMIN removida', 'success');
}

function roleBadgeHTML(email) {
  const role = resolveRoleForEmail(email);
  if (role === 'master') return `<span class="badge master">MASTER</span>`;
  if (role === 'admin') return `<span class="badge admin">ADMIN</span>`;
  return `<span class="badge user">USER</span>`;
}

function renderUsersList() {
  if (currentUserRole !== 'master') return;
  const container = document.getElementById('usersList');
  if (!container) return;

  const rows = usersList
    .map(u => ({ email: normalizeEmail(u.email), name: String(u.name||'').trim() }))
    .filter(u => u.email)
    .sort((a,b) => {
      const ra = resolveRoleForEmail(a.email);
      const rb = resolveRoleForEmail(b.email);
      const order = { master: 0, admin: 1, user: 2 };
      if (order[ra] !== order[rb]) return order[ra] - order[rb];
      return a.email.localeCompare(b.email);
    });

  container.innerHTML = rows.map(u => {
    const isMasterRow = u.email === MASTER_EMAIL;
    return `
      <div class="list-item">
        <div style="display:flex;flex-direction:column;gap:2px;min-width:0;">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            ${roleBadgeHTML(u.email)}
            <span style="font-weight:700;">${escapeHtml(u.name || u.email)}</span>
          </div>
          <div style="color:#666;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(u.email)}</div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="icon-btn btn-edit" ${isMasterRow ? 'disabled title="Senha do MASTER n√£o √© edit√°vel aqui"' : ''} onclick="editUserPasswordPrompt('${escapeHtml(u.email)}')">Alterar Senha</button>
          <button class="icon-btn btn-del" ${isMasterRow ? 'disabled title="Usu√°rio MASTER n√£o pode ser exclu√≠do"' : ''} onclick="deleteUserPrompt('${escapeHtml(u.email)}')">Excluir</button>
        </div>
      </div>
    `;
  }).join('');
}

async function addNewUser() {
  if (currentUserRole !== 'master') { showToast('Acesso negado', 'error'); return; }

  const name = String(document.getElementById('newUserName').value || '').trim();
  const email = normalizeEmail(document.getElementById('newUserEmail').value);
  const password = String(document.getElementById('newUserPassword').value || '');
  const role = String(document.getElementById('newUserRole').value || 'user');

  if (!name) { showToast('Informe o nome', 'warning'); return; }
  if (!email || !email.includes('@')) { showToast('Informe um e-mail v√°lido', 'warning'); return; }
  if (!password || password.length < 4) { showToast('Senha muito curta (m√≠n. 4)', 'warning'); return; }
  if (email === MASTER_EMAIL) { showToast('MASTER n√£o pode ser cadastrado aqui', 'warning'); return; }

  await loadUsers();
  if (usersMap[email]) { showToast('Usu√°rio j√° existe', 'warning'); return; }

  usersList.push({ email, name, password });
  rebuildUsersMap();

  if (role === 'admin') {
    if (!adminEmails.includes(email)) adminEmails.push(email);
  } else {
    adminEmails = adminEmails.filter(x => normalizeEmail(x) !== email);
  }

  await savePermissions();
  await saveUsers();
  await logGovernanceAction('CREATE_USER', `Usu√°rio criado: ${email} (${role.toUpperCase()})`, 'users_credentials');

  document.getElementById('newUserName').value = '';
  document.getElementById('newUserEmail').value = '';
  document.getElementById('newUserPassword').value = '';
  document.getElementById('newUserRole').value = 'user';

  renderAdminList();
  renderUsersList();
  showToast('Usu√°rio cadastrado com sucesso', 'success');
}

async function editUserPasswordPrompt(email) {
  if (currentUserRole !== 'master') { showToast('Acesso negado', 'error'); return; }
  const e = normalizeEmail(email);
  if (!e || e === MASTER_EMAIL) return;

  await loadUsers();
  if (!usersMap[e]) { showToast('Usu√°rio n√£o encontrado', 'error'); return; }

  const newPass = prompt(`Nova senha para ${e}:`);
  if (newPass === null) return;
  const p = String(newPass || '');
  if (p.length < 4) { showToast('Senha muito curta (m√≠n. 4)', 'warning'); return; }

  usersList = usersList.map(u => normalizeEmail(u.email) === e ? { ...u, password: p } : u);
  rebuildUsersMap();

  await saveUsers();
  await logGovernanceAction('UPDATE_PASSWORD', `Senha alterada para: ${e}`, 'users_credentials');

  showToast('Senha atualizada', 'success');
}

async function deleteUserPrompt(email) {
  if (currentUserRole !== 'master') { showToast('Acesso negado', 'error'); return; }

  const e = normalizeEmail(email);
  if (!e || e === MASTER_EMAIL) { showToast('N√£o √© poss√≠vel excluir o usu√°rio MASTER', 'warning'); return; }

  await loadUsers();
  if (!usersMap[e]) { showToast('Usu√°rio n√£o encontrado', 'error'); return; }

  if (!confirm(`Excluir usu√°rio ${e}? Essa a√ß√£o n√£o pode ser desfeita.`)) return;

  usersList = usersList.filter(u => normalizeEmail(u.email) !== e);
  rebuildUsersMap();

  adminEmails = adminEmails.filter(x => normalizeEmail(x) !== e);

  await savePermissions();
  await saveUsers();
  await logGovernanceAction('DELETE_USER', `Usu√°rio exclu√≠do: ${e}`, 'users_credentials');

  renderAdminList();
  renderUsersList();
  showToast('Usu√°rio exclu√≠do com sucesso', 'success');
}

async function addAnalista() {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  const input = document.getElementById('newAnalistaInput');
  const nome = String(input.value || '').trim().toUpperCase();
  if (!nome) return;

  if (analistas.includes(nome)) { showToast('Analista j√° existe', 'warning'); return; }
  analistas.push(nome);
  input.value = '';

  await logGovernanceAction('ADD_ANALYST', `Analista adicionado: ${nome}`, 'config');
  await saveConfigOnly();
renderTeamList();
  populateAnalystFilter();
  showToast('Analista adicionado', 'success');
}

async function addMotivo() {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  const input = document.getElementById('newMotivoInput');
  const motivo = String(input.value || '').trim().toUpperCase();
  if (!motivo) return;

  if (motivos.includes(motivo)) { showToast('Motivo j√° existe', 'warning'); return; }
  motivos.push(motivo);
  input.value = '';

  await logGovernanceAction('ADD_REASON', `Motivo adicionado: ${motivo}`, 'config');
  await saveConfigOnly();
renderMotivosList();
  showToast('Motivo adicionado', 'success');
}

async function deleteAnalista(i) {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  if (!confirm("Remover analista?")) return;
  const name = analistas[i];
  analistas.splice(i, 1);

  await logGovernanceAction('DELETE_ANALYST', `Analista removido: ${name}`, 'config');
  await saveConfigOnly();
renderTeamList();
  populateAnalystFilter();
  showToast('Analista removido', 'success');
}

async function deleteMotivo(i) {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  if (!confirm("Remover motivo?")) return;
  const motivo = motivos[i];
  motivos.splice(i, 1);

  await logGovernanceAction('DELETE_REASON', `Motivo removido: ${motivo}`, 'config');
  await saveConfigOnly();
renderMotivosList();
  showToast('Motivo removido', 'success');
}

async function editAnalista(i) {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  const nome = prompt("Nome:", analistas[i]);
  if (!nome) return;
  const oldName = analistas[i];
  analistas[i] = String(nome).toUpperCase();

  await logGovernanceAction('EDIT_ANALYST', `Analista editado: ${oldName} -> ${nome}`, 'config');
  await saveConfigOnly();
renderTeamList();
  populateAnalystFilter();
  showToast('Analista editado', 'success');
}



/* ===========================
   ROTINAS RECORRENTES (LEMBRETES)
=========================== */
function startRecurringMonitor(){
  if (recurringMonitorInterval) clearInterval(recurringMonitorInterval);
  recurringMonitorInterval = setInterval(() => {
    if (['pc','analistas','inventario','devolucao','mobile'].includes(currentView)) {
      if (currentView === 'mobile') renderMobileDashboard();
      else render();
    }
  }, 15000);
}

function stopRecurringMonitor(){
  if (recurringMonitorInterval) clearInterval(recurringMonitorInterval);
  recurringMonitorInterval = null;
}

function nextTsFromNow(intervalMin){
  const m = Math.max(1, Number(intervalMin || 1));
  return Date.now() + (m * 60 * 1000);
}


function isRecurringDue(item){
  const enabled = (item && item.enabled !== false);
  if (!enabled) return false;
  const ts = Number(item?.nextTs || 0);
  return ts > 0 && Date.now() >= ts;
}

function formatTimeHHMM(ts){
  const d = new Date(Number(ts || 0));
  if (isNaN(d.getTime())) return '-';
  return d.toLocaleTimeString('pt-BR', { hour12:false, hour:'2-digit', minute:'2-digit' });
}

function recSelectAllCtx(flag){
  const ids = ['recCtxPc','recCtxAnalistas','recCtxInventario','recCtxDevolucao'];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.checked = !!flag;
  });
}

function getRecurringContexts(item){
  // compatibilidade: vers√µes antigas usavam "context" (string) ou "all"
  if (item && Array.isArray(item.contexts) && item.contexts.length) return item.contexts;
  const c = String(item?.context || '');
  if (c === 'all') return ['pc','analistas','inventario','devolucao'];
  if (c === 'pc' || c === 'analistas' || c === 'inventario' || c === 'devolucao') return [c];
  return [];
}

function contextsLabel(item){
  const ctxs = getRecurringContexts(item);
  if (!ctxs.length) return '-';
  if (ctxs.length === 4) return 'TODAS AS ABAS';
  return ctxs.map(getTabLabel).join(' / ');
}

function contextsTarget(item){
  const ctxs = getRecurringContexts(item);
  return ctxs.length ? ctxs.join('|') : String(item?.context || '');
}
// Permiss√£o para marcar recorrente como FEITO:
// - Se analista == 'TODOS' => qualquer usu√°rio logado pode marcar
// - Se analista espec√≠fico => somente esse analista (por nome) pode marcar
function normalizePersonName(v){
  return String(v || '')
    .trim()
    .toUpperCase()
    .normalize('NFD')
    .replace(/[ÃÄ-ÕØ]/g, '');
}
function isRecurringAssignedToCurrentUser(item){
  const assignee = normalizePersonName(item?.analista || 'TODOS');
  if (!assignee || assignee === 'TODOS') return true; // placeholder replaced below
  const me = normalizePersonName(currentUser?.name || currentUser?.email || '');
  return assignee === me;
}
function canMarkRecurringDone(item){
  // precisa estar logado
  if (!currentUser) return false;
  const assignee = normalizePersonName(item?.analista || 'TODOS');
  if (!assignee || assignee === 'TODOS') return true;
  const me = normalizePersonName(currentUser?.name || currentUser?.email || '');
  return assignee === me;
}

async function addRecurringRoutine(){
  try {
    if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }

    const name = String(document.getElementById('recName')?.value || '').trim();
    const contexts = [
      document.getElementById('recCtxPc')?.checked ? 'pc' : null,
      document.getElementById('recCtxAnalistas')?.checked ? 'analistas' : null,
      document.getElementById('recCtxInventario')?.checked ? 'inventario' : null,
      document.getElementById('recCtxDevolucao')?.checked ? 'devolucao' : null,
    ].filter(Boolean);

    const intervalMin = Number(document.getElementById('recIntervalMin')?.value || 0);
    const prioridade = String(document.getElementById('recPrioridade')?.value || 'alta');
    const analista = String(document.getElementById('recAnalista')?.value || 'TODOS');

    if (!name) { showToast('Informe o nome do lembrete', 'warning'); return; }
    if (!contexts.length) { showToast('Selecione pelo menos uma aba para o lembrete', 'warning'); return; }
    if (!intervalMin || intervalMin < 1) { showToast('Intervalo m√≠nimo √© 1 minuto', 'warning'); return; }

    const item = {
      id: 'rec_' + Date.now(),
      nome: name,
      contexts,
      context: (contexts.length === 4 ? 'all' : (contexts[0] || 'pc')) ,
      intervalMin,
      prioridade,
      analista,
      nextTs: nextTsFromNow(intervalMin),
      enabled: true,
      createdAt: Date.now()
    };

    // otimista (mostra na UI), mas garante persist√™ncia
    recurringRoutines.unshift(item);
    renderRecurringList();
    render();

    await saveRecurringOnly();

    // governan√ßa √© ‚Äúbest-effort‚Äù (n√£o pode impedir o cadastro)
    try {
      await logGovernanceAction('CREATE_RECURRING', `Recorrente criada: ${name} (${intervalMin}min)`, contexts.join('|'));
    } catch (e) {
      console.warn('Falha ao gravar governan√ßa (n√£o bloqueia):', e);
    }

    const a = document.getElementById('recName');
    const b = document.getElementById('recIntervalMin');
    if (a) a.value = '';
    if (b) b.value = '';

    showToast('Rotina recorrente cadastrada', 'success');
  } catch (e) {
    console.error(e);

    // rollback local
    const name = String(document.getElementById('recName')?.value || '').trim();
    recurringRoutines = (recurringRoutines || []).filter(r => r && r.nome !== name);

    renderRecurringList();
    render();

    showToast(e?.message || 'Erro ao cadastrar recorrente', 'error');
  }
}

async function markRecurringDone(id){
  // Qualquer usu√°rio logado pode marcar recorrente como FEITO
  if (!currentUser) { showToast('Fa√ßa login para marcar como FEITO', 'error'); return; }

  const idx = (recurringRoutines || []).findIndex(x => String(x?.id) === String(id));
  if (idx < 0) return;

  const item = recurringRoutines[idx];
  item.nextTs = nextTsFromNow(item.intervalMin);

  await logGovernanceAction('RECURRING_DONE', `Recorrente marcada como FEITO: ${item.nome}`, contextsTarget(item));
  await saveRecurringOnly();

  render();
  showToast('Reagendado para o pr√≥ximo intervalo', 'success');
}



async function deleteRecurring(id){
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  const item = (recurringRoutines || []).find(x => String(x?.id) === String(id));
  if (!item) return;
  if (!confirm(`Excluir recorrente: ${item.nome}?`)) return;

  recurringRoutines = (recurringRoutines || []).filter(x => String(x?.id) !== String(id));

  await logGovernanceAction('DELETE_RECURRING', `Recorrente exclu√≠da: ${item.nome}`, contextsTarget(item));
  await saveRecurringOnly();

  render();
  showToast('Recorrente exclu√≠da', 'success');
}

async function pauseRecurring(id){
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  const item = (recurringRoutines || []).find(x => String(x?.id) === String(id));
  if (!item) return;

  item.enabled = false;

  await logGovernanceAction('RECURRING_PAUSE', `Recorrente pausada: ${item.nome}`, contextsTarget(item));
  await saveRecurringOnly();

  render();
  showToast('Recorrente pausada', 'success');
}

async function resumeRecurring(id){
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  const item = (recurringRoutines || []).find(x => String(x?.id) === String(id));
  if (!item) return;

  item.enabled = true;
  item.nextTs = nextTsFromNow(item.intervalMin);

  await logGovernanceAction('RECURRING_RESUME', `Recorrente reativada: ${item.nome}`, contextsTarget(item));
  await saveRecurringOnly();

  render();
  showToast('Recorrente reativada', 'success');
}

async function pauseAllRecurring(){
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  if (!confirm('Pausar TODOS os lembretes recorrentes?')) return;

  (recurringRoutines || []).forEach(r => { if (r) r.enabled = false; });

  await logGovernanceAction('RECURRING_PAUSE_ALL', 'Todos os recorrentes foram pausados', 'recurring_routines');
  await saveRecurringOnly();

  render();
  showToast('Todos os recorrentes foram pausados', 'success');
}

async function resumeAllRecurring(){
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  if (!confirm('Reativar TODOS os lembretes recorrentes (reagenda a partir de agora)?')) return;

  (recurringRoutines || []).forEach(r => {
    if (!r) return;
    r.enabled = true;
    r.nextTs = nextTsFromNow(r.intervalMin);
  });

  await logGovernanceAction('RECURRING_RESUME_ALL', 'Todos os recorrentes foram reativados', 'recurring_routines');
  await saveRecurringOnly();

  render();
  showToast('Todos os recorrentes foram reativados', 'success');
}


function renderRecurringList(){
  const el = document.getElementById('recurringList');
  if (!el) return;

  if (!recurringRoutines?.length) {
    el.innerHTML = '<div style="padding:10px;color:#666;">Nenhuma rotina recorrente cadastrada.</div>';
    return;
  }

  const rows = recurringRoutines.slice().sort((a,b) => {
    const aEnabled = (a && a.enabled !== false);
    const bEnabled = (b && b.enabled !== false);
    if (aEnabled !== bEnabled) return aEnabled ? -1 : 1;

    const ad = isRecurringDue(a) ? 0 : 1;
    const bd = isRecurringDue(b) ? 0 : 1;
    if (ad !== bd) return ad - bd;

    return (Number(a?.nextTs||0) - Number(b?.nextTs||0));
  });

  el.innerHTML = rows.map(r => {
    const enabled = (r && r.enabled !== false);
    const due = isRecurringDue(r);
    const next = formatTimeHHMM(r.nextTs);
    const ctx = contextsLabel(r);

    const badgeClass = enabled ? 'recurring-badge' : 'recurring-badge paused';
    const badgeText = enabled ? (due ? 'VENCIDO' : 'AGENDADO') : 'PAUSADO';

    const style = enabled
      ? (due ? 'border-left:4px solid #dc3545;background:rgba(220,53,69,.06);'
             : 'border-left:4px solid #0d6efd;background:rgba(13,110,253,.04);')
      : 'border-left:4px solid #6b7280;background:rgba(107,114,128,.06);';

    return `
      <div class="list-item" style="${style}">
        <div style="display:flex;flex-direction:column;gap:2px;min-width:0;">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <span class="${badgeClass}">${badgeText}</span>
            <span style="font-weight:900;">${escapeHtml(r.nome)}</span>
          </div>
          <small style="color:#666;">
            Aba: <b>${escapeHtml(ctx)}</b> ‚Ä¢ Intervalo: <b>${escapeHtml(r.intervalMin)} min</b> ‚Ä¢ Analista: <b>${escapeHtml(r.analista||'TODOS')}</b> ‚Ä¢ Pr√≥ximo: <b>${escapeHtml(next)}</b>
          </small>
        </div>

        <div class="recurring-actions">
          ${ enabled
            ? `<button class="recurring-done-btn" onclick="markRecurringDone('${escapeHtml(r.id)}')">Feito</button>
               <button class="recurring-del-btn" onclick="pauseRecurring('${escapeHtml(r.id)}')">Pausar</button>`
            : `<button class="recurring-done-btn" onclick="resumeRecurring('${escapeHtml(r.id)}')">Reativar</button>`
          }
          <button class="recurring-del-btn" onclick="deleteRecurring('${escapeHtml(r.id)}')">Excluir</button>
        </div>
      </div>
    `;
  }).join('');
}

/* ===========================
   KPI / EXPORT
=========================== */
function exportToExcel() {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }

  let contextName = '';
  const filteredHistory = history.filter(h => {
    if(currentView === 'pc') { contextName='OPERACIONAIS'; return (!h.type || h.type === 'pc'); }
    if(currentView === 'analistas') { contextName='ANALISTAS'; return h.type === 'analistas'; }
    if(currentView === 'inventario') { contextName='INVENTARIO'; return h.type === 'inventario'; }
    if(currentView === 'devolucao') { contextName='DEVOLUCAO'; return h.type === 'devolucao'; }
    return false;
  });

  let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
    <head><meta charset="utf-8"></head>
    <body>
      <table border="1">
        <thead>
          <tr style="background-color:#7A1417; color:#fff;">
            <th>Data</th><th>Rotina</th><th>Analista</th><th>Prioridade</th><th>Status/Justificativa</th>
            <th>In√≠cio</th><th>Fim</th><th>Dura√ß√£o</th><th>%</th><th>Status</th>
          </tr>
        </thead>
        <tbody>`;

  filteredHistory.forEach(h => {
    html += `<tr>
      <td>${escapeHtml(h.data)}</td><td>${escapeHtml(h.rotina)}</td><td>${escapeHtml(h.analista)}</td><td>${escapeHtml(h.prioridade || "-")}</td>
      <td>${escapeHtml(h.motivo || "")}</td><td>${escapeHtml(h.inicio || "-")}</td><td>${escapeHtml(h.fim || "-")}</td><td>${escapeHtml(h.duracao || "-")}</td>
      <td>${escapeHtml(h.percent || "-")}</td><td>${escapeHtml(h.status || "-")}</td>
    </tr>`;
  });

  html += `</tbody></table></body></html>`;

  const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `Relatorio_${contextName}_${TODAY_STR.replace(/\//g, '-')}.xls`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function setupKpiFilters() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('kpiDateStart').value = today;
  document.getElementById('kpiDateEnd').value = today;
  populateAnalystFilter();
}

function populateAnalystFilter() {
  const select = document.getElementById('kpiAnalista');
  if (!select) return;

  const currentValue = select.value;
  select.innerHTML = '<option value="">Todos</option>';

  analistas.forEach(a => {
    const option = document.createElement('option');
    option.value = a;
    option.textContent = a;
    select.appendChild(option);
  });

  if (currentValue) select.value = currentValue;

  // tamb√©m popula o select do cadastro de recorrentes (Painel)
  const recSel = document.getElementById('recAnalista');
  if (recSel) {
    const current = recSel.value;
    recSel.innerHTML = '<option value="TODOS">TODOS</option>' + analistas.map(a => `<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
    if (current) recSel.value = current;
  }
}

function updateCharts() {
  const filteredHistory = filterHistoryForKpi();

  let countDone = 0, countPartial = 0;
  const rankingMap = {};
  const motivosMap = {};
  let totalSeconds = 0, slaCount = 0;

  filteredHistory.forEach(h => {
    if (h.status === 'Conclu√≠do') countDone++;
    else if (h.status === 'Parcial') countPartial++;

    rankingMap[h.analista] = (rankingMap[h.analista] || 0) + 1;

    const motivo = h.motivo || "";
    if (motivo && motivo !== "CONCLU√çDO" && motivo !== "PARCIAL") motivosMap[motivo] = (motivosMap[motivo] || 0) + 1;

    if (h.status === 'Conclu√≠do') {
      const sec = (typeof h.durationSec === 'number' && h.durationSec > 0) ? h.durationSec : 0;
      if (sec > 0) { totalSeconds += sec; slaCount++; }
    }
  });

  const legend = document.getElementById("statusLegend");
  if (legend) {
    legend.innerHTML = `
      <div class="legend-item"><span style="background:#0f5132"></span>Conclu√≠das: ${countDone}</div>
      <div class="legend-item"><span style="background:#f9a825"></span>Parciais: ${countPartial}</div>
    `;
  }

  const slaEl = document.getElementById("slaValue");
  if (slaEl) slaEl.innerText = slaCount > 0 ? formatSeconds(Math.floor(totalSeconds / slaCount)) : "00h 00m 00s";

  if (document.getElementById('chartStatus')) updateStatusChart(countDone, countPartial);
  if (document.getElementById('chartRanking')) updateRankingChart(rankingMap);
  if (document.getElementById('chartMotivos')) updateMotivosChart(motivosMap);
}

function filterHistoryForKpi() {
  const dateStart = document.getElementById('kpiDateStart').value;
  const dateEnd = document.getElementById('kpiDateEnd').value;
  const typeFilter = document.getElementById('kpiFilter').value;
  const analistaFilter = document.getElementById('kpiAnalista').value;
  const statusFilter = document.getElementById('kpiStatus').value;
  const prioFilter = document.getElementById('kpiPrioridade').value;

  return history.filter(h => {
    if (dateStart || dateEnd) {
      const hDate = parseDatePTBR(h.data);
      if (!hDate) return false;
      if (dateStart && hDate < parseDateInput(dateStart)) return false;
      if (dateEnd && hDate > parseDateInput(dateEnd)) return false;
    }
    if (typeFilter === 'pc' && (h.type === 'analistas' || h.type === 'inventario' || h.type === 'devolucao')) return false;
    if (typeFilter === 'analistas' && (!h.type || h.type === 'pc' || h.type === 'inventario' || h.type === 'devolucao')) return false;
    if (typeFilter === 'inventario' && h.type !== 'inventario') return false;
    if (typeFilter === 'devolucao' && h.type !== 'devolucao') return false;

    if (analistaFilter && h.analista !== analistaFilter) return false;
    if (statusFilter === 'done' && h.status !== 'Conclu√≠do') return false;
    if (statusFilter === 'partial' && h.status !== 'Parcial') return false;
    if (prioFilter !== 'all' && h.prioridade !== prioFilter) return false;
    return true;
  });
}

function updateStatusChart(done, partial) {
  const ctx = document.getElementById('chartStatus');
  if (!ctx) return;
  if (chartStatus) chartStatus.destroy();
  chartStatus = new Chart(ctx, {
    type: 'doughnut',
    data: { labels: ['Conclu√≠das', 'Parciais'], datasets: [{ data: [done, partial], backgroundColor: ['#0f5132', '#f9a825'] }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
  });
}

function updateRankingChart(rankingMap) {
  const ctx = document.getElementById('chartRanking');
  if (!ctx) return;
  const sorted = Object.entries(rankingMap).sort((a,b) => b[1]-a[1]);
  if (chartRanking) chartRanking.destroy();
  chartRanking = new Chart(ctx, {
    type: 'bar',
    data: { labels: sorted.map(x => x[0]), datasets: [{ label: 'Tarefas', data: sorted.map(x => x[1]), backgroundColor: '#7A1417' }] },
    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { stepSize: 1 } } } }
  });
}

function updateMotivosChart(motivosMap) {
  const ctx = document.getElementById('chartMotivos');
  if (!ctx) return;
  const sorted = Object.entries(motivosMap).sort((a,b) => b[1]-a[1]);
  if (chartMotivos) chartMotivos.destroy();

  if (!sorted.length) {
    chartMotivos = new Chart(ctx, {
      type: 'pie',
      data: { labels: ['Sem dados'], datasets: [{ data: [1], backgroundColor: ['#e0e0e0'] }] },
      options: { responsive: true, maintainAspectRatio: false }
    });
  } else {
    chartMotivos = new Chart(ctx, {
      type: 'pie',
      data: { labels: sorted.map(x => x[0]), datasets: [{ data: sorted.map(x => x[1]), backgroundColor: ['#dc3545', '#ffc107', '#6c757d', '#17a2b8', '#8e44ad', '#2ecc71'] }] },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }
}

async function exportKpiDashboardToExcel() {
  if (!isPrivileged()) { showToast('Acesso negado', 'error'); return; }
  const filteredHistory = filterHistoryForKpi();
  if (!filteredHistory.length) { showToast('Sem dados para exportar (filtros atuais)', 'warning'); return; }

  try {
    showToast('Exportando dashboard KPI...', 'success');

    let countDone = 0, countPartial = 0;
    let totalSeconds = 0, slaCount = 0;

    filteredHistory.forEach(h => {
      if (h.status === 'Conclu√≠do') countDone++;
      else if (h.status === 'Parcial') countPartial++;

      if (h.status === 'Conclu√≠do') {
        const sec = (typeof h.durationSec === 'number' && h.durationSec > 0) ? h.durationSec : 0;
        if (sec > 0) { totalSeconds += sec; slaCount++; }
      }
    });

    const avgSeconds = slaCount > 0 ? Math.floor(totalSeconds / slaCount) : 0;

    const wb = new ExcelJS.Workbook();
    wb.creator = 'Minerva Foods - Rotinas Estoque';
    wb.created = new Date();

    const wsResumo = wb.addWorksheet('Resumo KPI');
    wsResumo.columns = [{ header: 'M√©trica', key: 'k', width: 30 }, { header: 'Valor', key: 'v', width: 30 }];
    wsResumo.getRow(1).fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FF7A1417' } };
    wsResumo.getRow(1).font = { bold:true, color:{ argb:'FFFFFFFF' } };

    wsResumo.addRow({ k: 'Conclu√≠das', v: countDone });
    wsResumo.addRow({ k: 'Parciais', v: countPartial });
    wsResumo.addRow({ k: 'SLA M√©dio (segundos)', v: avgSeconds });
    wsResumo.addRow({ k: 'SLA M√©dio (hh mm ss)', v: formatSeconds(avgSeconds) });

    const buffer = await wb.xlsx.writeBuffer();
    saveAs(new Blob([buffer], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }),
      `KPI_${TODAY_STR.replace(/\//g,'-')}.xlsx`);
  } catch (e) {
    console.error(e);
    showToast('Erro ao exportar KPI', 'error');
  }
}

/* ===========================
   HELPERS
=========================== */
function formatSeconds(total) {
  const t = Math.max(0, Math.floor(total || 0));
  const h = Math.floor(t / 3600);
  const m = Math.floor((t % 3600) / 60);
  const s = Math.floor(t % 60);
  return `${h.toString().padStart(2,'0')}h ${m.toString().padStart(2,'0')}m ${s.toString().padStart(2,'0')}s`;
}
function parseDatePTBR(str) {
  if (!str) return null;
  const parts = String(str).split('/');
  if (parts.length !== 3) return null;
  return new Date(parts[2], parts[1] - 1, parts[0]);
}
function parseDateInput(str) {
  if (!str) return null;
  const parts = String(str).split('-');
  if (parts.length !== 3) return null;
  return new Date(parts[0], parts[1] - 1, parts[2]);
}
function escapeHtml(s) {
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

/* ===========================
   LOGICA MOBILE GEST√ÉO
=========================== */
let mobileTypeFilter = { pc: false, analistas: false, inventario: false, devolucao: false }; // INICIA ZERADO (FALSE)
let mobileStatusFilter = 'running'; // running | pending | done

function toggleMobileType(type) {
  if (!mobileTypeFilter || typeof mobileTypeFilter !== 'object') {
    mobileTypeFilter = { pc: false, analistas: false, inventario: false, devolucao: false };
  }
  if (type !== 'pc' && type !== 'analistas' && type !== 'inventario' && type !== 'devolucao') return;

  mobileTypeFilter[type] = !mobileTypeFilter[type];
  renderMobileDashboard();
}

function setMobileTypeAll() {
  mobileTypeFilter.pc = true;
  mobileTypeFilter.analistas = true;
  mobileTypeFilter.inventario = true;
  mobileTypeFilter.devolucao = true;
  renderMobileDashboard();
}

function setMobileStatusFilter(status) {
  if (!status) return;
  if (!['running','pending','done'].includes(status)) return;
  mobileStatusFilter = status;
  renderMobileDashboard();
}

function updateMobileButtonsUI() {
  const pcBtn = document.getElementById('mobTypePcBtn');
  const anBtn = document.getElementById('mobTypeAnalistasBtn');
  const invBtn = document.getElementById('mobTypeInventarioBtn');
  const devBtn = document.getElementById('mobTypeDevolucaoBtn');

  if (pcBtn) pcBtn.classList.toggle('active', !!mobileTypeFilter.pc);
  if (anBtn) anBtn.classList.toggle('active', !!mobileTypeFilter.analistas);
  if (invBtn) invBtn.classList.toggle('active', !!mobileTypeFilter.inventario);
  if (devBtn) devBtn.classList.toggle('active', !!mobileTypeFilter.devolucao);

  const bRun = document.getElementById('mobStatusRunningBtn');
  const bPen = document.getElementById('mobStatusPendingBtn');
  const bDon = document.getElementById('mobStatusDoneBtn');

  if (bRun) {
    bRun.classList.toggle('active', mobileStatusFilter === 'running');
    bRun.classList.toggle('status-running', mobileStatusFilter === 'running');
    bRun.classList.toggle('status-pending', false);
    bRun.classList.toggle('status-done', false);
  }
  if (bPen) {
    bPen.classList.toggle('active', mobileStatusFilter === 'pending');
    bPen.classList.toggle('status-running', false);
    bPen.classList.toggle('status-pending', mobileStatusFilter === 'pending');
    bPen.classList.toggle('status-done', false);
  }
  if (bDon) {
    bDon.classList.toggle('active', mobileStatusFilter === 'done');
    bDon.classList.toggle('status-running', false);
    bDon.classList.toggle('status-pending', false);
    bDon.classList.toggle('status-done', mobileStatusFilter === 'done');
  }

  const secRun = document.getElementById('mobileRunningSection');
  const secPen = document.getElementById('mobilePendingSection');
  const secDon = document.getElementById('mobileDoneSection');

  if (secRun) secRun.style.display = (mobileStatusFilter === 'running') ? 'block' : 'none';
  if (secPen) secPen.style.display = (mobileStatusFilter === 'pending') ? 'block' : 'none';
  if (secDon) secDon.style.display = (mobileStatusFilter === 'done') ? 'block' : 'none';
}

function includeItemByContextForMobile(item) {
  if (!item || !item.context) return false;
  if (item.context === 'pc' && mobileTypeFilter.pc) return true;
  if (item.context === 'analistas' && mobileTypeFilter.analistas) return true;
  if (item.context === 'inventario' && mobileTypeFilter.inventario) return true;
  if (item.context === 'devolucao' && mobileTypeFilter.devolucao) return true;
  return false;
}

function renderMobileDashboard() {
  if (mobileTimerInterval) {
    clearInterval(mobileTimerInterval);
    mobileTimerInterval = null;
  }

  ensureOrderIndex(rotinasPC);
  ensureOrderIndex(rotinasAnalistas);
  ensureOrderIndex(rotinasInventario);
  ensureOrderIndex(rotinasDevolucao);

  // Contagem de "quantas rotinas" existem de cada tipo (total)
  const totalPc = Array.isArray(rotinasPC) ? rotinasPC.length : 0;
  const totalAn = Array.isArray(rotinasAnalistas) ? rotinasAnalistas.length : 0;
  const totalInv = Array.isArray(rotinasInventario) ? rotinasInventario.length : 0;
  const totalDev = Array.isArray(rotinasDevolucao) ? rotinasDevolucao.length : 0;

  const countPcEl = document.getElementById('mobCountPc');
  const countAnEl = document.getElementById('mobCountAnalistas');
  const countInvEl = document.getElementById('mobCountInventario');
  const countDevEl = document.getElementById('mobCountDevolucao');

  if (countPcEl) countPcEl.textContent = `${totalPc} rotinas`;
  if (countAnEl) countAnEl.textContent = `${totalAn} rotinas`;
  if (countInvEl) countInvEl.textContent = `${totalInv} rotinas`;
  if (countDevEl) countDevEl.textContent = `${totalDev} rotinas`;

  const pcItems = (rotinasPC || []).map((item, index) => ({ ...item, context: 'pc', realIndex: index }));
  const analistItems = (rotinasAnalistas || []).map((item, index) => ({ ...item, context: 'analistas', realIndex: index }));
  const invItems = (rotinasInventario || []).map((item, index) => ({ ...item, context: 'inventario', realIndex: index }));
  const devItems = (rotinasDevolucao || []).map((item, index) => ({ ...item, context: 'devolucao', realIndex: index }));

  // Junta e aplica filtro por tipo (pc/analistas/inventario/devolucao)
  let allItems = [...pcItems, ...analistItems, ...invItems, ...devItems].filter(includeItemByContextForMobile);

  const runningItems = allItems.filter(item => item.status === 'in_progress');
  const pendingItems = allItems.filter(item => item.status === 'pending');
  const doneItems = allItems.filter(item => (item.status === 'done' || item.status === 'partial'));

  // KPIs
  const kpiRun = document.getElementById('mobKpiRunning');
  const kpiPend = document.getElementById('mobKpiPending');
  const kpiDone = document.getElementById('mobKpiDone');

  if (kpiRun) kpiRun.textContent = runningItems.length;
  if (kpiPend) kpiPend.textContent = pendingItems.length;
  if (kpiDone) kpiDone.textContent = doneItems.length;

  // Atualiza UI de bot√µes
  updateMobileButtonsUI();

  // Verifica se n√£o h√° NENHUM filtro ativo
  const noFilterActive = (!mobileTypeFilter.pc && !mobileTypeFilter.analistas && !mobileTypeFilter.inventario && !mobileTypeFilter.devolucao);

  // --- RENDER RUNNING ---
  const runningContainer = document.getElementById('mobileRunningContainer');
  if (runningContainer) {
    runningContainer.innerHTML = '';
    if (mobileStatusFilter === 'running') {
      if (noFilterActive) {
         runningContainer.innerHTML = '<div style="padding:15px; text-align:center; color:#666; font-style:italic;">Selecione uma categoria acima para ver as tarefas.</div>';
      } else if (runningItems.length === 0) {
        runningContainer.innerHTML = '<div style="padding:15px; color:#666; font-style:italic;">Nenhuma tarefa em execu√ß√£o no momento.</div>';
      } else {
        runningItems.sort((a,b) => (a.inicioTs || 0) - (b.inicioTs || 0));

        runningItems.forEach(item => {
          const initials = item.analista ? item.analista.split(' ').map(n=>n[0]).join('').slice(0,2) : '??';
          const startTs = item.inicioTs || Date.now();

          let ctxLabel = 'OPER';
          if(item.context === 'analistas') ctxLabel = 'ANALISTA';
          if(item.context === 'inventario') ctxLabel = 'INVENT√ÅRIO';
          if(item.context === 'devolucao') ctxLabel = 'DEVOLU√á√ÉO';

          runningContainer.innerHTML += `
            <div class="mob-running-card">
              <div class="mob-running-header">
                <div class="mob-running-title">${escapeHtml(item.nome)}</div>
                <div style="font-size:10px; color:#666; font-weight:bold;">${ctxLabel}</div>
              </div>

              <div class="mob-analyst-row">
                <div class="mob-avatar-icon">${escapeHtml(initials)}</div>
                <div class="mob-analyst-name">${escapeHtml(item.analista || '-')}</div>
              </div>

              <div class="mob-timer-row">
                <div>In√≠cio: <strong>${escapeHtml(item.inicio || '--:--')}</strong></div>
                <div class="mob-live-timer" data-start-ts="${startTs}">00:00:00</div>
              </div>
            </div>
          `;
        });

        updateMobileTimers();
        mobileTimerInterval = setInterval(updateMobileTimers, 1000);
      }
    }
  }

  // --- RENDER PENDING ---
  const pendingContainer = document.getElementById('mobilePendingContainer');
  if (pendingContainer) {
    pendingContainer.innerHTML = '';

    if (mobileStatusFilter === 'pending') {
      if (noFilterActive) {
         pendingContainer.innerHTML = '<div style="padding:15px; text-align:center; color:#999;">Selecione uma categoria acima para ver as tarefas.</div>';
      } else if (pendingItems.length === 0) {
        pendingContainer.innerHTML = '<div style="padding:15px; text-align:center; color:#999;">Fila zerada!</div>';
      } else {
        pendingItems.sort((a,b) => {
          const pA = PRIORITY_ORDER[a.prioridade] ?? 99;
          const pB = PRIORITY_ORDER[b.prioridade] ?? 99;
          if (pA !== pB) return pA - pB;
          return (a.orderIndex||0) - (b.orderIndex||0);
        });

        pendingItems.forEach(item => {
          let dotClass = 'bg-prio-media';
          if(item.prioridade === 'alta') dotClass = 'bg-prio-alta';
          if(item.prioridade === 'baixa') dotClass = 'bg-prio-baixa';

          let ctxLabel = 'Operacional';
          if(item.context === 'analistas') ctxLabel = 'Analista';
          if(item.context === 'inventario') ctxLabel = 'Invent√°rio';
          if(item.context === 'devolucao') ctxLabel = 'Devolu√ß√£o';

          pendingContainer.innerHTML += `
            <div class="mob-pending-item">
              <div class="mob-pending-left">
                <div class="mob-prio-dot ${dotClass}"></div>
                <div>
                  <div class="mob-pending-name">${escapeHtml(item.nome)}</div>
                  <div class="mob-pending-ctx">${ctxLabel}</div>
                </div>
              </div>
            </div>
          `;
        });
      }
    }
  }

  // --- RENDER DONE ---
  const doneContainer = document.getElementById('mobileDoneContainer');
  if (doneContainer) {
    doneContainer.innerHTML = '';

    if (mobileStatusFilter === 'done') {
      if (noFilterActive) {
         doneContainer.innerHTML = '<div style="padding:15px; text-align:center; color:#999;">Selecione uma categoria acima para ver as tarefas.</div>';
      } else if (!doneItems.length) {
        doneContainer.innerHTML = '<div style="padding:15px; text-align:center; color:#999;">Nenhuma rotina conclu√≠da.</div>';
      } else {
        const sorted = doneItems.slice().sort((a,b) => (b.fimTs || 0) - (a.fimTs || 0));

        doneContainer.innerHTML = sorted.map(item => {
          let ctxPill;
          if (item.context === 'pc') ctxPill = `<span class="mob-pill ctx-pc">OPER</span>`;
          else if (item.context === 'analistas') ctxPill = `<span class="mob-pill ctx-an">ANALISTA</span>`;
          else if (item.context === 'inventario') ctxPill = `<span class="mob-pill ctx-inv">INV</span>`;
          else ctxPill = `<span class="mob-pill ctx-dev">DEV</span>`;

          const stPill = (item.status === 'partial') ? `<span class="mob-pill partial">PARCIAL</span>` : `<span class="mob-pill done">CONCLU√çDO</span>`;

          const percent = (item.status === 'partial' && item.percent)
            ? (String(item.percent).includes('%') ? String(item.percent) : (String(item.percent) + '%'))
            : '';

          const motivo = item.lastMotivo || (item.status === 'partial' ? 'PARCIAL' : 'CONCLU√çDO');

          return `
            <div class="mob-done-item">
              <div class="mob-done-top">
                <div class="mob-done-title">${escapeHtml(item.nome || '-')}</div>
                <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;">
                  ${ctxPill}
                  ${stPill}
                </div>
              </div>

              <div class="mob-done-meta">
                <span>üë§ ${escapeHtml(item.analista || '-')}</span>
                <span>‚è± ${escapeHtml(item.duracao || '-')}</span>
                <span>üïí ${escapeHtml(item.inicio || '--:--')} ‚Üí ${escapeHtml(item.fim || '--:--')}</span>
                ${percent ? `<span>üìå ${escapeHtml(percent)}</span>` : ``}
              </div>

              <div class="mob-done-bottom">
                <div><span class="mob-done-strong">Motivo:</span> ${escapeHtml(motivo)}</div>
                <div style="color:#6b7280;font-weight:700;">${escapeHtml(item.prioridade || '')}</div>
              </div>
            </div>
          `;
        }).join('');
      }
    }
  }

  updateMobileButtonsUI();
}

function updateMobileTimers() {
  const timers = document.querySelectorAll('.mob-live-timer');
  const now = Date.now();

  timers.forEach(el => {
    const start = parseInt(el.getAttribute('data-start-ts')) || now;
    const diff = Math.floor((now - start) / 1000);

    const h = Math.floor(diff / 3600);
    const m = Math.floor((diff % 3600) / 60);
    const s = Math.floor(diff % 60);

    el.textContent =
      (h > 0 ? h.toString().padStart(2,'0') + 'h ' : '') +
      m.toString().padStart(2,'0') + 'm ' +
      s.toString().padStart(2,'0') + 's';

    if(h >= 1) el.style.color = '#d32f2f';
  });
}





/* ===========================
   AUDITORIA POSI√á√ÉO ‚Äì FIREBASE + HIST√ìRICO + TRAVA OK/NOK
   Regras:
   - Lista fixa salva no Firestore (importa√ß√£o somente Admin/Master).
   - Mobile-first: 1 c√¢mara por vez.
   - Ao marcar OK/NOK: trava e n√£o permite altera√ß√£o.
   - Bot√£o LIMPAR: reseta marca√ß√µes do sorteio atual (c√¢mara selecionada).
   - Hist√≥rico salvo no Firestore ao concluir (todas as posi√ß√µes sorteadas marcadas).

   TXT recomendado: CAMARA;POSICAO;NIVEL;CONSERVACAO
   CONSERVACAO: RESFRIADO | CONGELADO | AMBOS
=========================== */

const COLL_AUDIT_POS = 'audit_positions';
const COLL_AUDIT_RUNS = 'audit_runs';

let auditPositionsByCamera = {}; // { '01': [ {camera, position, level, conservation, raw} ] }
let auditStateByCamera = {};     // { '01': { 'POS': {locked:true, status:'ok'|'nok'|''} } }
let auditLastDrawByCamera = {};  // { '01': [entry,...] }
let auditInitialized = false;
let auditDailySummary = { total: 0, ok: 0, nok: 0, pct: 0, loaded: false };
let auditLastImportedText = '';

function auditNormalizeCamera(cam){
  const n = String(cam || '').replace(/[^0-9]/g,'');
  if (!n) return '';
  return n.padStart(2,'0');
}

function auditNormalizeCons(v){
  const s = String(v || '').trim().toUpperCase();
  if (!s) return 'AMBOS';
  if (s.includes('CONG')) return 'CONGELADO';
  if (s.includes('RESF')) return 'RESFRIADO';
  if (s.includes('AMB')) return 'AMBOS';
  if (s === 'CONGELADO' || s === 'RESFRIADO' || s === 'AMBOS') return s;
  return 'AMBOS';
}

function auditParseLevel(token){
  const t = String(token || '').trim();
  if (!t) return null;
  const m = t.match(/(nivel|n)\s*0*([0-9]+)/i) || t.match(/\b0*([0-9]+)\b/);
  if (!m) return null;
  const v = parseInt(m[m.length-1], 10);
  return Number.isFinite(v) ? v : null;
}

function auditTryInferCamera(raw){
  const s = String(raw || '').toUpperCase();
  let m = s.match(/CAM(ARA)?\s*0*([0-9]{1,2})/i);
  if (m) return auditNormalizeCamera(m[2]);
  m = s.match(/\bC\s*0*([0-9]{1,2})\b/i);
  if (m) return auditNormalizeCamera(m[1]);
  m = s.match(/^\s*0*([0-9]{1,2})\b/);
  if (m) return auditNormalizeCamera(m[1]);
  return '';
}

function auditTryInferLevel(raw){
  const s = String(raw || '').toUpperCase();
  let m = s.match(/NIVEL\s*0*([0-9]+)/i);
  if (m) return parseInt(m[1],10);
  m = s.match(/\bN\s*0*([0-9]+)\b/i);
  if (m) return parseInt(m[1],10);
  m = s.match(/\b([0-9]{1,2})\b\s*$/);
  if (m) return parseInt(m[1],10);
  return null;
}

function auditParseLines(text){
  const lines = String(text || '')
    .replace(/\r/g,'')
    .split('\n')
    .map(l => l.trim())
    .filter(Boolean);

  const out = [];
  for (const line of lines){
    let parts = line.split(';');
    if (parts.length < 4) parts = line.split('\t');
    if (parts.length < 4) parts = line.split(',');

    let cam = '';
    let pos = '';
    let lvl = null;
    let cons = 'AMBOS';

    if (parts.length >= 4){
      cam = auditNormalizeCamera(parts[0]);
      pos = String(parts[1] || '').trim();
      lvl = auditParseLevel(parts[2]);
      cons = auditNormalizeCons(parts[3]);
    } else if (parts.length == 3){
      cam = auditNormalizeCamera(parts[0]);
      pos = String(parts[1] || '').trim();
      lvl = auditParseLevel(parts[2]);
      cons = 'AMBOS';
    } else if (parts.length == 2){
      cam = auditNormalizeCamera(parts[0]) || auditTryInferCamera(line);
      pos = String(parts[1] || '').trim();
      lvl = auditTryInferLevel(line);
      cons = 'AMBOS';
    } else {
      cam = auditTryInferCamera(line);
      pos = line;
      lvl = auditTryInferLevel(line);
      cons = 'AMBOS';
    }

    if (!cam) continue;
    if (!pos) pos = line;
    if (!Number.isFinite(lvl)) lvl = null;

    out.push({ camera: cam, position: pos, level: lvl, conservation: cons, raw: line });
  }
  return out;
}

function auditIngestLocal(text){
  const entries = auditParseLines(text);
  if (!entries.length){
    showToast('Nenhuma posi√ß√£o v√°lida encontrada no TXT.', 'warning');
    return { entries: [], byCamera: {} };
  }

  const byCamera = {};
  for (const e of entries){
    if (!byCamera[e.camera]) byCamera[e.camera] = [];
    const exists = byCamera[e.camera].some(x => x.position === e.position);
    if (!exists) byCamera[e.camera].push(e);
  }

  showToast(`Lista carregada: ${entries.length} linhas processadas.`, 'success');
  return { entries, byCamera };
}

function auditUpdateCameraSelect(){
  const sel = document.getElementById('auditCameraSelect');
  const hint = document.getElementById('auditCameraHint');
  const histSel = document.getElementById('auditHistCamera');
  if (!sel || !hint) return;

  const cams = Object.keys(auditPositionsByCamera).sort();
  if (!cams.length){
    hint.textContent = 'Carregue a lista para habilitar as c√¢maras dispon√≠veis.';
    return;
  }

  hint.textContent = `C√¢maras dispon√≠veis: ${cams.map(c => 'C√¢mara ' + c).join(', ')}`;

  const current = sel.value;
  sel.innerHTML = '';
  for (const c of cams){
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = `C√¢mara ${c}`;
    sel.appendChild(opt);
  }
  if (cams.includes(current)) sel.value = current;

  if (histSel){
    const hCurrent = histSel.value;
    histSel.innerHTML = '';
    const all = document.createElement('option');
    all.value = 'ALL';
    all.textContent = 'Todas';
    histSel.appendChild(all);
    for (const c of cams){
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = `C√¢mara ${c}`;
      histSel.appendChild(opt);
    }
    if ([...histSel.options].some(o => o.value === hCurrent)) histSel.value = hCurrent;
  }
}

function auditGetFilters(){
  const cam = auditNormalizeCamera(document.getElementById('auditCameraSelect')?.value);
  const qty = parseInt(document.getElementById('auditQty')?.value || '10', 10) || 10;
  const levelMode = document.getElementById('auditNivelSelect')?.value || '1';
  const cons = auditNormalizeCons(document.getElementById('auditConsSelect')?.value || 'AMBOS');
  return { cam, qty, levelMode, cons };
}

function auditFilterList(list, levelMode, cons){
  let out = list.slice();
  if (levelMode === '1') out = out.filter(x => (x.level ?? 1) === 1);
  if (levelMode === 'gt1') out = out.filter(x => (x.level ?? 1) > 1);
  if (cons !== 'AMBOS'){
    out = out.filter(x => (auditNormalizeCons(x.conservation) === cons) || (auditNormalizeCons(x.conservation) === 'AMBOS'));
  }
  return out;
}

function auditShuffle(arr){
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function auditEnsureState(cam, pos){
  if (!auditStateByCamera[cam]) auditStateByCamera[cam] = {};
  if (!auditStateByCamera[cam][pos]) auditStateByCamera[cam][pos] = { locked:false, status:'' };
}

function auditDraw(){
  const { cam, qty, levelMode, cons } = auditGetFilters();
  const all = auditPositionsByCamera[cam] || [];

  if (!all.length){
    showToast('Esta c√¢mara ainda n√£o tem posi√ß√µes carregadas no Firebase.', 'warning');
    return;
  }

  const filtered = auditFilterList(all, levelMode, cons);
  if (!filtered.length){
    showToast('Nenhuma posi√ß√£o dispon√≠vel para os filtros selecionados.', 'warning');
    return;
  }

  const picked = auditShuffle(filtered).slice(0, Math.min(qty, filtered.length));
  auditLastDrawByCamera[cam] = picked;

  for (const e of picked) auditEnsureState(cam, e.position);

  showToast(`Sorteio realizado: ${picked.length} posi√ß√µes (C√¢mara ${cam}).`, 'success');
  auditRender();
}

function auditEnsureDrawForCurrentCamera(){
  const { cam } = auditGetFilters();
  const existing = auditLastDrawByCamera[cam] || [];
  // se j√° existe sorteio para a c√¢mara, apenas renderiza
  if (existing.length){ auditRender(); return; }
  // se n√£o existe, sorteia automaticamente com os filtros atuais
  auditDraw();
}

function auditClearMarksCurrentCamera(){
  const cam = auditNormalizeCamera(document.getElementById('auditCameraSelect')?.value);
  const draw = auditLastDrawByCamera[cam] || [];
  for (const e of draw){
    auditEnsureState(cam, e.position);
    auditStateByCamera[cam][e.position] = { locked:false, status:'' };
  }
  showToast(`Marca√ß√µes limpas (C√¢mara ${cam}).`, 'info');
  auditRender();
}

function auditLock(cam, pos, status){
  auditEnsureState(cam, pos);
  if (auditStateByCamera[cam][pos].locked) return false;
  auditStateByCamera[cam][pos].locked = true;
  auditStateByCamera[cam][pos].status = status;
  return true;
}

function auditComputeDrawKpis(){
  const { cam } = auditGetFilters();
  const draw = auditLastDrawByCamera[cam] || [];
  let ok = 0, nok = 0, audited = 0;
  for (const e of draw){
    const st = auditStateByCamera?.[cam]?.[e.position];
    if (!st?.locked) continue;
    audited++;
    if (st.status === 'ok') ok++;
    if (st.status === 'nok') nok++;
  }
  const total = draw.length;
  const pct = total ? Math.round((ok / total) * 100) : 0;
  return { total, audited, ok, nok, pct };
}

function auditRender(){
  const listEl = document.getElementById('auditResults');
  const metaEl = document.getElementById('auditColMeta');
  if (!listEl || !metaEl) return;

  const { cam } = auditGetFilters();
  const draw = auditLastDrawByCamera[cam] || [];

  const { total, audited, ok, nok, pct } = auditComputeDrawKpis();  // KPIs (DASH DO DIA - TODAS AS C√ÇMARAS)
  const d = auditDailySummary || { total: 0, ok: 0, nok: 0, pct: 0 };
  const elT = document.getElementById('auditKpiTotal');
  const elO = document.getElementById('auditKpiOk');
  const elN = document.getElementById('auditKpiNok');
  const elP = document.getElementById('auditKpiPct');
  if (elT) elT.textContent = String(d.total || 0);
  if (elO) elO.textContent = String(d.ok || 0);
  if (elN) elN.textContent = String(d.nok || 0);
  if (elP) elP.textContent = `${d.pct || 0}%`;

  metaEl.textContent = `${pct}% (${ok}/${total || 0}) ¬∑ Auditadas: ${audited}/${total || 0}`;

  listEl.innerHTML = '';
  if (!draw.length){
    listEl.innerHTML = '<div style="color:#6b7280;font-size:12px;padding:6px 2px;">Nenhum sorteio ainda. Clique em <b>NOVO SORTEIO</b>.</div>';
    return;
  }

  draw.forEach((e, idx) => {
    auditEnsureState(cam, e.position);
    const st = auditStateByCamera[cam][e.position];

    const row = document.createElement('div');
    row.className = 'audit-row' + (st.locked ? ' audit-locked' : '');
    row.dataset.camera = cam;
    row.dataset.position = e.position;
    row.dataset.status = (st.status || '');

    const left = document.createElement('div');
    left.className = 'audit-row-left';

    const pos = document.createElement('div');
    pos.className = 'audit-pos';
    pos.textContent = `${String(idx+1).padStart(2,'0')} ¬∑ ${e.position}`;

    const sub = document.createElement('div');
    sub.className = 'audit-sub';

    const pillLvl = document.createElement('span');
    pillLvl.className = 'pill';
    pillLvl.textContent = `N√≠vel ${Number.isFinite(e.level) ? e.level : '-'}`;

    const pillCons = document.createElement('span');
    pillCons.className = 'pill';
    pillCons.textContent = auditNormalizeCons(e.conservation);

    sub.appendChild(pillLvl);
    sub.appendChild(pillCons);

    left.appendChild(pos);
    left.appendChild(sub);

    const acts = document.createElement('div');
    acts.className = 'audit-actions';

    const okBtn = document.createElement('button');
    okBtn.type = 'button';
    okBtn.className = 'audit-act audit-ok';
    okBtn.textContent = 'OK';
    okBtn.dataset.action = 'ok';

    const nokBtn = document.createElement('button');
    nokBtn.type = 'button';
    nokBtn.className = 'audit-act audit-nok';
    nokBtn.textContent = 'NOK';
    nokBtn.dataset.action = 'nok';

    if (st.locked){
      okBtn.disabled = true;
      nokBtn.disabled = true;
    }

    acts.appendChild(okBtn);
    acts.appendChild(nokBtn);

    row.appendChild(left);
    row.appendChild(acts);

    listEl.appendChild(row);
  });
}

function auditIsAdminOrMaster(){
  return (currentUserRole === 'master') || (typeof isPrivileged === 'function' && isPrivileged());
}

async function auditLoadPositionsFromFirestore(){
  try{
    auditPositionsByCamera = {};
    const snap = await db.collection(COLL_AUDIT_POS).get();
    snap.forEach(doc => {
      const d = doc.data() || {};
      const cam = auditNormalizeCamera(d.camera);
      if (!cam) return;
      if (!auditPositionsByCamera[cam]) auditPositionsByCamera[cam] = [];
      auditPositionsByCamera[cam].push({
        camera: cam,
        position: String(d.position || ''),
        level: Number.isFinite(d.level) ? d.level : (d.level ? parseInt(d.level,10) : null),
        conservation: auditNormalizeCons(d.conservation || 'AMBOS'),
        raw: d.raw || ''
      });
    });

    Object.keys(auditPositionsByCamera).forEach(cam => {
      auditPositionsByCamera[cam].sort((a,b) => String(a.position).localeCompare(String(b.position)));
    });

    auditUpdateCameraSelect();
    showToast('Posi√ß√µes carregadas do Firebase.', 'success');
    auditRender();
  } catch(e){
    console.error(e);
    showToast('Falha ao carregar posi√ß√µes do Firebase.', 'error');
  }
}

async function auditSavePositionsToFirestore(fromText){
  if (!auditIsAdminOrMaster()){
    showToast('Apenas Admin/Master podem importar posi√ß√µes.', 'error');
    return;
  }

  const { entries, byCamera } = auditIngestLocal(fromText);
  if (!entries.length) return;

  try{
    showToast('Salvando no Firebase... (pode levar alguns segundos)', 'info');

    const CHUNK = 450;
    for (let i=0; i<entries.length; i+=CHUNK){
      const chunk = entries.slice(i, i+CHUNK);
      const batch = db.batch();
      chunk.forEach(e => {
        const id = `${e.camera}__${String(e.position).replace(/\//g,'_')}`;
        const ref = db.collection(COLL_AUDIT_POS).doc(id);
        batch.set(ref, {
          camera: e.camera,
          position: e.position,
          level: (e.level ?? null),
          conservation: auditNormalizeCons(e.conservation),
          raw: e.raw || '',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: currentUser?.email || null
        }, { merge: true });
      });
      await batch.commit();
    }

    auditPositionsByCamera = byCamera;
    auditUpdateCameraSelect();
    showToast('Importa√ß√£o conclu√≠da e salva no Firebase.', 'success');
    auditRender();
  } catch(e){
    console.error(e);
    showToast('Falha ao salvar posi√ß√µes no Firebase.', 'error');
  }
}

function auditGetRunSummary(){
  const { cam, levelMode, cons } = auditGetFilters();
  const { total, ok, nok, pct } = auditComputeDrawKpis();
  return {
    camera: cam,
    total,
    ok,
    nok,
    pct,
    filters: { levelMode, conservation: cons }
  };
}

async function auditSaveRunHistory(){
  const sum = auditGetRunSummary();
  if (!sum.total) return;

  try{
    const payload = {
      camera: sum.camera,
      total: sum.total,
      ok: sum.ok,
      nok: sum.nok,
      pct: sum.pct,
      filters: sum.filters,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: currentUser?.email || null,
      createdByName: currentUser?.name || null,
      adminHidden: false
    };
    await db.collection(COLL_AUDIT_RUNS).add(payload);
  } catch(e){
    console.error(e);
  }
}


function auditGetTodayRange(){
  const now = new Date();
  const start = new Date(now);
  start.setHours(0,0,0,0);
  const end = new Date(start);
  end.setDate(end.getDate() + 1);
  return { start, end };
}

async function auditLoadDailySummary(){
  try {
    const { start, end } = auditGetTodayRange();
    let q = db.collection(COLL_AUDIT_RUNS)
      .where('createdAt', '>=', start)
      .where('createdAt', '<', end);
    const snap = await q.get();
    const isMaster = (currentUserRole === 'master');
    let total = 0, ok = 0, nok = 0;
    snap.forEach(doc => {
      const d = doc.data() || {};
      if (!isMaster && d.adminHidden) return;
      total += (parseInt(d.total || 0, 10) || 0);
      ok += (parseInt(d.ok || 0, 10) || 0);
      nok += (parseInt(d.nok || 0, 10) || 0);
    });
    const denom = ok + nok;
    const pct = denom ? Math.round((ok / denom) * 100) : 0;
    auditDailySummary = { total, ok, nok, pct, loaded: true };
    auditRender();
  } catch (e) {
    console.error(e);
    // mant√©m valores antigos
  }
}

function auditRangeToStartDate(range){
  const now = new Date();
  const start = new Date(now);
  if (range === 'today'){
    start.setHours(0,0,0,0);
    return start;
  }
  if (range === '7'){
    start.setDate(start.getDate() - 7);
    return start;
  }
  if (range === '30'){
    start.setDate(start.getDate() - 30);
    return start;
  }
  return null;
}

async function auditLoadHistory(){
  const tableEl = document.getElementById('auditHistoryTable');
  if (!tableEl) return;

  const cam = document.getElementById('auditHistCamera')?.value || 'ALL';
  const range = document.getElementById('auditHistRange')?.value || '7';

  tableEl.innerHTML = '<div style="color:#6b7280;font-size:12px;">Carregando...</div>';

  try{
    let q = db.collection(COLL_AUDIT_RUNS).orderBy('createdAt','desc').limit(200);

    const startDate = auditRangeToStartDate(range);
    if (startDate) q = q.where('createdAt', '>=', startDate);
    if (cam !== 'ALL') q = q.where('camera', '==', auditNormalizeCamera(cam));

    const snap = await q.get();
    const rows = [];
    snap.forEach(doc => {
      const d = doc.data() || {};
      rows.push({
        camera: d.camera || '-',
        total: d.total || 0,
        ok: d.ok || 0,
        nok: d.nok || 0,
        pct: (typeof d.pct === 'number') ? d.pct : 0,
        by: d.createdByName || d.createdBy || '-',
        at: d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null
      });
    });

    
    const isMasterView = (currentUserRole === 'master');
    const visibleRows = isMasterView ? rows : rows.filter(r => !r.adminHidden);
if (!visibleRows.length){
      tableEl.innerHTML = '<div style="color:#6b7280;font-size:12px;">Sem registros para os filtros selecionados.</div>';
      return;
    }

    const fmt = (dt) => {
      if (!dt) return '-';
      const dd = String(dt.getDate()).padStart(2,'0');
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const yy = dt.getFullYear();
      const hh = String(dt.getHours()).padStart(2,'0');
      const mi = String(dt.getMinutes()).padStart(2,'0');
      return `${dd}/${mm}/${yy} ${hh}:${mi}`;
    };

    const htmlTable = [
      '<table class="audit-table">',
      '<thead><tr>',
      '<th>Data/Hora</th><th>Usu√°rio</th><th>C√¢mara</th><th>Sorteadas</th><th>OK</th><th>NOK</th><th>%</th>',
      '</tr></thead><tbody>',
      ...visibleRows.map(r => (
        `<tr>`+
        `<td>${fmt(r.at)}</td>`+
        `<td>${String(r.by).slice(0,40)}</td>`+
        `<td>${r.camera}</td>`+
        `<td>${r.total}</td>`+
        `<td>${r.ok}</td>`+
        `<td>${r.nok}</td>`+
        `<td><b>${r.pct}%</b></td>`+
        `</tr>`
      )),
      '</tbody></table>'
    ].join('');

    tableEl.innerHTML = htmlTable;
  } catch(e){
    console.error(e);
    tableEl.innerHTML = '<div style="color:#6b7280;font-size:12px;">Erro ao carregar hist√≥rico.</div>';
  }
}

function auditExportCurrentToExcel(){
  try{
    const { cam } = auditGetFilters();
    const draw = auditLastDrawByCamera[cam] || [];
    if (!draw.length){
      showToast('Nada para exportar (fa√ßa um sorteio).', 'warning');
      return;
    }

    const wb = new ExcelJS.Workbook();
    const ws = wb.addWorksheet('Auditoria');

    ws.columns = [
      { header: 'C√¢mara', key: 'camera', width: 10 },
      { header: 'Posi√ß√£o', key: 'position', width: 22 },
      { header: 'N√≠vel', key: 'level', width: 10 },
      { header: 'Conserva√ß√£o', key: 'conservation', width: 14 },
      { header: 'Status', key: 'status', width: 10 }
    ];

    draw.forEach(e => {
      const st = auditStateByCamera?.[cam]?.[e.position] || { locked:false, status:'' };
      ws.addRow({
        camera: cam,
        position: e.position,
        level: (Number.isFinite(e.level) ? e.level : ''),
        conservation: auditNormalizeCons(e.conservation),
        status: st.status || ''
      });
    });

    wb.xlsx.writeBuffer().then(buf => {
      saveAs(new Blob([buf]), `Auditoria_Posicao_Camara_${cam}.xlsx`);
      showToast('Excel exportado.', 'success');
    });
  } catch(e){
    console.error(e);
    showToast('Falha ao exportar Excel.', 'error');
  }
}

function auditExportHistoryToExcel(){
  const tableEl = document.querySelector('#auditHistoryTable table');
  if (!tableEl){
    showToast('Nada para exportar no hist√≥rico.', 'warning');
    return;
  }

  const wb = new ExcelJS.Workbook();
  const ws = wb.addWorksheet('Historico');

  const rows = [...tableEl.querySelectorAll('tr')].map(tr => [...tr.querySelectorAll('th,td')].map(td => td.textContent.trim()));
  rows.forEach(r => ws.addRow(r));

  wb.xlsx.writeBuffer().then(buf => {
    saveAs(new Blob([buf]), `Auditoria_Historico.xlsx`);
    showToast('Hist√≥rico exportado.', 'success');
  });
}


async function auditClearHistoryForAdmin(){
  if (!auditIsAdminOrMaster()) { showToast('Acesso negado.', 'error'); return; }

  try {
    const camSel = document.getElementById('auditHistCamera')?.value || 'ALL';
    const range = document.getElementById('auditHistRange')?.value || '7';

    let q = db.collection(COLL_AUDIT_RUNS).orderBy('createdAt','desc').limit(200);
    const startDate = auditRangeToStartDate(range);
    if (startDate) q = q.where('createdAt', '>=', startDate);
    if (camSel !== 'ALL') q = q.where('camera', '==', auditNormalizeCamera(camSel));

    const snap = await q.get();
    if (snap.empty){ showToast('Sem execu√ß√µes para zerar nesse filtro.', 'info'); return; }

    const isMaster = (currentUserRole === 'master');

    const confirmMsg = isMaster
      ? 'Zerar execu√ß√µes (MASTER) vai APAGAR do Firebase para TODO MUNDO. Deseja continuar?'
      : 'Zerar execu√ß√µes vai ocultar os registros para Admin (Master continua vendo). Deseja continuar?';

    if (!confirm(confirmMsg)) return;

    const docs = snap.docs;
    const CHUNK = 450;

    for (let i=0; i<docs.length; i+=CHUNK){
      const batch = db.batch();
      docs.slice(i, i+CHUNK).forEach(d => {
        const ref = db.collection(COLL_AUDIT_RUNS).doc(d.id);
        if (isMaster) {
          batch.delete(ref);
        } else {
          batch.set(ref, {
            adminHidden: true,
            adminHiddenAt: firebase.firestore.FieldValue.serverTimestamp(),
            adminHiddenBy: currentUser?.email || null
          }, { merge: true });
        }
      });
      await batch.commit();
    }

    showToast(isMaster ? 'Execu√ß√µes apagadas (MASTER) para todos.' : 'Execu√ß√µes zeradas para Admin (Master mant√©m hist√≥rico).', 'success');
    await auditLoadHistory();
    await auditLoadDailySummary();
  } catch(e){
    console.error(e);
    showToast('Falha ao zerar execu√ß√µes.', 'error');
  }
}
function auditApplyPermissionsUI(){
  const isAdminOrMaster = auditIsAdminOrMaster();

  // Administra√ß√£o (importa√ß√£o)
  const details = document.getElementById('auditAdminDetails');
  if (details) details.style.display = isAdminOrMaster ? 'block' : 'none';

  // Bot√µes restritos
  const btnDraw = document.getElementById('auditDrawBtn');
  const btnRefresh = document.getElementById('auditRefreshBtn');
  const btnClear = document.getElementById('auditClearBtn');
  [btnDraw, btnRefresh, btnClear].forEach(b => {
    if (!b) return;
    b.style.display = isAdminOrMaster ? 'inline-flex' : 'none';
  });

  // Zerar execu√ß√µes: somente Admin/Master
  const btnZero = document.getElementById('auditHistoryClearBtn');
  if (btnZero) btnZero.style.display = isAdminOrMaster ? 'inline-flex' : 'none';
}

function renderAuditoriaTab(){
  if (!auditInitialized){
    auditInitialized = true;

    // Buttons
    document.getElementById('auditDrawBtn')?.addEventListener('click', auditDraw);
    document.getElementById('auditRefreshBtn')?.addEventListener('click', () => { auditLoadDailySummary(); auditRender(); auditLoadHistory(); });
    document.getElementById('auditExportBtn')?.addEventListener('click', auditExportCurrentToExcel);
    document.getElementById('auditClearBtn')?.addEventListener('click', auditClearMarksCurrentCamera);
    document.getElementById('auditFinalizeBtn')?.addEventListener('click', async () => {
      const { cam } = auditGetFilters();
      const draw = auditLastDrawByCamera[cam] || [];
      if (!draw.length){ showToast('Nenhum sorteio para finalizar.', 'warning'); return; }
      const allLocked = draw.every(e => auditStateByCamera?.[cam]?.[e.position]?.locked);
      if (!allLocked){ showToast('Finalize somente quando TODAS as posi√ß√µes estiverem marcadas (OK/NOK).', 'warning'); return; }
      await auditSaveRunHistory();
      await auditLoadHistory();
      await auditLoadDailySummary();
      const hist = document.getElementById('auditHistoryTable');
      if (hist) hist.scrollIntoView({ behavior: 'smooth', block: 'start' });
      showToast('Execu√ß√£o finalizada e registrada no hist√≥rico.', 'success');
    });


    // Filters
    document.getElementById('auditCameraSelect')?.addEventListener('change', auditEnsureDrawForCurrentCamera);
    document.getElementById('auditQty')?.addEventListener('change', auditRender);
    document.getElementById('auditNivelSelect')?.addEventListener('change', auditRender);
    document.getElementById('auditConsSelect')?.addEventListener('change', auditRender);

    // List click
    document.getElementById('auditResults')?.addEventListener('click', async (ev) => {
      const btn = ev.target && ev.target.closest ? ev.target.closest('button[data-action]') : null;
      if (!btn) return;
      const row = btn.closest('.audit-row');
      if (!row) return;

      const cam = row.dataset.camera;
      const pos = row.dataset.position;
      const action = btn.dataset.action;

      auditEnsureState(cam, pos);
      if (auditStateByCamera[cam][pos].locked) return;

      const changed = auditLock(cam, pos, action);
      if (!changed) return;

      auditRender();
    });

    // Admin import
    const toggle = document.getElementById('auditPasteToggle');
    const pasteBox = document.getElementById('auditPasteBox');
    toggle?.addEventListener('click', () => {
      if (!pasteBox) return;
      pasteBox.style.display = (pasteBox.style.display === 'none' ? 'block' : 'none');
    });

    document.getElementById('auditClearTextBtn')?.addEventListener('click', () => {
      const t = document.getElementById('auditText');
      if (t) t.value = '';
    });

    document.getElementById('auditLoadTextBtn')?.addEventListener('click', () => {
      const t = document.getElementById('auditText');
      const text = t ? t.value : '';
      auditLastImportedText = text;
      const r = auditIngestLocal(text);
      if (Object.keys(r.byCamera).length){
        auditPositionsByCamera = r.byCamera;
        auditUpdateCameraSelect();
        auditRender();
      }
    });

    document.getElementById('auditFile')?.addEventListener('change', (ev) => {
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        const text = String(reader.result || '');
        auditLastImportedText = text;
        const r = auditIngestLocal(text);
        if (Object.keys(r.byCamera).length){
          auditPositionsByCamera = r.byCamera;
          auditUpdateCameraSelect();
          auditRender();
        }
      };
      reader.readAsText(f);
      ev.target.value = '';
    });

    document.getElementById('auditSavePositionsBtn')?.addEventListener('click', () => {
      const t = document.getElementById('auditText');
      const text = (t && t.value && t.value.trim()) ? t.value : (auditLastImportedText || '');
      if (!text){
        showToast('Carregue o TXT (arquivo ou colar texto) antes de salvar no Firebase.', 'warning');
        return;
      }
      auditSavePositionsToFirestore(text);
    });

    // Hist√≥rico
    document.getElementById('auditHistoryReloadBtn')?.addEventListener('click', auditLoadHistory);
    document.getElementById('auditHistoryExportBtn')?.addEventListener('click', auditExportHistoryToExcel);
    document.getElementById('auditHistoryClearBtn')?.addEventListener('click', auditClearHistoryForAdmin);
    document.getElementById('auditHistCamera')?.addEventListener('change', auditLoadHistory);
    document.getElementById('auditHistRange')?.addEventListener('change', auditLoadHistory);
  }

  auditApplyPermissionsUI();
  auditLoadPositionsFromFirestore();
  auditRender();
  auditLoadHistory();
}

/* ===========================
   ONLOAD
=========================== */
window.onload = async function() {
  if (isFirebaseConnected) updateConnectionStatus(true, 'Online - Conectado');
  else updateConnectionStatus(false, 'Offline - Acesso bloqueado');
  enforceOnlineOnlyUI();

  // ----- LOGICA DE AUTO-LOGIN (SESSION STORAGE) -----
  // sessionStorage: s√≥ dura enquanto a aba est√° aberta
  const savedEmail = sessionStorage.getItem('minerva_session_email');
  if (savedEmail) {
    // Esconde form e mostra "Restaurando..."
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('loginLoading').style.display = 'block';
    document.querySelector('#loginLoading p').textContent = "Restaurando sess√£o...";

    try {
      // Carrega permiss√µes e usu√°rios para validar o e-mail salvo
      await loadPermissions();
      await loadUsers();

      const user = usersMap[savedEmail];
      if (user) {
        // Usu√°rio existe, loga direto
        const role = resolveRoleForEmail(savedEmail);
        currentUser = {
          email: savedEmail,
          name: user.name,
          displayRole: displayRoleForRole(role),
          isMaster: (savedEmail === MASTER_EMAIL)
        };
        currentUserRole = role;

        setupUserInterface();
        initializeApp();
      } else {
        // E-mail salvo n√£o existe mais no banco -> reseta
        throw new Error('Usu√°rio salvo n√£o encontrado no banco');
      }
    } catch (e) {
      console.warn('Falha no auto-login:', e);
      sessionStorage.removeItem('minerva_session_email');
      // Volta a exibir login normal
      document.getElementById('loginLoading').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
    }
  }
  // --------------------------------

  updateHeaderProgress();
};

window.addEventListener('beforeunload', () => { destroyRealtimeListeners(); });
</script>
</body>
</html>
