<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Rotinas ‚Äì Estoque | Minerva Foods</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- GR√ÅFICOS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- EXPORT KPI PARA EXCEL (XLSX) -->
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>

<style>
:root {
  --minerva-red: #7A1417;
  --minerva-dark: #4a0c0e;
  --minerva-gold: #C69C6D;

  --bg: #eef1f5;
  --card-bg: #ffffff;
  --text-main: #333;

  --success-bg: #d1e7dd; --success-text: #0f5132;
  --warning-bg: #fff3cd; --warning-text: #664d03;
  --info: #0d6efd;
  --danger: #dc3545;
}

* { box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
body { margin: 0; background: var(--bg); color: var(--text-main); font-size: 13px; }

/* --- HEADER --- */
header {
  background: linear-gradient(135deg, var(--minerva-red) 0%, var(--minerva-dark) 100%);
  color: #fff; padding: 12px 25px;
  display: flex; justify-content: space-between; align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
header h1 { margin: 0; font-weight: 800; font-size: 26px; letter-spacing: 1px; line-height: 1.1; text-transform: uppercase; }
header h2 { margin: 0; font-weight: 400; font-size: 15px; opacity: 0.9; margin-top: 2px; }
.date-display { font-size: 12px; opacity: 0.7; margin-top: 4px; font-weight: 600; }

nav button {
  background: none; border: none; color: rgba(255,255,255,0.7);
  margin-left: 10px; font-size: 13px; cursor: pointer;
  padding: 5px 10px; border-radius: 4px; transition: 0.3s;
}
nav button.active { background: rgba(255,255,255,0.15); color: #fff; font-weight: 600; }

/* --- CONTE√öDO --- */
section { display: none; padding: 15px; width: 99%; max-width: 100%; margin: 0 auto; }
section.active { display: block; }

.card {
  background: var(--card-bg); border-radius: 8px;
  padding: 15px; margin-bottom: 15px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  border-top: 3px solid var(--minerva-red);
}

/* --- KPI --- */
.kpi-filters-container {
  display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;
  background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #ddd;
  margin-bottom: 20px;
}
.filter-group { display: flex; flex-direction: column; gap: 4px; }
.filter-group label { font-size: 11px; font-weight: bold; color: #555; text-transform: uppercase; }
.filter-group select, .filter-group input {
  padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; min-width: 130px;
}
.filter-group button {
  padding: 6px 15px; background: var(--minerva-red); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; height: 30px;
}
.filter-group button:hover { background: var(--minerva-dark); }

.kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.chart-container { position: relative; height: 300px; width: 100%; }
.kpi-card-big { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); border-top: 3px solid var(--minerva-gold); }

.sla-box { text-align: center; padding: 40px; }
.sla-value { font-size: 42px; font-weight: 800; color: var(--minerva-red); }
.sla-label { font-size: 16px; color: #666; text-transform: uppercase; letter-spacing: 1px; }

.status-legend { display: flex; justify-content: center; gap: 15px; margin-top: 10px; font-size: 12px; font-weight: bold; }
.legend-item span { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }

/* --- TAREFAS --- */
.task-header {
  display: grid;
  grid-template-columns: 1.8fr 1fr 0.5fr 1.2fr 0.5fr 0.5fr 0.4fr 1.4fr;
  gap: 8px; padding: 0 8px 8px 8px;
  border-bottom: 2px solid #eee; margin-bottom: 8px;
  font-weight: bold; color: var(--minerva-red); text-transform: uppercase; font-size: 11px;
}
.task {
  display: grid;
  grid-template-columns: 1.8fr 1fr 0.5fr 1.2fr 0.5fr 0.5fr 0.4fr 1.4fr;
  gap: 8px; align-items: center;
  background: #fff; padding: 4px 8px; margin-bottom: 4px;
  border: 1px solid #eee; border-radius: 4px; font-size: 12px;
  transition: background 0.3s;
}
.task:hover { border-color: #ccc; }
.task span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* Badges */
.prio-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: #fff; font-weight: bold; text-align: center; }
.p-alta { background: #dc3545; }
.p-media { background: #ffc107; color: #333; }
.p-baixa { background: #6c757d; }

.task input, .task select {
  padding: 3px 6px; font-size: 11px; border: 1px solid #ccc;
  border-radius: 3px; width: 100%; background: #fff;
}
.task input:focus, .task select:focus { outline: none; border-color: var(--minerva-red); }

.task div { display: flex; gap: 4px; }
.task button { padding: 3px 8px; border: none; border-radius: 3px; font-size: 10px; color: #fff; cursor: pointer; font-weight: 600; text-transform: uppercase; }
.task button:hover { opacity: 0.8; }

button:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(100%); pointer-events: none; }

.start { background: var(--info); }
.finish { background: var(--success-text); }
.partial { background: #e0a800; }
.edit { background: #666; }
.delete { background: var(--danger); }

.row-done { background: var(--success-bg); border-left: 3px solid var(--success-text); color: var(--success-text); }
.row-partial { background: var(--warning-bg); border-left: 3px solid var(--warning-text); color: var(--warning-text); }

/* --- BOT√ïES --- */
.actions-bar { display: flex; gap: 10px; margin-bottom: 15px; }
.primary-btn { background: var(--minerva-red); color: #fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:600; }
.primary-btn:hover { background: #5e0d11; }
.panel-btn { background: #374151; color: #fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:600; }
.panel-btn:hover { background: #1f2937; }
.reset-btn { background: #e0a800; color: #fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:600; }
.reset-btn:hover { background: #d39e00; }
.clear-btn { background: var(--danger); color: #fff; padding:5px 10px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:11px; }
.save-btn { background: #28a745; color: #fff; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-weight:600; width: 100%; margin-top: 10px; }
.save-btn:hover { background: #218838; }
.excel-btn { background: #217346; color: #fff; padding:6px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; font-size:11px; margin-right: 5px; }
.excel-btn:hover { background: #154b2e; }
.kpi-filters-container .excel-btn { height: 30px; }

/* Hist√≥rico */
.history-container { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
.table { width: 100%; border-collapse: collapse; font-size: 12px; }
.table th { background: #fff; position: sticky; top: 0; z-index: 1; text-align: left; padding: 6px 8px; border-bottom: 2px solid #eee; }
.table td { border-bottom: 1px solid #eee; padding: 6px 8px; }

/* Modais */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
.modal h3 { margin-top: 0; color: var(--minerva-red); }
.modal-content input, .modal-content select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }

/* Painel Gerencial */
.panel-section { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
.panel-section:last-child { border-bottom: none; }
.panel-title { font-size: 14px; font-weight: bold; color: var(--text-main); margin-bottom: 10px; }

/* Listas */
.list-container { max-height: 150px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #eee; border-radius: 4px; }
.list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
.list-item:last-child { border-bottom: none; }
.icon-btn { cursor: pointer; padding: 4px 8px; font-size: 12px; margin-left: 5px; border-radius: 3px; border: none; color: #fff; }
.btn-edit { background: #666; }
.btn-del { background: var(--danger); }
.btn-lock { background: #999; cursor: not-allowed; }

/* Password Wrapper */
.pass-wrapper { position: relative; width: 100%; margin-bottom: 10px; }
.pass-wrapper input { width: 100%; padding-right: 35px; margin-bottom: 0; }
.pass-toggle { position: absolute; right: 8px; top: 8px; cursor: pointer; opacity: 0.6; font-size: 14px; background:none; border:none; }
.pass-toggle:hover { opacity: 1; }

/* Permiss√µes */
.perm-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; background: #f4f4f4; padding: 10px; border-radius: 4px; }
.perm-group label { display: flex; align-items: center; font-size: 11px; cursor: pointer; }
.perm-group input { width: auto; margin: 0 5px 0 0; }
</style>
</head>

<body>

<header>
  <div>
    <h1>Minerva Foods</h1>
    <h2>Controle de rotinas Operacionais Estoque</h2>
    <div class="date-display" id="dateDisplay"></div>
  </div>
  <nav>
    <button class="active" onclick="openTab('pc')">ROTINAS OPERACIONAIS</button>
    <button onclick="openTab('analistas')">ROTINAS ANALISTAS</button>
    <button onclick="openTab('kpi')">üìä KPI / DASHBOARD</button>
  </nav>
</header>

<!-- SE√á√ÉO PC -->
<section id="pc" class="active">
  <div class="card">
    <div class="actions-bar">
      <button class="primary-btn" onclick="openModal('pc')">+ NOVA ROTINA</button>
      <button class="panel-btn" onclick="requestAuth('any', () => openManagementPanel('pc'))">‚öôÔ∏è PAINEL GERENCIAL üîí</button>
      <button class="reset-btn" onclick="requestAuth('reset', () => resetRotinas('pc'))">REINICIAR ROTINAS üîí</button>
    </div>

    <div class="task-header">
      <span>Rotina</span>
      <span>Analista</span>
      <span>Prioridade</span>
      <span>Status/Justificativa</span>
      <span>In√≠cio</span>
      <span>Fim</span>
      <span>%</span>
      <span>A√ß√µes</span>
    </div>

    <div id="tasks"></div>
  </div>
</section>

<!-- SE√á√ÉO ANALISTAS -->
<section id="analistas">
  <div class="card">
    <div class="actions-bar">
      <button class="primary-btn" onclick="openModal('analistas')">+ NOVA ROTINA (ANALISTA)</button>
      <button class="panel-btn" onclick="requestAuth('any', () => openManagementPanel('analistas'))">‚öôÔ∏è PAINEL GERENCIAL üîí</button>
      <button class="reset-btn" onclick="requestAuth('reset', () => resetRotinas('analistas'))">REINICIAR ROTINAS üîí</button>
    </div>

    <div class="task-header">
      <span>Rotina</span>
      <span>Analista</span>
      <span>Prioridade</span>
      <span>Status/Justificativa</span>
      <span>In√≠cio</span>
      <span>Fim</span>
      <span>%</span>
      <span>A√ß√µes</span>
    </div>

    <div id="tasksAnalistas"></div>
  </div>
</section>

<!-- SE√á√ÉO KPI -->
<section id="kpi">
  <div class="card">
    <h3 style="margin:0 0 10px 0; color:var(--minerva-red)">Dashboard de Performance</h3>

    <div class="kpi-filters-container">
      <div class="filter-group">
        <label>Data In√≠cio:</label>
        <input type="date" id="kpiDateStart" onchange="updateCharts()">
      </div>
      <div class="filter-group">
        <label>Data Fim:</label>
        <input type="date" id="kpiDateEnd" onchange="updateCharts()">
      </div>
      <div class="filter-group">
        <label>Tipo de Rotina:</label>
        <select id="kpiFilter" onchange="updateCharts()">
          <option value="all">Vis√£o Geral (Todos)</option>
          <option value="pc">Operacionais</option>
          <option value="analistas">Analistas</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Analista:</label>
        <select id="kpiAnalista" onchange="updateCharts()">
          <option value="">Todos</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Status:</label>
        <select id="kpiStatus" onchange="updateCharts()">
          <option value="all">Todos (Conclu√≠dos/Parciais)</option>
          <option value="done">Apenas Conclu√≠dos</option>
          <option value="partial">Apenas Parciais</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Prioridade:</label>
        <select id="kpiPrioridade" onchange="updateCharts()">
          <option value="all">Todas</option>
          <option value="alta">Alta</option>
          <option value="media">M√©dia</option>
          <option value="baixa">Baixa</option>
        </select>
      </div>

      <div class="filter-group">
        <label>&nbsp;</label>
        <button onclick="updateCharts()">Filtrar</button>
      </div>

      <div class="filter-group">
        <label>&nbsp;</label>
        <button class="excel-btn" onclick="exportKpiDashboardToExcel()">üì• EXCEL (DASHBOARD)</button>
      </div>
    </div>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card-big">
      <h3 style="text-align:center; color:var(--text-main); margin-bottom:15px;">üìä Status (Per√≠odo Selecionado)</h3>
      <div class="chart-container">
        <canvas id="chartStatus"></canvas>
      </div>
      <div id="statusLegend" class="status-legend"></div>
    </div>

    <div class="kpi-card-big">
      <h3 style="text-align:center; color:var(--text-main); margin-bottom:15px;">üèÜ Ranking de Produtividade</h3>
      <div class="chart-container">
        <canvas id="chartRanking"></canvas>
      </div>
    </div>

    <div class="kpi-card-big">
      <h3 style="text-align:center; color:var(--text-main); margin-bottom:15px;">üõë Top Motivos (Paradas)</h3>
      <div class="chart-container">
        <canvas id="chartMotivos"></canvas>
      </div>
    </div>

    <div class="kpi-card-big">
      <h3 style="text-align:center; color:var(--text-main); margin-bottom:15px;">‚ö° Velocidade M√©dia (SLA)</h3>
      <div class="sla-box">
        <div id="slaValue" class="sla-value">00h 00m 00s</div>
        <div class="sla-label">Tempo M√©dio por Tarefa</div>
        <p style="font-size:12px; color:#999; margin-top:10px;">Considera apenas tarefas conclu√≠das.</p>
      </div>
    </div>
  </div>
</section>

<!-- HIST√ìRICO -->
<div class="card" style="width: 99%; margin: 0 auto 20px auto;" id="historyCard">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <h3 style="margin:0; color:var(--minerva-red)">Hist√≥rico de Execu√ß√£o - <span id="historyTitle">OPERACIONAIS</span></h3>
    <div>
      <button class="excel-btn" onclick="exportToExcel()">üì• EXCEL (ATUAL)</button>
      <button class="clear-btn" onclick="requestAuth('history', clearHistory)">LIMPAR HIST√ìRICO üîí</button>
    </div>
  </div>

  <div class="history-container">
    <table class="table" id="historyTable">
      <thead>
        <tr><th>Data</th><th>Rotina</th><th>Analista</th><th>Prioridade</th><th>Status/Justificativa</th><th>In√≠cio</th><th>Fim</th><th>Dura√ß√£o</th><th>%</th><th>Status</th></tr>
      </thead>
      <tbody id="history"></tbody>
    </table>
  </div>
</div>

<!-- MODAL LOGIN -->
<div class="modal" id="authModal">
  <div class="modal-content" style="width: 320px; text-align: center;">
    <h3 style="margin-bottom: 15px;">üîí Acesso Restrito</h3>
    <input id="authUser" placeholder="Usu√°rio" style="margin-bottom: 10px;">
    <div class="pass-wrapper">
      <input id="authPass" type="password" placeholder="Senha">
      <span class="pass-toggle" onclick="togglePass('authPass')">üëÅÔ∏è</span>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 15px;">
      <button class="primary-btn" style="background:#999; flex:1;" onclick="closeAuthModal()">Cancelar</button>
      <button class="primary-btn" style="flex:1;" onclick="submitAuth()">Entrar</button>
    </div>
  </div>
</div>

<!-- Modal Nova/Editar Rotina -->
<div class="modal" id="modal">
  <div class="modal-content" style="width: 400px;">
    <h3 id="modalTitle">Gerenciar Rotina</h3>
    <input id="rotinaInput" placeholder="Nome da rotina...">
    <select id="rotinaPrio">
      <option value="alta">üî• Alta</option>
      <option value="media" selected>üü° M√©dia</option>
      <option value="baixa">üîµ Baixa</option>
    </select>
    <div style="text-align: right;">
      <button class="primary-btn" style="background:#ccc; color:#333;" onclick="closeModal()">Cancelar</button>
      <button class="primary-btn" onclick="saveRotina()">Salvar</button>
    </div>
  </div>
</div>

<!-- Modal Painel Gerencial -->
<div class="modal" id="panelModal">
  <div class="modal-content">
    <h3>Painel Gerencial</h3>

    <div id="sectionPrio" class="panel-section">
      <div class="panel-title">üî• Prioridades das Rotinas (<span id="panelContextTitle"></span>)</div>
      <div class="list-container" id="prioList" style="max-height: 150px;"></div>
      <button class="save-btn" onclick="savePriorities()">üíæ SALVAR PRIORIDADES</button>
    </div>

    <div id="sectionMotivos" class="panel-section">
      <div class="panel-title">üìã Motivos de Status/Justificativa</div>
      <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input id="newMotivoInput" placeholder="Novo Motivo..." style="margin-bottom:0;">
        <button class="primary-btn" onclick="addMotivo()">Adicionar</button>
      </div>
      <div class="list-container" id="motivosList"></div>
    </div>

    <div id="sectionTeam" class="panel-section">
      <div class="panel-title">üë• Equipe Operacional</div>
      <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input id="newAnalistaInput" placeholder="Novo Analista..." style="margin-bottom:0;">
        <button class="primary-btn" onclick="addAnalista()">Adicionar</button>
      </div>
      <div class="list-container" id="teamList"></div>
    </div>

    <!-- ADMIN -->
    <div id="sectionAdmin" class="panel-section" style="display:none;">
      <div class="panel-title">üîê Administradores</div>

      <div style="background:#fff; border:1px solid #ddd; padding:10px; border-radius:4px; margin-bottom:10px;">
        <input id="newAdminUser" placeholder="Usu√°rio (ex: fulano.silva)" style="margin-bottom:5px;">
        <div class="pass-wrapper">
          <input id="newAdminPass" placeholder="Senha" type="password">
          <span class="pass-toggle" onclick="togglePass('newAdminPass')">üëÅÔ∏è</span>
        </div>

        <div style="display:flex; gap:8px; margin:8px 0 10px 0;">
          <button class="primary-btn" style="flex:1; background:#1f2937;" onclick="setAdminPermPreset('full')">FULL</button>
          <button class="primary-btn" style="flex:1; background:#6b7280;" onclick="setAdminPermPreset('clear')">LIMPAR</button>
        </div>

        <div class="perm-group">
          <label><input type="checkbox" id="permTeam"> üõ†Ô∏è Equipe</label>
          <label><input type="checkbox" id="permReset"> üîÑ Reset</label>
          <label><input type="checkbox" id="permHistory"> üßπ Hist√≥rico</label>
          <label><input type="checkbox" id="permEditRotinas"> üìù Editar</label>
          <label><input type="checkbox" id="permAdmin"> üîê Admin (cadastra admins)</label>
          <label><input type="checkbox" id="permPanelAny" checked> ‚öôÔ∏è Abrir Painel</label>
        </div>

        <div style="display:flex; gap:5px;">
          <button id="btnCancelEdit" class="primary-btn" style="width:30%; background:#999; display:none;" onclick="cancelAdminEdit()">Cancelar</button>
          <button id="btnSaveAdmin" class="primary-btn" style="width:100%" onclick="saveAdmin()">Salvar Admin</button>
        </div>

        <div style="margin-top:10px; font-size:11px; color:#666;">
          MASTER (<b>diego.cordeiro</b>) √© intoc√°vel: n√£o d√° para editar/remover pelo painel.
        </div>
      </div>

      <div class="list-container" id="adminList"></div>
    </div>

    <div style="text-align: right; margin-top:10px;">
      <button class="primary-btn" style="background:#ccc; color:#333;" onclick="closePanelModal()">Fechar Painel</button>
    </div>
  </div>
</div>

<script>
/* ===========================
   SEGURAN√áA (MASTER fixo + admins cadastr√°veis)
   =========================== */
const MASTER_USER = "diego.cordeiro";
const DEFAULT_PERMS = { team: true, reset: true, history: true, edit_rotinas: true, admin: true, panel_any: true };

/* Somente o MASTER fica fixo no c√≥digo */
const ADMINS_FIXED = [
  { user: "diego.cordeiro", pass: "040293", perms: DEFAULT_PERMS }
];

/* Carrega admins do localStorage */
let admins = JSON.parse(localStorage.getItem("admins")) || [];

/* Remo√ß√£o pontual (apenas agora): apaga roni.silva se existir, mas N√ÉO bloqueia recadastro */
admins = admins.filter(a => (a.user || "").toLowerCase() !== "roni.silva");

/* Garante que o MASTER sempre exista e seja resetado (senha/perms fixas) */
(function ensureFixedAdmins(){
  const clone = (obj) => JSON.parse(JSON.stringify(obj));

  ADMINS_FIXED.forEach(f => {
    const idx = admins.findIndex(a => (a.user || "").toLowerCase() === f.user.toLowerCase());
    if (idx === -1) admins.push(clone(f));
    else admins[idx] = { ...admins[idx], ...clone(f) };
  });

  localStorage.setItem("admins", JSON.stringify(admins));
})();

/* ===========================
   DADOS INICIAIS
   =========================== */
const DEFAULT_ROTINAS_PC=[
"FEFO SEPARA√á√ÉO ESPECIFICO","FEFO SEPARA√á√ÉO CRITICO","VENCIDOS NO ESTOQUE",
"AUDITORIA DE POSI√á√ÉO PICKING","ARMAZENAMENTO ONDA DE ABASTECIMENTO",
"PONTA DE ESTOQUE","DE-PARA PICKING","RETORNO DE CAIXAS PARA DEVOLU√á√ÉO",
"FANTASMINHA","MIGRA√á√ÉO DE ENDERE√áO PARA PERDIDOS","BAIXA PARA OPERA√á√ÉO",
"INSER√á√ÉO DE ISCAS","CONFERENCIA A√äREO","ONDA REVERSA"
];

const DEFAULT_ROTINAS_ANALISTAS = [
"FECHAMENTO DE OPS", "LAN√áAMENTO DE CUSTOS EXTRAS", "ACOMPANHAMENTO DE ANDAMENTO FEFO",
"ACOMPANHAMENTO DE VENCIDOS RETIRADOS DO ESTOQUE", "% DE DIVERGENCIA DA AUDITORIA DE POSI√á√ÉO",
"RETIRADA DE N√ÉO LOCALIZADAS", "TROCA ENTRE NEGOCIOS", "ARMAZENAGEM DA ONDA",
"ACOMPANHAMENTO PONTA DE ESTOQUE", "% DE-PARA DO PICKING", "RETIRADA DAS SOLICITA√á√ïES DE FANTASMINHA",
"BAIXA PENDENTE PARA OPERA√á√ÉO", "ISCAS INSERIDAS", "CONFER√äNCIA 429 SQL", "CONFERENCIA DO AEREO POR CAMARA"
];

const DEFAULT_ANALISTAS = ["LIVIA PORTA", "WILLIAN SILAS", "RODRIGO PRADO", "EVERTON MORAES", "PAULO AFONSO", "ERICK SALES"];
const DEFAULT_MOTIVOS = ["FALTA DE TEMPO", "SISTEMA INDISPON√çVEL", "SEM DEMANDA", "AGUARDANDO OUTRA √ÅREA"];

const TODAY_STR = new Date().toLocaleDateString('pt-BR');
document.getElementById('dateDisplay').innerText = TODAY_STR;
const savedDate = localStorage.getItem("appDate");

/* CARREGAMENTO */
let rotinasPC = JSON.parse(localStorage.getItem("rotinas")) || [];
let rotinasAnalistas = JSON.parse(localStorage.getItem("rotinasAnalistas")) || [];
let history = JSON.parse(localStorage.getItem("history")) || [];
let analistas = JSON.parse(localStorage.getItem("analistas")) || DEFAULT_ANALISTAS;
let motivos = JSON.parse(localStorage.getItem("motivos")) || DEFAULT_MOTIVOS;
let kpis = JSON.parse(localStorage.getItem("kpis")) || {total:0,exec:0,partial:0,done:0};

if(rotinasPC.length === 0) {
  rotinasPC = DEFAULT_ROTINAS_PC.map(n => ({ nome: n, status: 'pending', prioridade: 'media' }));
} else {
  rotinasPC = rotinasPC.map(r => {
    let obj = (typeof r === 'string') ? { nome: r, status: 'pending' } : r;
    if(!obj.prioridade) obj.prioridade = 'media';
    return obj;
  });
}

if(rotinasAnalistas.length === 0) {
  rotinasAnalistas = DEFAULT_ROTINAS_ANALISTAS.map(n => ({ nome: n, status: 'pending', prioridade: 'alta' }));
} else {
  rotinasAnalistas = rotinasAnalistas.map(r => {
    let obj = (typeof r === 'string') ? { nome: r, status: 'pending' } : r;
    if(!obj.prioridade) obj.prioridade = 'alta';
    return obj;
  });
}

/* RESET DI√ÅRIO */
if (savedDate !== TODAY_STR) {
  rotinasPC.forEach(r => r.status = 'pending');
  rotinasAnalistas.forEach(r => r.status = 'pending');
  kpis = {total:0,exec:0,partial:0,done:0};
  localStorage.setItem("appDate", TODAY_STR);
  saveAll();
}

/* ===========================
   Persist√™ncia
   =========================== */
function saveAll(){
  sortRotinas(rotinasPC);
  sortRotinas(rotinasAnalistas);
  localStorage.setItem("rotinas",JSON.stringify(rotinasPC));
  localStorage.setItem("rotinasAnalistas",JSON.stringify(rotinasAnalistas));
  localStorage.setItem("history",JSON.stringify(history));
  localStorage.setItem("kpis",JSON.stringify(kpis));
  localStorage.setItem("analistas",JSON.stringify(analistas));
  localStorage.setItem("motivos",JSON.stringify(motivos));
  localStorage.setItem("admins", JSON.stringify(admins));
  localStorage.setItem("appDate", TODAY_STR);
}

function sortRotinas(list) {
  const mapPrio = { 'alta': 3, 'media': 2, 'baixa': 1 };
  list.sort((a, b) => {
    const aDone = (a.status === 'done' || a.status === 'partial');
    const bDone = (b.status === 'done' || b.status === 'partial');
    if (aDone && !bDone) return 1;
    if (!aDone && bDone) return -1;
    if (!aDone && !bDone) return mapPrio[b.prioridade] - mapPrio[a.prioridade];
    return 0;
  });
}

/* ===========================
   LOGIN (sess√£o)
   =========================== */
const authModal = document.getElementById("authModal");
const authUser = document.getElementById("authUser");
const authPass = document.getElementById("authPass");
let pendingAuthAction = null;
let pendingAuthPerm = null;

let currentAuthUser = null;

function togglePass(id) {
  const el = document.getElementById(id);
  el.type = el.type === "password" ? "text" : "password";
}

function requestAuth(requiredPerm, callbackAction) {
  pendingAuthPerm = requiredPerm;
  pendingAuthAction = callbackAction;
  authUser.value = "";
  authPass.value = "";
  authModal.style.display = "flex";
  authUser.focus();
}
function closeAuthModal() {
  authModal.style.display = "none";
  pendingAuthAction = null;
}

function canOpenPanel(found) {
  if (!found) return false;
  if (found.user === MASTER_USER) return true;
  return !!(found.perms && found.perms.panel_any);
}

function hasPermission(found, requiredPerm) {
  if (!found) return false;
  if (found.user === MASTER_USER) return true;

  if (requiredPerm === 'any') return canOpenPanel(found);
  return !!(found.perms && found.perms[requiredPerm] === true);
}

function submitAuth() {
  const user = authUser.value.trim().toLowerCase();
  const pass = authPass.value;

  const found = admins.find(a => (a.user || "").toLowerCase() === user && a.pass === pass);

  if (!found) {
    alert("DADOS INCORRETOS.");
    return;
  }

  if (!hasPermission(found, pendingAuthPerm)) {
    alert("ACESSO NEGADO.");
    return;
  }

  currentAuthUser = found.user;
  authModal.style.display = "none";
  pendingAuthAction();
}

/* ===========================
   TABS
   =========================== */
let currentView = 'pc';

function openTab(id) {
  currentView = id;
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  const btns = document.querySelectorAll("nav button");
  if(id === 'pc') btns[0].classList.add("active");
  else if(id === 'analistas') btns[1].classList.add("active");
  else btns[2].classList.add("active");

  const histCard = document.getElementById("historyCard");
  if(id === 'kpi') {
    histCard.style.display = 'none';
    updateCharts();
  } else {
    histCard.style.display = 'block';
    render();
  }
}

/* ===========================
   RENDER LISTAS
   =========================== */
function render(){
  renderList('pc', rotinasPC, document.getElementById("tasks"));
  renderList('analistas', rotinasAnalistas, document.getElementById("tasksAnalistas"));
  document.getElementById("historyTitle").innerText = currentView === 'pc' ? 'OPERACIONAIS' : 'ANALISTAS';
  renderHistory();
}

function renderList(context, list, container){
  container.innerHTML="";
  const options = `<option value="">Selecione...</option>` + analistas.map(a => `<option value="${a}">${a}</option>`).join('');
  const motivosOptions = motivos.map(m => `<option value="${m}">${m}</option>`).join('');

  list.forEach((r,i)=>{
    let rowClass = "task";
    if(r.status === 'done') rowClass += " row-done";
    else if(r.status === 'partial') rowClass += " row-partial";

    let badgeClass = "p-media"; let badgeText = "M√©dia";
    if(r.prioridade === 'alta') { badgeClass="p-alta"; badgeText="ALTA"; }
    if(r.prioridade === 'baixa') { badgeClass="p-baixa"; badgeText="Baixa"; }

    container.innerHTML+=`
    <div class="${rowClass}">
      <span title="${r.nome}">${r.nome}</span>
      <select id="analista-${context}-${i}">${options}</select>
      <div class="prio-badge ${badgeClass}">${badgeText}</div>

      <select id="motivo-${context}-${i}" style="width:100%">
        <option value="">-- Selecione --</option>
        ${motivosOptions}
      </select>

      <span class="inicio">${r.inicio || "-"}</span>
      <span class="fim">${r.fim || "-"}</span>
      <input type="number" min="1" max="99" placeholder="%" value="${r.percent || ''}">
      <div>
        <button class="start" ${r.status !== 'pending' ? 'disabled style="display:none"' : ''} onclick="startTask('${context}', ${i}, this)">Iniciar</button>
        <button class="partial" ${r.status === 'pending' ? 'disabled' : ''} onclick="partialTask('${context}', ${i}, this)">Parcial</button>
        <button class="finish" ${r.status === 'pending' ? 'disabled' : ''} onclick="finishTask('${context}', ${i}, this)">Finalizar</button>
        <button class="edit" onclick="requestAuth('edit_rotinas', () => editRotina('${context}', ${i}))">Editar</button>
        <button class="delete" onclick="requestAuth('edit_rotinas', () => removeRotina('${context}', ${i}))">Excluir</button>
      </div>
    </div>`;
  });
}

function renderHistory(){
  const filteredHistory = history.filter(h => {
    if(currentView === 'pc') return !h.type || h.type === 'pc';
    return h.type === 'analistas';
  });

  document.getElementById("history").innerHTML = filteredHistory.map(h=>`
    <tr>
      <td>${h.data}</td><td>${h.rotina}</td><td>${h.analista}</td><td>${h.prioridade || '-'}</td><td>${h.motivo||"-"}</td><td>${h.inicio}</td><td>${h.fim}</td><td>${h.duracao}</td><td>${h.percent}</td><td>${h.status}</td>
    </tr>`).join("");
}

/* ===========================
   A√á√ïES TAREFAS
   =========================== */
function startTask(context, i, btn){
  const row = btn.closest(".task");
  const select = row.querySelector("select");
  if(!select.value) { alert("‚ö†Ô∏è Selecione um ANALISTA!"); select.focus(); return; }

  const list = context === 'pc' ? rotinasPC : rotinasAnalistas;
  list[i].inicio = new Date().toLocaleTimeString();

  row.querySelector(".inicio").innerText = list[i].inicio;
  btn.style.display = "none";
  row.querySelector(".partial").disabled = false;
  row.querySelector(".finish").disabled = false;

  kpis.total++; kpis.exec++;
}

function finishTask(context, i, btn){
  const list = context === 'pc' ? rotinasPC : rotinasAnalistas;
  if(!list[i].inicio) return alert("Rotina n√£o iniciada!");

  const analista = document.getElementById(`analista-${context}-${i}`).value;
  let motivo = document.getElementById(`motivo-${context}-${i}`).value;
  if(!motivo) motivo = "CONCLU√çDO";

  list[i].fim = new Date().toLocaleTimeString();
  list[i].status = 'done';

  logHistory(context, list[i].nome, analista, motivo, list[i].inicio, list[i].fim, "Conclu√≠do", "-", list[i].prioridade);

  kpis.exec--; kpis.done++;
  saveAll(); render();
}

function partialTask(context, i, btn){
  const row = btn.closest(".task");
  const list = context === 'pc' ? rotinasPC : rotinasAnalistas;
  if(!list[i].inicio) return alert("Rotina n√£o iniciada!");

  const p = row.querySelector("input[type=number]").value;
  if(!p) return alert("Informe %");

  const analista = document.getElementById(`analista-${context}-${i}`).value;

  let motivo = document.getElementById(`motivo-${context}-${i}`).value;
  if(!motivo) {
    alert("‚ö†Ô∏è ATEN√á√ÉO: Selecione um Status/Justificativa para finalizar como PARCIAL.");
    document.getElementById(`motivo-${context}-${i}`).focus();
    return;
  }

  const fimTime = new Date().toLocaleTimeString();
  list[i].status = 'partial';
  list[i].percent = p;

  logHistory(context, list[i].nome, analista, motivo, list[i].inicio, fimTime, "Parcial", p+"%", list[i].prioridade);

  kpis.partial++;
  saveAll(); render();
}

function logHistory(type, rotina, analista, motivo, inicio, fim, status, percent, prioridade){
  history.unshift({
    type: type,
    data: new Date().toLocaleDateString('pt-BR'),
    rotina, analista, motivo, inicio, fim,
    duracao: calcDuration(inicio, fim),
    percent, status,
    prioridade: prioridade || 'media'
  });
}

function calcDuration(s, e) {
  if(!s || s==="-" || !e) return "-";
  const d1 = new Date("01/01/2020 "+s);
  const d2 = new Date("01/01/2020 "+e);
  let diff = (d2-d1)/1000; if(diff<0) diff=0;
  const h = Math.floor(diff/3600);
  const m = Math.floor((diff%3600)/60);
  const sc = diff%60;
  let r="";
  if(h>0) r+=`${h.toString().padStart(2,'0')}h `;
  if(m>0||h>0) r+=`${m.toString().padStart(2,'0')}m `;
  r+=`${sc.toString().padStart(2,'0')}s`;
  return r;
}

/* ===========================
   MODAL ROTINA
   =========================== */
const modal = document.getElementById("modal");
const rotinaInput = document.getElementById("rotinaInput");
const rotinaPrioInput = document.getElementById("rotinaPrio");
let currentContext = 'pc';
let currentEditId = null;

function openModal(context){
  currentContext = context;
  currentEditId = null;
  rotinaInput.value="";
  rotinaPrioInput.value = "media";
  modal.style.display="flex";
}
function closeModal(){ modal.style.display="none"; }

function saveRotina(){
  const nome = rotinaInput.value.trim();
  const prio = rotinaPrioInput.value;
  if(!nome) return alert("Informe o nome");

  const list = currentContext === 'pc' ? rotinasPC : rotinasAnalistas;

  if(currentEditId !== null) {
    list[currentEditId].nome = nome;
    list[currentEditId].prioridade = prio;
  } else {
    list.push({nome: nome, status: 'pending', prioridade: prio});
  }
  closeModal(); saveAll(); render();
}

function editRotina(context, i){
  currentContext = context;
  currentEditId = i;
  const list = context === 'pc' ? rotinasPC : rotinasAnalistas;
  rotinaInput.value = list[i].nome;
  rotinaPrioInput.value = list[i].prioridade;
  modal.style.display="flex";
}

function removeRotina(context, i){
  if(confirm("Excluir rotina?")){
    const list = context === 'pc' ? rotinasPC : rotinasAnalistas;
    list.splice(i,1);
    saveAll(); render();
  }
}

function resetRotinas(context){
  if(confirm("Reiniciar rotinas desta lista?")){
    const list = context === 'pc' ? rotinasPC : rotinasAnalistas;
    list.forEach(r => {
      r.status = 'pending';
      r.inicio = null;
      r.fim = null;
      r.percent = null;
    });
    saveAll(); render();
  }
}

function clearHistory(){
  if(confirm(`Apagar hist√≥rico da aba ${currentView === 'pc' ? 'OPERACIONAIS' : 'ANALISTAS'}?`)){
    history = history.filter(h => {
      if(currentView === 'pc') return h.type === 'analistas';
      return !h.type || h.type === 'pc';
    });
    saveAll(); render();
  }
}

/* ===========================
   PAINEL GERENCIAL
   =========================== */
const panelModal = document.getElementById("panelModal");
const sectionTeam = document.getElementById("sectionTeam");
const sectionAdmin = document.getElementById("sectionAdmin");
const sectionPrio = document.getElementById("sectionPrio");
const sectionMotivos = document.getElementById("sectionMotivos");
const panelContextTitle = document.getElementById("panelContextTitle");

function getLoggedAdmin() {
  if (!currentAuthUser) return null;
  return admins.find(a => a.user === currentAuthUser) || null;
}

function openManagementPanel(context) {
  currentContext = context;
  panelContextTitle.innerText = context === 'pc' ? "OPERACIONAIS" : "ANALISTAS";

  const found = getLoggedAdmin();
  if (!found) { alert("Sess√£o expirada. Fa√ßa login novamente."); return; }

  const canTeam = (found.user === MASTER_USER) || !!(found.perms && found.perms.team);
  const canAdmin = (found.user === MASTER_USER) || !!(found.perms && found.perms.admin);
  const canPrio = canTeam || canAdmin;

  sectionTeam.style.display = canTeam ? "block" : "none";
  sectionMotivos.style.display = canTeam ? "block" : "none";
  sectionPrio.style.display = canPrio ? "block" : "none";
  sectionAdmin.style.display = canAdmin ? "block" : "none";

  if(canPrio) renderPrioList();
  if(canTeam) { renderTeamList(); renderMotivosList(); }
  if(canAdmin) { renderAdminList(); cancelAdminEdit(); }

  panelModal.style.display = "flex";
}
function closePanelModal() { panelModal.style.display = "none"; saveAll(); render(); }

/* --- PRIORIDADES --- */
const prioListDiv = document.getElementById("prioList");
function renderPrioList() {
  const list = currentContext === 'pc' ? rotinasPC : rotinasAnalistas;
  prioListDiv.innerHTML = list.map((r, i) => `
    <div class="list-item">
      <span style="font-size:12px;">${r.nome}</span>
      <select onchange="tempChangePriority(${i}, this.value)" style="width:100px; padding:4px;">
        <option value="alta" ${r.prioridade==='alta'?'selected':''}>üî• Alta</option>
        <option value="media" ${r.prioridade==='media'?'selected':''}>üü° M√©dia</option>
        <option value="baixa" ${r.prioridade==='baixa'?'selected':''}>üîµ Baixa</option>
      </select>
    </div>
  `).join("");
}
function tempChangePriority(index, value) {
  const list = currentContext === 'pc' ? rotinasPC : rotinasAnalistas;
  list[index].prioridade = value;
}
function savePriorities() { saveAll(); render(); alert("Prioridades salvas!"); }

/* --- MOTIVOS --- */
const motivosListDiv = document.getElementById("motivosList");
const newMotivoInput = document.getElementById("newMotivoInput");

function renderMotivosList(){
  motivosListDiv.innerHTML = motivos.map((m, i) => `
    <div class="list-item"><span>${m}</span><button class="icon-btn btn-del" onclick="deleteMotivo(${i})">X</button></div>
  `).join("");
}
function addMotivo(){
  const val = newMotivoInput.value.trim().toUpperCase(); if(!val) return;
  motivos.push(val); newMotivoInput.value=""; renderMotivosList(); saveAll();
  if(currentView === 'kpi') updateCharts();
}
function deleteMotivo(i){
  if(confirm("Remover motivo?")){
    motivos.splice(i,1); renderMotivosList(); saveAll();
    if(currentView === 'kpi') updateCharts();
  }
}

/* --- EQUIPE --- */
const teamListDiv = document.getElementById("teamList");
const newAnalistaInput = document.getElementById("newAnalistaInput");

function renderTeamList(){
  teamListDiv.innerHTML = analistas.map((a, i) =>
    `<div class="list-item"><span>${a}</span><div><button class="icon-btn btn-edit" onclick="editAnalista(${i})">Editar</button><button class="icon-btn btn-del" onclick="deleteAnalista(${i})">X</button></div></div>`
  ).join("");
}
function addAnalista(){
  const n = newAnalistaInput.value.trim().toUpperCase(); if(!n) return;
  analistas.push(n);
  newAnalistaInput.value="";
  renderTeamList();
  saveAll();
  populateAnalystFilter();
  if(currentView === 'kpi') updateCharts();
}
function deleteAnalista(i){
  if(confirm("Remover?")){
    analistas.splice(i,1);
    renderTeamList();
    saveAll();
    populateAnalystFilter();
    if(currentView === 'kpi') updateCharts();
  }
}
function editAnalista(i){
  const n=prompt("Nome:",analistas[i]);
  if(n){
    analistas[i]=n.toUpperCase();
    renderTeamList();
    saveAll();
    populateAnalystFilter();
    if(currentView === 'kpi') updateCharts();
  }
}

/* ===========================
   ADMINS (CRUD) - Painel
   =========================== */
let editingAdminIndex = null;

function getAdminFormPerms() {
  return {
    team: document.getElementById("permTeam").checked,
    reset: document.getElementById("permReset").checked,
    history: document.getElementById("permHistory").checked,
    edit_rotinas: document.getElementById("permEditRotinas").checked,
    admin: document.getElementById("permAdmin").checked,
    panel_any: document.getElementById("permPanelAny").checked
  };
}

function setAdminPermPreset(mode) {
  const set = (id, v) => (document.getElementById(id).checked = v);

  if (mode === "full") {
    set("permTeam", true);
    set("permReset", true);
    set("permHistory", true);
    set("permEditRotinas", true);
    set("permAdmin", true);
    set("permPanelAny", true);
  } else {
    set("permTeam", false);
    set("permReset", false);
    set("permHistory", false);
    set("permEditRotinas", false);
    set("permAdmin", false);
    set("permPanelAny", true);
  }
}

function renderAdminList() {
  const div = document.getElementById("adminList");
  const safe = (s) => (s || "").toString();
  const sorted = [...admins].sort((a,b) => safe(a.user).localeCompare(safe(b.user)));

  div.innerHTML = sorted.map((a) => {
    const userLower = (a.user || "").toLowerCase();
    const isMaster = (userLower === MASTER_USER.toLowerCase());
    const isFixed = ADMINS_FIXED.some(f => f.user.toLowerCase() === userLower);
    const idx = admins.findIndex(x => (x.user||"") === a.user);

    const permsTxt = [
      a.perms?.panel_any ? "Painel" : "",
      a.perms?.team ? "Equipe" : "",
      a.perms?.reset ? "Reset" : "",
      a.perms?.history ? "Hist" : "",
      a.perms?.edit_rotinas ? "Editar" : "",
      a.perms?.admin ? "Admin" : ""
    ].filter(Boolean).join(" | ") || "-";

    const lockEditDel = isMaster || isFixed;

    return `
      <div class="list-item">
        <div style="display:flex; flex-direction:column; gap:2px;">
          <span style="font-weight:700">${safe(a.user)} ${isMaster ? "(MASTER)" : (isFixed ? "(FIXO)" : "")}</span>
          <span style="font-size:11px; color:#666">${permsTxt}</span>
        </div>
        <div>
          <button class="icon-btn btn-edit" ${lockEditDel ? 'style="opacity:.4;cursor:not-allowed" disabled' : ''} onclick="editAdmin(${idx})">Editar</button>
          <button class="icon-btn btn-del" ${lockEditDel ? 'style="opacity:.4;cursor:not-allowed" disabled' : ''} onclick="deleteAdmin(${idx})">X</button>
        </div>
      </div>
    `;
  }).join("");
}

function editAdmin(i) {
  const a = admins[i];
  if (!a) return;

  const userLower = (a.user || "").toLowerCase();
  const isMaster = (userLower === MASTER_USER.toLowerCase());
  const isFixed = ADMINS_FIXED.some(f => f.user.toLowerCase() === userLower);

  if (isMaster || isFixed) {
    alert("Este usu√°rio √© MASTER/FIXO e n√£o pode ser alterado.");
    return;
  }

  editingAdminIndex = i;
  document.getElementById("newAdminUser").value = (a.user || "").toLowerCase();
  document.getElementById("newAdminPass").value = "";

  document.getElementById("permTeam").checked = !!a.perms?.team;
  document.getElementById("permReset").checked = !!a.perms?.reset;
  document.getElementById("permHistory").checked = !!a.perms?.history;
  document.getElementById("permEditRotinas").checked = !!a.perms?.edit_rotinas;
  document.getElementById("permAdmin").checked = !!a.perms?.admin;
  document.getElementById("permPanelAny").checked = (typeof a.perms?.panel_any === "boolean") ? a.perms.panel_any : true;

  document.getElementById("btnCancelEdit").style.display = "block";
  document.getElementById("btnSaveAdmin").innerText = "Atualizar Admin";
}

function cancelAdminEdit() {
  editingAdminIndex = null;
  document.getElementById("newAdminUser").value = "";
  document.getElementById("newAdminPass").value = "";
  setAdminPermPreset("clear");
  document.getElementById("btnCancelEdit").style.display = "none";
  document.getElementById("btnSaveAdmin").innerText = "Salvar Admin";
}

function saveAdmin() {
  const found = getLoggedAdmin();
  const canAdmin = (found && (found.user === MASTER_USER || !!found.perms?.admin));
  if (!canAdmin) return alert("Acesso negado (admin).");

  let user = document.getElementById("newAdminUser").value.trim().toLowerCase();
  const pass = document.getElementById("newAdminPass").value;
  const perms = getAdminFormPerms();

  if (!user) return alert("Informe o usu√°rio.");
  if (editingAdminIndex === null && !pass) return alert("Informe a senha (novo admin).");

  if (user === MASTER_USER.toLowerCase()) return alert("N√£o √© permitido criar/alterar o usu√°rio MASTER.");

  if (editingAdminIndex !== null) {
    const cur = admins[editingAdminIndex];
    if (!cur) return;

    const curLower = (cur.user || "").toLowerCase();
    const isFixed = ADMINS_FIXED.some(f => f.user.toLowerCase() === curLower);
    if (isFixed) return alert("Este admin √© FIXO e n√£o pode ser alterado pelo painel.");

    const existsOther = admins.some((a, idx) => idx !== editingAdminIndex && (a.user||"").toLowerCase() === user);
    if (existsOther) return alert("J√° existe um admin com esse usu√°rio.");

    admins[editingAdminIndex] = {
      ...cur,
      user,
      pass: pass ? pass : cur.pass,
      perms
    };
  } else {
    const exists = admins.some(a => (a.user||"").toLowerCase() === user);
    if (exists) return alert("J√° existe um admin com esse usu√°rio.");

    admins.push({ user, pass, perms });
  }

  saveAll();
  renderAdminList();
  cancelAdminEdit();
  alert("Admin salvo!");
}

function deleteAdmin(i) {
  const found = getLoggedAdmin();
  const canAdmin = (found && (found.user === MASTER_USER || !!found.perms?.admin));
  if (!canAdmin) return alert("Acesso negado (admin).");

  const a = admins[i];
  if (!a) return;

  const userLower = (a.user || "").toLowerCase();
  const isMaster = (userLower === MASTER_USER.toLowerCase());
  const isFixed = ADMINS_FIXED.some(f => f.user.toLowerCase() === userLower);
  if (isMaster || isFixed) return alert("N√£o √© permitido remover admin MASTER/FIXO.");

  if (confirm(`Remover admin "${a.user}"?`)) {
    admins.splice(i, 1);
    saveAll();
    renderAdminList();
  }
}

/* ===========================
   EXPORT HIST√ìRICO (xls)
   =========================== */
function exportToExcel() {
  const filteredHistory = history.filter(h => {
    if(currentView === 'pc') return !h.type || h.type === 'pc';
    return h.type === 'analistas';
  });

  let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"></head><body><table border="1"><thead><tr style="background-color:#7A1417; color:#fff;"><th>Data</th><th>Rotina</th><th>Analista</th><th>Prioridade</th><th>Status/Justificativa</th><th>In√≠cio</th><th>Fim</th><th>Dura√ß√£o</th><th>%</th><th>Status</th></tr></thead><tbody>`;
  filteredHistory.forEach(h => html += `<tr><td>${h.data}</td><td>${h.rotina}</td><td>${h.analista}</td><td>${h.prioridade||"-"}</td><td>${h.motivo||""}</td><td>${h.inicio}</td><td>${h.fim}</td><td>${h.duracao}</td><td>${h.percent}</td><td>${h.status}</td></tr>`);
  html += `</tbody></table></body></html>`;

  const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  const contextName = currentView === 'pc' ? 'OPERACIONAIS' : 'ANALISTAS';
  a.download = `Relatorio_${contextName}_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.xls`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

/* ===========================
   KPI - filtros integrados
   =========================== */
let lastKpiSnapshot = null;
let chartStatus = null;
let chartRanking = null;
let chartMotivos = null;

function populateAnalystFilter(list, keepValue) {
  const sel = document.getElementById("kpiAnalista");
  const prev = (typeof keepValue !== "undefined") ? keepValue : sel.value;

  sel.innerHTML = `<option value="">Todos</option>`;
  const unique = [...new Set((list || analistas).filter(Boolean))].sort((a,b) => a.localeCompare(b));
  unique.forEach(a => {
    const opt = document.createElement("option");
    opt.value = a;
    opt.innerText = a;
    sel.appendChild(opt);
  });

  if (prev && [...sel.options].some(o => o.value === prev)) sel.value = prev;
  else sel.value = "";
}

function parseDatePTBR(str) {
  if(!str) return null;
  const parts = str.split('/');
  return new Date(parts[2], parts[1] - 1, parts[0]);
}
function parseDateInput(str) {
  if(!str) return null;
  const parts = str.split('-');
  return new Date(parts[0], parts[1] - 1, parts[2]);
}

function filterHistoryIntegrated(opts) {
  const dStart = parseDateInput(opts.dateStartInput);
  const dEnd = parseDateInput(opts.dateEndInput);

  return history.filter(h => {
    const hDate = parseDatePTBR(h.data);
    if (dStart && hDate < dStart) return false;
    if (dEnd && hDate > dEnd) return false;

    if(opts.typeFilter === 'pc' && h.type === 'analistas') return false;
    if(opts.typeFilter === 'analistas' && (!h.type || h.type === 'pc')) return false;

    if(opts.statusFilter === 'done' && h.status !== 'Conclu√≠do') return false;
    if(opts.statusFilter === 'partial' && h.status !== 'Parcial') return false;

    if(opts.prioFilter !== 'all') {
      if(!h.prioridade || h.prioridade !== opts.prioFilter) return false;
    }

    if(opts.applyAnalista && opts.analistaFilter && h.analista !== opts.analistaFilter) return false;

    return true;
  });
}

function updateCharts() {
  const ctxStatus = document.getElementById('chartStatus');
  const ctxRanking = document.getElementById('chartRanking');
  const ctxMotivos = document.getElementById('chartMotivos');

  const dateStartInput = document.getElementById('kpiDateStart').value;
  const dateEndInput = document.getElementById('kpiDateEnd').value;
  const typeFilter = document.getElementById('kpiFilter').value;
  const statusFilter = document.getElementById('kpiStatus').value;
  const prioFilter = document.getElementById('kpiPrioridade').value;

  const baseFiltered = filterHistoryIntegrated({
    dateStartInput, dateEndInput, typeFilter, statusFilter, prioFilter,
    analistaFilter: "", applyAnalista: false
  });

  const analystsFromBase = [...new Set(baseFiltered.map(h => h.analista).filter(Boolean))];
  const currentAnalistaValue = document.getElementById('kpiAnalista').value;
  populateAnalystFilter(analystsFromBase.length ? analystsFromBase : analistas, currentAnalistaValue);

  const analistaFilter = document.getElementById('kpiAnalista').value;

  const filteredHistory = filterHistoryIntegrated({
    dateStartInput, dateEndInput, typeFilter, statusFilter, prioFilter,
    analistaFilter, applyAnalista: true
  });

  let countDone = 0, countPartial = 0;
  filteredHistory.forEach(h => {
    if(h.status === 'Conclu√≠do') countDone++;
    else if(h.status === 'Parcial') countPartial++;
  });

  document.getElementById("statusLegend").innerHTML = `
    <div class="legend-item"><span style="background:#0f5132"></span>Conclu√≠das: ${countDone}</div>
    <div class="legend-item"><span style="background:#f9a825"></span>Parciais: ${countPartial}</div>
  `;

  const rankingMap = {};
  filteredHistory.forEach(h => {
    if(!rankingMap[h.analista]) rankingMap[h.analista] = 0;
    rankingMap[h.analista]++;
  });
  const rankingSorted = Object.entries(rankingMap).sort((a,b) => b[1] - a[1]);

  const motivosMap = {};
  filteredHistory.forEach(h => {
    const m = h.motivo || "";
    if(m !== "CONCLU√çDO" && m !== "PARCIAL" && m !== "") {
      if(!motivosMap[m]) motivosMap[m] = 0;
      motivosMap[m]++;
    }
  });
  const motivosSorted = Object.entries(motivosMap).sort((a,b) => b[1] - a[1]);

  let totalSeconds = 0, slaCount = 0;
  filteredHistory.forEach(h => {
    if(h.status === 'Conclu√≠do' && h.duracao !== "-") {
      const durStr = h.duracao;
      let hours = 0, mins = 0, secs = 0;
      let hMatch = durStr.match(/(\d+)h/); if (hMatch) hours = parseInt(hMatch[1]);
      let mMatch = durStr.match(/(\d+)m/); if (mMatch) mins = parseInt(mMatch[1]);
      let sMatch = durStr.match(/(\d+)s/); if (sMatch) secs = parseInt(sMatch[1]);
      if (hours > 0 || mins > 0 || secs > 0) {
        totalSeconds += (hours * 3600) + (mins * 60) + secs;
        slaCount++;
      }
    }
  });

  if(slaCount > 0) {
    const avg = totalSeconds / slaCount;
    const h = Math.floor(avg/3600);
    const m = Math.floor((avg%3600)/60);
    const s = Math.floor(avg%60);
    document.getElementById("slaValue").innerText = `${h.toString().padStart(2,'0')}h ${m.toString().padStart(2,'0')}m ${s.toString().padStart(2,'0')}s`;
  } else {
    document.getElementById("slaValue").innerText = "00h 00m 00s";
  }

  if(chartStatus) chartStatus.destroy();
  chartStatus = new Chart(ctxStatus, {
    type: 'doughnut',
    data: { labels: ['Conclu√≠das', 'Parciais'], datasets: [{ data: [countDone, countPartial], backgroundColor: ['#0f5132', '#f9a825'] }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
  });

  if(chartRanking) chartRanking.destroy();
  chartRanking = new Chart(ctxRanking, {
    type: 'bar',
    data: { labels: rankingSorted.map(x => x[0]), datasets: [{ label: 'Tarefas', data: rankingSorted.map(x => x[1]), backgroundColor: '#7A1417' }] },
    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { stepSize: 1 } } } }
  });

  if(chartMotivos) chartMotivos.destroy();
  if(motivosSorted.length === 0) {
    chartMotivos = new Chart(ctxMotivos, {
      type: 'pie',
      data: { labels: ['Sem dados'], datasets: [{ data: [1], backgroundColor: ['#e0e0e0'] }] },
      options: { responsive: true, maintainAspectRatio: false }
    });
  } else {
    chartMotivos = new Chart(ctxMotivos, {
      type: 'pie',
      data: { labels: motivosSorted.map(x => x[0]), datasets: [{ data: motivosSorted.map(x => x[1]), backgroundColor: ['#dc3545', '#ffc107', '#6c757d', '#17a2b8'] }] },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  lastKpiSnapshot = {
    generatedAt: new Date(),
    filters: {
      dateStart: document.getElementById('kpiDateStart').value,
      dateEnd: document.getElementById('kpiDateEnd').value,
      tipo: document.getElementById('kpiFilter').value,
      analista: document.getElementById('kpiAnalista').value || "Todos",
      status: document.getElementById('kpiStatus').value,
      prioridade: document.getElementById('kpiPrioridade').value
    },
    counts: { done: countDone, partial: countPartial },
    ranking: rankingSorted,
    motivos: motivosSorted,
    slaText: document.getElementById("slaValue").innerText,
    items: filteredHistory
  };
}

/* ===========================
   EXPORT KPI -> EXCEL (XLSX)
   =========================== */
async function exportKpiDashboardToExcel() {
  if (!window.ExcelJS || typeof saveAs !== "function") {
    alert("Bibliotecas de Excel n√£o carregaram (ExcelJS/FileSaver).");
    return;
  }

  updateCharts();
  if (!lastKpiSnapshot) { alert("Sem dados do KPI para exportar."); return; }
  await new Promise(r => setTimeout(r, 80));

  const snap = lastKpiSnapshot;

  const wb = new ExcelJS.Workbook();
  wb.creator = "Minerva Foods - Controle de Rotinas";
  wb.created = new Date();

  const MINERVA_RED = "FF7A1417";
  const MINERVA_DARK = "FF4A0C0E";
  const GOLD = "FFC69C6D";
  const BORDER = "FFDDDDDD";

  const ws = wb.addWorksheet("Dashboard KPI");
  ws.columns = [
    { width: 22 }, { width: 22 }, { width: 22 }, { width: 22 },
    { width: 22 }, { width: 22 }, { width: 22 }, { width: 22 }
  ];

  function setFill(cell, argb) { cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb } }; }
  function setBorder(cell) {
    cell.border = {
      top: { style: "thin", color: { argb: BORDER } },
      left: { style: "thin", color: { argb: BORDER } },
      bottom: { style: "thin", color: { argb: BORDER } },
      right: { style: "thin", color: { argb: BORDER } }
    };
  }
  function rangeBorder(r1, c1, r2, c2) {
    for (let r = r1; r <= r2; r++) for (let c = c1; c <= c2; c++) setBorder(ws.getRow(r).getCell(c));
  }

  ws.mergeCells("A1:H1");
  ws.getCell("A1").value = "Minerva Foods | Dashboard KPI - Controle de Rotinas";
  ws.getCell("A1").font = { bold: true, size: 14, color: { argb: "FFFFFFFF" } };
  ws.getCell("A1").alignment = { vertical: "middle", horizontal: "left" };
  setFill(ws.getCell("A1"), MINERVA_RED);
  ws.getRow(1).height = 28;

  ws.mergeCells("A2:H2");
  ws.getCell("A2").value =
    `Per√≠odo: ${snap.filters.dateStart || "-"} at√© ${snap.filters.dateEnd || "-"}  |  Tipo: ${snap.filters.tipo}  |  Analista: ${snap.filters.analista}  |  Status: ${snap.filters.status}  |  Prioridade: ${snap.filters.prioridade}`;
  ws.getCell("A2").font = { size: 11, bold: true, color: { argb: MINERVA_DARK } };
  ws.getCell("A2").alignment = { vertical: "middle", horizontal: "left", wrapText: true };
  ws.getRow(2).height = 22;

  ws.mergeCells("A3:D3");
  ws.getCell("A3").value = "Resumo";
  ws.getCell("A3").font = { bold: true, color: { argb: "FFFFFFFF" } };
  setFill(ws.getCell("A3"), GOLD);

  ws.mergeCells("E3:H3");
  ws.getCell("E3").value = "SLA M√©dio (somente conclu√≠das)";
  ws.getCell("E3").font = { bold: true, color: { argb: "FFFFFFFF" } };
  setFill(ws.getCell("E3"), GOLD);

  ws.getCell("A4").value = "Conclu√≠das";
  ws.getCell("B4").value = snap.counts.done;
  ws.getCell("C4").value = "Parciais";
  ws.getCell("D4").value = snap.counts.partial;

  ws.mergeCells("E4:H4");
  ws.getCell("E4").value = snap.slaText;
  ws.getCell("E4").font = { bold: true, size: 13, color: { argb: MINERVA_RED } };

  rangeBorder(3, 1, 4, 8);

  ws.getCell("A6").value = "Ranking de Produtividade";
  ws.getCell("A6").font = { bold: true, color: { argb: MINERVA_DARK } };
  ws.getCell("E6").value = "Top Motivos (Paradas)";
  ws.getCell("E6").font = { bold: true, color: { argb: MINERVA_DARK } };

  ws.getCell("A7").value = "Analista";
  ws.getCell("B7").value = "Qtde";
  ws.getCell("E7").value = "Motivo";
  ws.getCell("F7").value = "Qtde";

  ["A7","B7","E7","F7"].forEach(addr => {
    const c = ws.getCell(addr);
    c.font = { bold: true, color: { argb: "FFFFFFFF" } };
    setFill(c, MINERVA_RED);
  });

  const maxRows = 12;
  for (let i = 0; i < maxRows; i++) {
    const r = 8 + i;
    const rk = snap.ranking[i];
    if (rk) { ws.getCell(`A${r}`).value = rk[0]; ws.getCell(`B${r}`).value = rk[1]; }
    const mv = snap.motivos[i];
    if (mv) { ws.getCell(`E${r}`).value = mv[0]; ws.getCell(`F${r}`).value = mv[1]; }
  }

  rangeBorder(7, 1, 7 + maxRows, 2);
  rangeBorder(7, 5, 7 + maxRows, 6);

  const imgStatus = document.getElementById("chartStatus").toDataURL("image/png", 1.0);
  const imgRanking = document.getElementById("chartRanking").toDataURL("image/png", 1.0);
  const imgMotivos = document.getElementById("chartMotivos").toDataURL("image/png", 1.0);

  const imgId1 = wb.addImage({ base64: imgStatus, extension: "png" });
  const imgId2 = wb.addImage({ base64: imgRanking, extension: "png" });
  const imgId3 = wb.addImage({ base64: imgMotivos, extension: "png" });

  ws.getCell("A21").value = "Gr√°ficos";
  ws.getCell("A21").font = { bold: true, color: { argb: MINERVA_DARK } };

  ws.addImage(imgId1, { tl: { col: 0, row: 21 }, br: { col: 4, row: 35 } });
  ws.addImage(imgId2, { tl: { col: 4, row: 21 }, br: { col: 8, row: 35 } });
  ws.addImage(imgId3, { tl: { col: 0, row: 36 }, br: { col: 4, row: 50 } });

  ws.mergeCells("E38:H38");
  ws.getCell("E38").value = "SLA M√©dio";
  ws.getCell("E38").font = { bold: true, color: { argb: "FFFFFFFF" } };
  setFill(ws.getCell("E38"), GOLD);

  ws.mergeCells("E39:H41");
  ws.getCell("E39").value = snap.slaText;
  ws.getCell("E39").font = { bold: true, size: 18, color: { argb: MINERVA_RED } };
  ws.getCell("E39").alignment = { vertical: "middle", horizontal: "center" };
  rangeBorder(38, 5, 41, 8);

  const wsData = wb.addWorksheet("Dados KPI");
  wsData.columns = [
    { header: "Data", key: "data", width: 12 },
    { header: "Tipo", key: "type", width: 12 },
    { header: "Rotina", key: "rotina", width: 40 },
    { header: "Analista", key: "analista", width: 22 },
    { header: "Prioridade", key: "prioridade", width: 12 },
    { header: "Status", key: "status", width: 12 },
    { header: "Motivo", key: "motivo", width: 28 },
    { header: "In√≠cio", key: "inicio", width: 12 },
    { header: "Fim", key: "fim", width: 12 },
    { header: "Dura√ß√£o", key: "duracao", width: 14 },
    { header: "%", key: "percent", width: 8 }
  ];

  wsData.getRow(1).eachCell(c => {
    c.font = { bold: true, color: { argb: "FFFFFFFF" } };
    setFill(c, MINERVA_RED);
    setBorder(c);
  });

  snap.items.forEach(h => {
    wsData.addRow({
      data: h.data || "",
      type: (h.type || "pc"),
      rotina: h.rotina || "",
      analista: h.analista || "",
      prioridade: h.prioridade || "",
      status: h.status || "",
      motivo: h.motivo || "",
      inicio: h.inicio || "",
      fim: h.fim || "",
      duracao: h.duracao || "",
      percent: h.percent || ""
    });
  });

  for (let r = 2; r <= wsData.rowCount; r++) wsData.getRow(r).eachCell(c => setBorder(c));
  wsData.views = [{ state: "frozen", ySplit: 1 }];

  const buf = await wb.xlsx.writeBuffer();
  const blob = new Blob([buf], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

  const safeDate = (s) => (s || "").replaceAll("-", "");
  const fname = `KPI_Dashboard_${safeDate(snap.filters.dateStart)}_${safeDate(snap.filters.dateEnd)}.xlsx`;
  saveAs(blob, fname);
}

/* ===========================
   INIT
   =========================== */
window.onload = function() {
  const todayISO = new Date().toISOString().split('T')[0];
  document.getElementById('kpiDateStart').value = todayISO;
  document.getElementById('kpiDateEnd').value = todayISO;

  populateAnalystFilter();
  sortRotinas(rotinasPC);
  sortRotinas(rotinasAnalistas);
  render();
  updateCharts();
};
</script>

</body>
</html>
