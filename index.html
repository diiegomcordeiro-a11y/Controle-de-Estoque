<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Rotinas ‚Äì Estoque | Minerva Foods</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<!-- GR√ÅFICOS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- EXPORT EXCEL -->
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>

<style>
:root {
  --minerva-red: #7A1417;
  --minerva-dark: #4a0c0e;
  --minerva-gold: #C69C6D;
  --bg: #eef1f5;
  --card-bg: #ffffff;
  --text-main: #333;
  --success-bg: #d1e7dd; 
  --success-text: #0f5132;
  --warning-bg: #fff3cd; 
  --warning-text: #664d03;
  --info: #0d6efd;
  --danger: #dc3545;
}

* { 
  box-sizing: border-box; 
  font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
}

body { 
  margin: 0; 
  background: var(--bg); 
  color: var(--text-main); 
  font-size: 13px; 
}

/* LOGIN SCREEN */
.login-overlay {
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, var(--minerva-red) 0%, var(--minerva-dark) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.login-container {
  background: white;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  width: 100%;
  max-width: 400px;
  text-align: center;
}

.login-logo {
  color: var(--minerva-red);
  font-size: 28px;
  font-weight: 800;
  margin-bottom: 10px;
  text-transform: uppercase;
}

.login-subtitle {
  color: #666;
  margin-bottom: 30px;
  font-size: 14px;
}

.login-form input, .login-form select {
  width: 100%;
  padding: 12px;
  margin-bottom: 15px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.3s;
}

.login-form input:focus, .login-form select:focus {
  outline: none;
  border-color: var(--minerva-red);
}

.login-btn {
  width: 100%;
  padding: 12px;
  background: var(--minerva-red);
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
  margin-bottom: 10px;
}

.login-btn:hover {
  background: var(--minerva-dark);
}

.login-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.loading {
  display: none;
  margin: 20px 0;
}

.spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid var(--minerva-red);
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Connection Status */
.connection-status {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 8px 12px;
  border-radius: 20px;
  font-size: 11px;
  z-index: 10000;
  display: flex;
  align-items: center;
  gap: 6px;
}

.connection-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #4CAF50;
  animation: pulse 2s infinite;
}

.connection-status.disconnected .connection-dot {
  background: #f44336;
  animation: none;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* MAIN APP */
.main-app {
  display: none;
}

/* --- HEADER --- */
header {
  background: linear-gradient(135deg, var(--minerva-red) 0%, var(--minerva-dark) 100%);
  color: #fff; 
  padding: 12px 25px;
  display: flex; 
  justify-content: space-between; 
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.header-left h1 { 
  margin: 0; 
  font-weight: 800; 
  font-size: 26px; 
  letter-spacing: 1px; 
  line-height: 1.1; 
  text-transform: uppercase; 
}

.header-left h2 { 
  margin: 0; 
  font-weight: 400; 
  font-size: 15px; 
  opacity: 0.9; 
  margin-top: 2px; 
}

.date-display { 
  font-size: 12px; 
  opacity: 0.7; 
  margin-top: 4px; 
  font-weight: 600; 
}

.header-right {
  display: flex;
  align-items: center;
  gap: 20px;
}

.online-counter {
  background: rgba(255,255,255,0.15);
  padding: 8px 12px;
  border-radius: 20px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.online-indicator {
  width: 8px;
  height: 8px;
  background: #4CAF50;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

.user-info {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  font-size: 12px;
}

.user-role {
  background: var(--minerva-gold);
  color: var(--minerva-dark);
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 10px;
}

.logout-btn {
  background: rgba(255,255,255,0.2);
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  transition: background 0.3s;
}

.logout-btn:hover {
  background: rgba(255,255,255,0.3);
}

nav button {
  background: none; 
  border: none; 
  color: rgba(255,255,255,0.7);
  margin-left: 10px; 
  font-size: 13px; 
  cursor: pointer;
  padding: 5px 10px; 
  border-radius: 4px; 
  transition: 0.3s;
}

nav button.active { 
  background: rgba(255,255,255,0.15); 
  color: #fff; 
  font-weight: 600; 
}

/* --- CONTE√öDO --- */
section { 
  display: none; 
  padding: 15px; 
  width: 99%; 
  max-width: 100%; 
  margin: 0 auto; 
}

section.active { 
  display: block; 
}

.card {
  background: var(--card-bg); 
  border-radius: 8px;
  padding: 15px; 
  margin-bottom: 15px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  border-top: 3px solid var(--minerva-red);
}

/* ADMIN ONLY ELEMENTS */
.admin-only {
  display: none;
}

body.user-admin .admin-only {
  display: inline-block;
}

body.user-admin .admin-only.flex {
  display: flex;
}

body.user-admin .admin-only.block {
  display: block;
}

/* DEV ONLY ELEMENTS */
.dev-only {
  display: none;
}

body.user-dev .dev-only {
  display: inline-block;
}

body.user-dev .dev-only.flex {
  display: flex;
}

body.user-dev .dev-only.block {
  display: block;
}

/* --- KPI --- */
.kpi-filters-container {
  display: flex; 
  flex-wrap: wrap; 
  gap: 10px; 
  align-items: flex-end;
  background: #f8f9fa; 
  padding: 15px; 
  border-radius: 6px; 
  border: 1px solid #ddd;
  margin-bottom: 20px;
}

.filter-group { 
  display: flex; 
  flex-direction: column; 
  gap: 4px; 
}

.filter-group label { 
  font-size: 11px; 
  font-weight: bold; 
  color: #555; 
  text-transform: uppercase; 
}

.filter-group select, .filter-group input {
  padding: 6px; 
  border: 1px solid #ccc; 
  border-radius: 4px; 
  font-size: 12px; 
  min-width: 130px;
}

.filter-group button {
  padding: 6px 15px; 
  background: var(--minerva-red); 
  color: #fff; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  font-weight: bold; 
  height: 30px;
}

.filter-group button:hover { 
  background: var(--minerva-dark); 
}

.kpi-grid { 
  display: grid; 
  grid-template-columns: 1fr 1fr; 
  gap: 20px; 
}

.chart-container { 
  position: relative; 
  height: 300px; 
  width: 100%; 
}

.kpi-card-big { 
  background: #fff; 
  padding: 20px; 
  border-radius: 8px; 
  box-shadow: 0 2px 6px rgba(0,0,0,0.06); 
  border-top: 3px solid var(--minerva-gold); 
}

.sla-box { 
  text-align: center; 
  padding: 40px; 
}

.sla-value { 
  font-size: 42px; 
  font-weight: 800; 
  color: var(--minerva-red); 
}

.sla-label { 
  font-size: 16px; 
  color: #666; 
  text-transform: uppercase; 
  letter-spacing: 1px; 
}

.status-legend { 
  display: flex; 
  justify-content: center; 
  gap: 15px; 
  margin-top: 10px; 
  font-size: 12px; 
  font-weight: bold; 
}

.legend-item span { 
  display: inline-block; 
  width: 10px; 
  height: 10px; 
  border-radius: 50%; 
  margin-right: 5px; 
}

/* --- TAREFAS --- */
.task-header {
  display: grid;
  grid-template-columns: 1.8fr 1fr 0.5fr 1.2fr 0.5fr 0.5fr 0.4fr 1.4fr;
  gap: 8px; 
  padding: 0 8px 8px 8px;
  border-bottom: 2px solid #eee; 
  margin-bottom: 8px;
  font-weight: bold; 
  color: var(--minerva-red); 
  text-transform: uppercase; 
  font-size: 11px;
}

.task {
  display: grid;
  grid-template-columns: 1.8fr 1fr 0.5fr 1.2fr 0.5fr 0.5fr 0.4fr 1.4fr;
  gap: 8px; 
  align-items: center;
  background: #fff; 
  padding: 4px 8px; 
  margin-bottom: 4px;
  border: 1px solid #eee; 
  border-radius: 4px; 
  font-size: 12px;
  transition: background 0.3s;
}

.task:hover { 
  border-color: #ccc; 
}

.task span { 
  white-space: nowrap; 
  overflow: hidden; 
  text-overflow: ellipsis; 
}

/* Badges */
.prio-badge { 
  font-size: 10px; 
  padding: 2px 6px; 
  border-radius: 4px; 
  color: #fff; 
  font-weight: bold; 
  text-align: center; 
}

.p-alta { background: #dc3545; }
.p-media { background: #ffc107; color: #333; }
.p-baixa { background: #6c757d; }

.task input, .task select {
  padding: 3px 6px; 
  font-size: 11px; 
  border: 1px solid #ccc;
  border-radius: 3px; 
  width: 100%; 
  background: #fff;
}

.task input:focus, .task select:focus { 
  outline: none; 
  border-color: var(--minerva-red); 
}

.task div { 
  display: flex; 
  gap: 4px; 
}

.task button { 
  padding: 3px 8px; 
  border: none; 
  border-radius: 3px; 
  font-size: 10px; 
  color: #fff; 
  cursor: pointer; 
  font-weight: 600; 
  text-transform: uppercase; 
}

.task button:hover { 
  opacity: 0.8; 
}

button:disabled { 
  opacity: 0.3; 
  cursor: not-allowed; 
  filter: grayscale(100%); 
  pointer-events: none; 
}

.start { background: var(--info); }
.finish { background: var(--success-text); }
.partial { background: #e0a800; }
.edit { background: #666; }
.delete { background: var(--danger); }

.row-done { 
  background: var(--success-bg); 
  border-left: 3px solid var(--success-text); 
  color: var(--success-text); 
}

.row-partial { 
  background: var(--warning-bg); 
  border-left: 3px solid var(--warning-text); 
  color: var(--warning-text); 
}

/* --- BOT√ïES --- */
.actions-bar { 
  display: flex; 
  gap: 10px; 
  margin-bottom: 15px; 
}

.primary-btn { 
  background: var(--minerva-red); 
  color: #fff; 
  border: none; 
  padding: 8px 16px; 
  border-radius: 4px; 
  cursor: pointer; 
  font-weight: 600; 
}

.primary-btn:hover { 
  background: #5e0d11; 
}

.panel-btn { 
  background: #374151; 
  color: #fff; 
  border: none; 
  padding: 8px 16px; 
  border-radius: 4px; 
  cursor: pointer; 
  font-weight: 600; 
}

.panel-btn:hover { 
  background: #1f2937; 
}

.reset-btn { 
  background: #e0a800; 
  color: #fff; 
  border: none; 
  padding: 8px 16px; 
  border-radius: 4px; 
  cursor: pointer; 
  font-weight: 600; 
}

.reset-btn:hover { 
  background: #d39e00; 
}

.clear-btn { 
  background: var(--danger); 
  color: #fff; 
  padding: 5px 10px; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  font-weight: bold; 
  font-size: 11px; 
}

.save-btn { 
  background: #28a745; 
  color: #fff; 
  border: none; 
  padding: 8px 16px; 
  border-radius: 4px; 
  cursor: pointer; 
  font-weight: 600; 
  width: 100%; 
  margin-top: 10px; 
}

.save-btn:hover { 
  background: #218838; 
}

.excel-btn { 
  background: #217346; 
  color: #fff; 
  padding: 6px 12px; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  font-weight: bold; 
  font-size: 11px; 
  margin-right: 5px; 
}

.excel-btn:hover { 
  background: #154b2e; 
}

.kpi-filters-container .excel-btn { 
  height: 30px; 
}

/* Hist√≥rico */
.history-container { 
  max-height: 300px; 
  overflow-y: auto; 
  border: 1px solid #eee; 
  border-radius: 4px; 
}

.table { 
  width: 100%; 
  border-collapse: collapse; 
  font-size: 12px; 
}

.table th { 
  background: #fff; 
  position: sticky; 
  top: 0; 
  z-index: 1; 
  text-align: left; 
  padding: 6px 8px; 
  border-bottom: 2px solid #eee; 
}

.table td { 
  border-bottom: 1px solid #eee; 
  padding: 6px 8px; 
}

/* Modais */
.modal { 
  position: fixed; 
  inset: 0; 
  background: rgba(0,0,0,0.6); 
  display: none; 
  align-items: center; 
  justify-content: center; 
  z-index: 1000; 
}

.modal-content { 
  background: #fff; 
  padding: 20px; 
  border-radius: 8px; 
  width: 500px; 
  max-height: 90vh; 
  overflow-y: auto; 
  box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
}

.modal h3 { 
  margin-top: 0; 
  color: var(--minerva-red); 
}

.modal-content input, .modal-content select { 
  width: 100%; 
  padding: 8px; 
  margin-bottom: 10px; 
  border: 1px solid #ccc; 
  border-radius: 4px; 
}

/* Painel Gerencial */
.panel-section { 
  margin-bottom: 25px; 
  border-bottom: 1px solid #eee; 
  padding-bottom: 15px; 
}

.panel-section:last-child { 
  border-bottom: none; 
}

.panel-title { 
  font-size: 14px; 
  font-weight: bold; 
  color: var(--text-main); 
  margin-bottom: 10px; 
}

/* Listas */
.list-container { 
  max-height: 150px; 
  overflow-y: auto; 
  margin-bottom: 15px; 
  border: 1px solid #eee; 
  border-radius: 4px; 
}

.list-item { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  padding: 8px; 
  border-bottom: 1px solid #eee; 
}

.list-item:last-child { 
  border-bottom: none; 
}

.icon-btn { 
  cursor: pointer; 
  padding: 4px 8px; 
  font-size: 12px; 
  margin-left: 5px; 
  border-radius: 3px; 
  border: none; 
  color: #fff; 
}

.btn-edit { 
  background: #666; 
}

.btn-del { 
  background: var(--danger); 
}

.btn-lock { 
  background: #999; 
  cursor: not-allowed; 
}

/* Governance Log */
.governance-section {
  margin-bottom: 20px;
}

.governance-log {
  max-height: 250px;
  overflow-y: auto;
  border: 1px solid #eee;
  border-radius: 4px;
  background: #f9f9f9;
}

.log-entry {
  padding: 8px 12px;
  border-bottom: 1px solid #e0e0e0;
  font-size: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.log-entry:last-child {
  border-bottom: none;
}

.log-timestamp {
  color: #666;
  font-size: 11px;
}

.log-action {
  font-weight: 600;
}

.log-details {
  color: #555;
}

/* Responsive */
@media (max-width: 768px) {
  .kpi-grid {
    grid-template-columns: 1fr;
  }
  
  .header-right {
    flex-direction: column;
    gap: 10px;
  }
}

/* Toast notifications */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--minerva-red);
  color: white;
  padding: 12px 20px;
  border-radius: 6px;
  z-index: 10000;
  animation: slideIn 0.3s ease-out;
}

.toast.success {
  background: #28a745;
}

.toast.error {
  background: #dc3545;
}

.toast.warning {
  background: #ffc107;
  color: #333;
}

@keyframes slideIn {
  from { transform: translateX(100%); }
  to { transform: translateX(0); }
}

/* Master Badge */
.user-role.master {
  background: linear-gradient(45deg, #FFD700, #FFA500);
  color: #333;
  text-shadow: 0 1px 1px rgba(255,255,255,0.5);
  border: 1px solid #FFD700;
}
</style>
</head>

<body>

<!-- Connection Status -->
<div class="connection-status" id="connectionStatus">
  <div class="connection-dot"></div>
  <span id="connectionText">Conectando...</span>
</div>

<!-- LOGIN OVERLAY -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-container">
    <div class="login-logo">Minerva Foods</div>
    <div class="login-subtitle">Controle de Rotinas Operacionais</div>
    
    <div class="login-form">
      <input type="email" id="loginEmail" placeholder="E-mail corporativo" autocomplete="email">
      <input type="password" id="loginPassword" placeholder="Senha" autocomplete="current-password">
      
      <button class="login-btn" id="loginBtn" onclick="loginUser()">üöÄ ENTRAR NO SISTEMA</button>
      
      <div class="loading" id="loginLoading">
        <div class="spinner"></div>
        <p>Conectando...</p>
      </div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div class="main-app" id="mainApp">

<header>
  <div class="header-left">
    <h1>Minerva Foods</h1>
    <h2>Controle de rotinas Operacionais Estoque</h2>
    <div class="date-display" id="dateDisplay"></div>
  </div>
  
  <div class="header-right">
    <div class="online-counter">
      <div class="online-indicator"></div>
      <span id="onlineCount">0 online</span>
    </div>
    
    <div class="user-info">
      <div id="userDisplayName">Usu√°rio</div>
      <div class="user-role" id="userRole">USER</div>
    </div>
    
    <button class="logout-btn" onclick="logoutUser()">Sair</button>
  </div>
  
  <nav>
    <button class="active" onclick="openTab('pc')">ROTINAS OPERACIONAIS</button>
    <button onclick="openTab('analistas')">ROTINAS ANALISTAS</button>
    <button onclick="openTab('kpi')">üìä KPI / DASHBOARD</button>
    <button class="admin-only dev-only" onclick="openTab('governance')">üìã GOVERNAN√áA</button>
  </nav>
</header>

<!-- SE√á√ÉO PC -->
<section id="pc" class="active">
  <div class="card">
    <div class="actions-bar">
      <button class="primary-btn admin-only dev-only" onclick="openModal('pc')">+ NOVA ROTINA</button>
      <button class="panel-btn admin-only dev-only" onclick="openManagementPanel('pc')">‚öôÔ∏è PAINEL GERENCIAL</button>
      <button class="reset-btn admin-only dev-only" onclick="resetRotinas('pc')">REINICIAR ROTINAS</button>
    </div>

    <div class="task-header">
      <span>Rotina</span>
      <span>Analista</span>
      <span>Prioridade</span>
      <span>Status/Justificativa</span>
      <span>In√≠cio</span>
      <span>Fim</span>
      <span>%</span>
      <span>A√ß√µes</span>
    </div>

    <div id="tasks"></div>
  </div>
</section>

<!-- SE√á√ÉO ANALISTAS -->
<section id="analistas">
  <div class="card">
    <div class="actions-bar">
      <button class="primary-btn admin-only dev-only" onclick="openModal('analistas')">+ NOVA ROTINA (ANALISTA)</button>
      <button class="panel-btn admin-only dev-only" onclick="openManagementPanel('analistas')">‚öôÔ∏è PAINEL GERENCIAL</button>
      <button class="reset-btn admin-only dev-only" onclick="resetRotinas('analistas')">REINICIAR ROTINAS</button>
    </div>

    <div class="task-header">
      <span>Rotina</span>
      <span>Analista</span>
      <span>Prioridade</span>
      <span>Status/Justificativa</span>
      <span>In√≠cio</span>
      <span>Fim</span>
      <span>%</span>
      <span>A√ß√µes</span>
    </div>

    <div id="tasksAnalistas"></div>
  </div>
</section>

<!-- SE√á√ÉO KPI -->
<section id="kpi">
  <div class="card">
    <h3 style="margin:0 0 10px 0; color:var(--minerva-red)">Dashboard de Performance</h3>

    <div class="kpi-filters-container">
      <div class="filter-group">
        <label>Data In√≠cio:</label>
        <input type="date" id="kpiDateStart" onchange="updateCharts()">
      </div>
      <div class="filter-group">
        <label>Data Fim:</label>
        <input type="date" id="kpiDateEnd" onchange="updateCharts()">
      </div>
      <div class="filter-group">
        <label>Tipo de Rotina:</label>
        <select id="kpiFilter" onchange="updateCharts()">
          <option value="all">Vis√£o Geral (Todos)</option>
          <option value="pc">Operacionais</option>
          <option value="analistas">Analistas</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Analista:</label>
        <select id="kpiAnalista" onchange="updateCharts()">
          <option value="">Todos</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Status:</label>
        <select id="kpiStatus" onchange="updateCharts()">
          <option value="all">Todos (Conclu√≠dos/Parciais)</option>
          <option value="done">Apenas Conclu√≠dos</option>
          <option value="partial">Apenas Parciais</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Prioridade:</label>
        <select id="kpiPrioridade" onchange="updateCharts()">
          <option value="all">Todas</option>
          <option value="alta">Alta</option>
          <option value="media">M√©dia</option>
          <option value="baixa">Baixa</option>
        </select>
      </div>

      <div class="filter-group">
        <label>&nbsp;</label>
        <button onclick="updateCharts()">Filtrar</button>
      </div>

      <div class="filter-group admin-only dev-only">
        <label>&nbsp;</label>
        <button class="excel-btn" onclick="exportKpiDashboardToExcel()">üì• EXCEL (DASHBOARD)</button>
      </div>
    </div>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card-big">
      <h3 style="text-align:center; color:var(--text-main); margin-bottom:15px;">üìä Status (Per√≠odo Selecionado)</h3>
      <div class="chart-container">
        <canvas id="chartStatus"></canvas>
      </div>
      <div id="statusLegend" class="status-legend"></div>
    </div>

    <div class="kpi-card-big">
      <h3 style="text-align:center; color:var(--text-main); margin-bottom:15px;">üèÜ Ranking de Produtividade</h3>
      <div class="chart-container">
        <canvas id="chartRanking"></canvas>
      </div>
    </div>

    <div class="kpi-card-big">
      <h3 style="text-align:center; color:var(--text-main); margin-bottom:15px;">üõë Top Motivos (Paradas)</h3>
      <div class="chart-container">
        <canvas id="chartMotivos"></canvas>
      </div>
    </div>

    <div class="kpi-card-big">
      <h3 style="text-align:center; color:var(--text-main); margin-bottom:15px;">‚ö° Velocidade M√©dia (SLA)</h3>
      <div class="sla-box">
        <div id="slaValue" class="sla-value">00h 00m 00s</div>
        <div class="sla-label">Tempo M√©dio por Tarefa</div>
        <p style="font-size:12px; color:#999; margin-top:10px;">Considera apenas tarefas conclu√≠das.</p>
      </div>
    </div>
  </div>
</section>

<!-- SE√á√ÉO GOVERNAN√áA (ADMIN/DEV ONLY) -->
<section id="governance" class="admin-only dev-only">
  <div class="card">
    <h3 style="margin:0 0 15px 0; color:var(--minerva-red)">üìã Relat√≥rio de Governan√ßa</h3>
    
    <div class="governance-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h4>Log de A√ß√µes Administrativas</h4>
        <div>
          <button class="excel-btn" onclick="exportGovernanceToExcel()">üì• EXCEL</button>
          <button class="clear-btn" onclick="clearGovernanceLog()">LIMPAR LOG</button>
        </div>
      </div>
      
      <div class="governance-log" id="governanceLog">
        <!-- Logs will be populated here -->
      </div>
    </div>
    
    <div class="governance-section">
      <h4>Estat√≠sticas de Uso</h4>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: var(--minerva-red);" id="totalActions">0</div>
          <div style="font-size: 12px; color: #666;">A√ß√µes Totais</div>
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: var(--minerva-red);" id="totalAdmins">0</div>
          <div style="font-size: 12px; color: #666;">Usu√°rios Online</div>
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: var(--minerva-red);" id="todayActions">0</div>
          <div style="font-size: 12px; color: #666;">A√ß√µes Hoje</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- HIST√ìRICO -->
<div class="card" style="width: 99%; margin: 0 auto 20px auto;" id="historyCard">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <h3 style="margin:0; color:var(--minerva-red)">Hist√≥rico de Execu√ß√£o - <span id="historyTitle">OPERACIONAIS</span></h3>
    <div>
      <button class="excel-btn admin-only dev-only" onclick="exportToExcel()">üì• EXCEL (ATUAL)</button>
      <button class="clear-btn admin-only dev-only" onclick="clearHistory()">LIMPAR HIST√ìRICO</button>
    </div>
  </div>

  <div class="history-container">
    <table class="table" id="historyTable">
      <thead>
        <tr><th>Data</th><th>Rotina</th><th>Analista</th><th>Prioridade</th><th>Status/Justificativa</th><th>In√≠cio</th><th>Fim</th><th>Dura√ß√£o</th><th>%</th><th>Status</th></tr>
      </thead>
      <tbody id="history"></tbody>
    </table>
  </div>
</div>

<!-- Modal Nova/Editar Rotina -->
<div class="modal" id="modal">
  <div class="modal-content" style="width: 400px;">
    <h3 id="modalTitle">Gerenciar Rotina</h3>
    <input id="rotinaInput" placeholder="Nome da rotina...">
    <select id="rotinaPrio">
      <option value="alta">üî• Alta</option>
      <option value="media" selected>üü° M√©dia</option>
      <option value="baixa">üîµ Baixa</option>
    </select>
    <div style="text-align: right;">
      <button class="primary-btn" style="background:#ccc; color:#333;" onclick="closeModal()">Cancelar</button>
      <button class="primary-btn" onclick="saveRotina()">Salvar</button>
    </div>
  </div>
</div>

<!-- Modal Painel Gerencial -->
<div class="modal" id="panelModal">
  <div class="modal-content">
    <h3>Painel Gerencial</h3>

    <div id="sectionPrio" class="panel-section">
      <div class="panel-title">üî• Prioridades das Rotinas (<span id="panelContextTitle"></span>)</div>
      <div class="list-container" id="prioList" style="max-height: 150px;"></div>
      <button class="save-btn" onclick="savePriorities()">üíæ SALVAR PRIORIDADES</button>
    </div>

    <div id="sectionMotivos" class="panel-section">
      <div class="panel-title">üìã Motivos de Status/Justificativa</div>
      <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input id="newMotivoInput" placeholder="Novo Motivo..." style="margin-bottom:0;">
        <button class="primary-btn" onclick="addMotivo()">Adicionar</button>
      </div>
      <div class="list-container" id="motivosList"></div>
    </div>

    <div id="sectionTeam" class="panel-section">
      <div class="panel-title">üë• Equipe Operacional</div>
      <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input id="newAnalistaInput" placeholder="Novo Analista..." style="margin-bottom:0;">
        <button class="primary-btn" onclick="addAnalista()">Adicionar</button>
      </div>
      <div class="list-container" id="teamList"></div>
    </div>

    <div style="text-align: right; margin-top:10px;">
      <button class="primary-btn" style="background:#ccc; color:#333;" onclick="closePanelModal()">Fechar Painel</button>
    </div>
  </div>
</div>

</div>

<script>
// ===========================
// CONFIGURA√á√ÉO DO FIREBASE
// ===========================

// Configure com suas credenciais do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDg92nX83l0yAA2KjjRgIB-m-C-a8YywYo",
  authDomain: "rotinas-estoque.firebaseapp.com",
  databaseURL: "https://rotinas-estoque-default-rtdb.firebaseio.com",
  projectId: "rotinas-estoque",
  storageBucket: "rotinas-estoque.firebasestorage.app",
  messagingSenderId: "1094421347742",
  appId: "1:1094421347742:web:9fc64ec3c4226b7df2aa8f",
  measurementId: "G-YMWTY70911"
};

// ATEN√á√ÉO: Configure as credenciais reais do Firebase aqui ‚òùÔ∏è

// Inicializar Firebase
let app, db, isFirebaseConnected = false;

try {
  app = firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  isFirebaseConnected = true;
  updateConnectionStatus(true, 'Online - Conectado ao Firebase');
} catch (error) {
  console.error('Erro ao conectar com Firebase:', error);
  updateConnectionStatus(false, 'Offline - Usando dados locais');
}

function updateConnectionStatus(connected, message) {
  const statusEl = document.getElementById('connectionStatus');
  const textEl = document.getElementById('connectionText');
  
  if (connected) {
    statusEl.classList.remove('disconnected');
  } else {
    statusEl.classList.add('disconnected');
  }
  
  textEl.textContent = message;
}

// ===========================
// DADOS DEMO E CONFIGURA√á√ïES
// ===========================

// Usu√°rios do sistema - CREDENCIAIS MANTIDAS EXATAMENTE COMO SOLICITADO
const DEMO_USERS = {
  'roni.silva@minervafoods.com': { 
    password: 'picanha@123', 
    role: 'admin', 
    name: 'Roni Silva',
    displayRole: 'ADMIN'
  },
  'analistas@minervafoods.com': { 
    password: 'estoque1234', 
    role: 'user', 
    name: 'Equipe Analistas',
    displayRole: 'USER'
  },
  'diego.cordeiro@minervafoods.com': { 
    password: '040293@Dmc', 
    role: 'dev', 
    name: 'Diego Cordeiro',
    displayRole: 'MASTER',
    isMaster: true
  }
};

// Vari√°veis globais
let currentUser = null;
let currentUserRole = 'user';
let currentView = 'pc';
let onlineUsers = 0;
let realTimeListeners = {};

// Dados iniciais
const DEFAULT_ROTINAS_PC = [
"FEFO SEPARA√á√ÉO ESPECIFICO","FEFO SEPARA√á√ÉO CRITICO","VENCIDOS NO ESTOQUE",
"AUDITORIA DE POSI√á√ÉO PICKING","ARMAZENAMENTO ONDA DE ABASTECIMENTO",
"PONTA DE ESTOQUE","DE-PARA PICKING","RETORNO DE CAIXAS PARA DEVOLU√á√ÉO",
"FANTASMINHA","MIGRA√á√ÉO DE ENDERE√áO PARA PERDIDOS","BAIXA PARA OPERA√á√ÉO",
"INSER√á√ÉO DE ISCAS","CONFERENCIA A√äREO","ONDA REVERSA"
];

const DEFAULT_ROTINAS_ANALISTAS = [
"FECHAMENTO DE OPS", "LAN√áAMENTO DE CUSTOS EXTRAS", "ACOMPANHAMENTO DE ANDAMENTO FEFO",
"ACOMPANHAMENTO DE VENCIDOS RETIRADOS DO ESTOQUE", "% DE DIVERGENCIA DA AUDITORIA DE POSI√á√ÉO",
"RETIRADA DE N√ÉO LOCALIZADAS", "TROCA ENTRE NEGOCIOS", "ARMAZENAGEM DA ONDA",
"ACOMPANHAMENTO PONTA DE ESTOQUE", "% DE-PARA DO PICKING", "RETIRADA DAS SOLICITA√á√ïES DE FANTASMINHA",
"BAIXA PENDENTE PARA OPERA√á√ÉO", "ISCAS INSERIDAS", "CONFER√äNCIA 429 SQL", "CONFERENCIA DO AEREO POR CAMARA"
];

const DEFAULT_ANALISTAS = ["LIVIA PORTA", "WILLIAN SILAS", "RODRIGO PRADO", "EVERTON MORAES", "PAULO AFONSO", "ERICK SALES"];
const DEFAULT_MOTIVOS = ["FALTA DE TEMPO", "SISTEMA INDISPON√çVEL", "SEM DEMANDA", "AGUARDANDO OUTRA √ÅREA"];

let rotinasPC = [];
let rotinasAnalistas = [];
let history = [];
let analistas = [...DEFAULT_ANALISTAS];
let motivos = [...DEFAULT_MOTIVOS];
let governanceLog = [];

// Chart instances
let chartStatus = null;
let chartRanking = null;
let chartMotivos = null;

const TODAY_STR = new Date().toLocaleDateString('pt-BR');
document.getElementById('dateDisplay').innerText = TODAY_STR;

// ===========================
// FIREBASE FUNCTIONS
// ===========================

async function saveToFirebase(collection, data) {
  if (!isFirebaseConnected) {
    return saveToLocalStorage(collection, data);
  }
  
  try {
    await db.collection(collection).doc('data').set(data);
    return true;
  } catch (error) {
    console.error('Erro ao salvar no Firebase:', error);
    return saveToLocalStorage(collection, data);
  }
}

async function loadFromFirebase(collection) {
  if (!isFirebaseConnected) {
    return loadFromLocalStorage(collection);
  }
  
  try {
    const doc = await db.collection(collection).doc('data').get();
    if (doc.exists) {
      return doc.data();
    }
    return null;
  } catch (error) {
    console.error('Erro ao carregar do Firebase:', error);
    return loadFromLocalStorage(collection);
  }
}

function setupRealtimeListeners() {
  if (!isFirebaseConnected || !currentUser) return;
  
  // Listener para rotinas PC
  realTimeListeners.rotinasPC = db.collection('rotinas_pc').doc('data').onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();
      rotinasPC = data.rotinas || [];
      if (currentView === 'pc') render();
    }
  });
  
  // Listener para rotinas Analistas
  realTimeListeners.rotinasAnalistas = db.collection('rotinas_analistas').doc('data').onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();
      rotinasAnalistas = data.rotinas || [];
      if (currentView === 'analistas') render();
    }
  });
  
  // Listener para hist√≥rico
  realTimeListeners.history = db.collection('history').doc('data').onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();
      history = data.history || [];
      if (currentView !== 'kpi' && currentView !== 'governance') {
        renderHistory();
        updateCharts();
      }
    }
  });
  
  // Listener para configura√ß√µes
  realTimeListeners.config = db.collection('config').doc('data').onSnapshot((doc) => {
    if (doc.exists) {
      const data = doc.data();
      analistas = data.analistas || [...DEFAULT_ANALISTAS];
      motivos = data.motivos || [...DEFAULT_MOTIVOS];
      populateAnalystFilter();
    }
  });
  
  // Listener para governan√ßa
  if (currentUserRole === 'admin' || currentUserRole === 'dev') {
    realTimeListeners.governance = db.collection('governance').doc('data').onSnapshot((doc) => {
      if (doc.exists) {
        const data = doc.data();
        governanceLog = data.log || [];
        if (currentView === 'governance') {
          renderGovernanceLog();
        }
      }
    });
  }
  
  // Listener para usu√°rios online
  setupOnlineTraking();
}

function setupOnlineTraking() {
  if (!isFirebaseConnected || !currentUser) return;
  
  const userRef = db.collection('users_online').doc(currentUser.email.replace(/[.#$[\]]/g, '_'));
  
  // Marcar usu√°rio como online
  const setUserOnline = () => {
    userRef.set({
      name: currentUser.name,
      role: currentUser.displayRole,
      email: currentUser.email,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
      isOnline: true
    });
  };
  
  // Marcar usu√°rio como offline ao sair
  const setUserOffline = () => {
    userRef.update({
      isOnline: false,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp()
    });
  };
  
  setUserOnline();
  
  // Atualizar presen√ßa a cada 30 segundos
  setInterval(setUserOnline, 30000);
  
  // Cleanup ao sair
  window.addEventListener('beforeunload', setUserOffline);
  
  // Listener para contar usu√°rios online
  realTimeListeners.usersOnline = db.collection('users_online').where('isOnline', '==', true)
    .onSnapshot((snapshot) => {
      onlineUsers = snapshot.size;
      document.getElementById('onlineCount').textContent = `${onlineUsers} online`;
      document.getElementById('totalAdmins').textContent = onlineUsers;
    });
}

function destroyRealtimeListeners() {
  Object.values(realTimeListeners).forEach(unsubscribe => {
    if (typeof unsubscribe === 'function') {
      unsubscribe();
    }
  });
  realTimeListeners = {};
  
  // Marcar usu√°rio como offline
  if (isFirebaseConnected && currentUser) {
    const userRef = db.collection('users_online').doc(currentUser.email.replace(/[.#$[\]]/g, '_'));
    userRef.update({
      isOnline: false,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
}

// Fallback para localStorage
function saveToLocalStorage(collection, data) {
  localStorage.setItem(`minerva_${collection}`, JSON.stringify(data));
  return true;
}

function loadFromLocalStorage(collection) {
  const saved = localStorage.getItem(`minerva_${collection}`);
  return saved ? JSON.parse(saved) : null;
}

// ===========================
// SISTEMA DE LOGIN
// ===========================

function loginUser() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  
  if (!email || !password) {
    showToast('Preencha email e senha', 'error');
    return;
  }
  
  const user = DEMO_USERS[email];
  if (!user || user.password !== password) {
    showToast('Email ou senha incorretos!', 'error');
    return;
  }
  
  // Simular loading
  const loginBtn = document.getElementById('loginBtn');
  const loading = document.getElementById('loginLoading');
  
  loginBtn.disabled = true;
  loading.style.display = 'block';
  
  setTimeout(() => {
    currentUser = { email, name: user.name, displayRole: user.displayRole, isMaster: user.isMaster };
    currentUserRole = user.role;
    
    setupUserInterface();
    initializeApp();
    
    loginBtn.disabled = false;
    loading.style.display = 'none';
  }, 1000);
}

function setupUserInterface() {
  document.getElementById('loginOverlay').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  
  // Configurar interface baseada no role
  let bodyClass = 'user-normal';
  if (currentUserRole === 'admin') bodyClass = 'user-admin';
  if (currentUserRole === 'dev') bodyClass = 'user-dev user-admin'; // Dev tem acesso admin tamb√©m
  
  document.body.className = bodyClass;
  
  // Atualizar informa√ß√µes do usu√°rio
  document.getElementById('userDisplayName').textContent = currentUser.name;
  const roleElement = document.getElementById('userRole');
  roleElement.textContent = currentUser.displayRole;
  
  // Badge especial para MASTER
  if (currentUser.isMaster) {
    roleElement.classList.add('master');
  }
  
  showToast(`Bem-vindo, ${currentUser.name}!`, 'success');
}

function logoutUser() {
  destroyRealtimeListeners();
  
  document.getElementById('loginOverlay').style.display = 'flex';
  document.getElementById('mainApp').style.display = 'none';
  
  // Reset
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
  
  currentUser = null;
  currentUserRole = 'user';
  
  showToast('Logout realizado com sucesso', 'success');
}

// ===========================
// INICIALIZA√á√ÉO
// ===========================

async function initializeApp() {
  await loadData();
  setupKpiFilters();
  setupRealtimeListeners();
  render();
  updateCharts();
  
  if (currentUserRole === 'admin' || currentUserRole === 'dev') {
    renderGovernanceLog();
  }
}

async function loadData() {
  try {
    // Carregar rotinas PC
    const savedPC = await loadFromFirebase('rotinas_pc');
    if (savedPC && savedPC.rotinas) {
      rotinasPC = savedPC.rotinas;
    } else {
      rotinasPC = DEFAULT_ROTINAS_PC.map((nome, i) => ({
        id: 'pc_' + i,
        nome,
        status: 'pending',
        prioridade: i < 5 ? 'alta' : i < 10 ? 'media' : 'baixa'
      }));
      await saveToFirebase('rotinas_pc', { rotinas: rotinasPC, lastUpdate: new Date() });
    }
    
    // Carregar rotinas Analistas
    const savedAnalistas = await loadFromFirebase('rotinas_analistas');
    if (savedAnalistas && savedAnalistas.rotinas) {
      rotinasAnalistas = savedAnalistas.rotinas;
    } else {
      rotinasAnalistas = DEFAULT_ROTINAS_ANALISTAS.map((nome, i) => ({
        id: 'an_' + i,
        nome,
        status: 'pending',
        prioridade: 'alta'
      }));
      await saveToFirebase('rotinas_analistas', { rotinas: rotinasAnalistas, lastUpdate: new Date() });
    }
    
    // Carregar hist√≥rico
    const savedHistory = await loadFromFirebase('history');
    history = savedHistory ? savedHistory.history || [] : [];
    
    // Carregar configura√ß√µes
    const savedConfig = await loadFromFirebase('config');
    if (savedConfig) {
      analistas = savedConfig.analistas || [...DEFAULT_ANALISTAS];
      motivos = savedConfig.motivos || [...DEFAULT_MOTIVOS];
    } else {
      await saveToFirebase('config', { analistas, motivos, lastUpdate: new Date() });
    }
    
    // Carregar governan√ßa
    const savedGov = await loadFromFirebase('governance');
    governanceLog = savedGov ? savedGov.log || [] : [];
    
    // Verificar reset di√°rio
    const lastDate = savedPC?.lastDate || '';
    if (lastDate !== TODAY_STR) {
      await resetDailyData();
    }
    
  } catch (error) {
    console.error('Erro ao carregar dados:', error);
    showToast('Erro ao carregar dados. Usando dados locais.', 'warning');
    loadLocalFallbackData();
  }
}

async function resetDailyData() {
  // Reset di√°rio das rotinas
  rotinasPC.forEach(r => {
    r.status = 'pending';
    delete r.inicio;
    delete r.fim;
    delete r.analista;
    delete r.percent;
  });
  
  rotinasAnalistas.forEach(r => {
    r.status = 'pending';
    delete r.inicio;
    delete r.fim;
    delete r.analista;
    delete r.percent;
  });
  
  await saveToFirebase('rotinas_pc', { rotinas: rotinasPC, lastDate: TODAY_STR, lastUpdate: new Date() });
  await saveToFirebase('rotinas_analistas', { rotinas: rotinasAnalistas, lastDate: TODAY_STR, lastUpdate: new Date() });
}

function loadLocalFallbackData() {
  // Carregar dados do localStorage como fallback
  const savedPC = loadFromLocalStorage('rotinas_pc');
  const savedAnalistas = loadFromLocalStorage('rotinas_analistas');
  const savedHistory = loadFromLocalStorage('history');
  const savedConfig = loadFromLocalStorage('config');
  const savedGov = loadFromLocalStorage('governance');
  
  if (savedPC) rotinasPC = savedPC.rotinas || [];
  if (savedAnalistas) rotinasAnalistas = savedAnalistas.rotinas || [];
  if (savedHistory) history = savedHistory.history || [];
  if (savedConfig) {
    analistas = savedConfig.analistas || [...DEFAULT_ANALISTAS];
    motivos = savedConfig.motivos || [...DEFAULT_MOTIVOS];
  }
  if (savedGov) governanceLog = savedGov.log || [];
}

async function saveData() {
  try {
    // Salvar todos os dados principais
    await Promise.all([
      saveToFirebase('rotinas_pc', { rotinas: rotinasPC, lastDate: TODAY_STR, lastUpdate: new Date() }),
      saveToFirebase('rotinas_analistas', { rotinas: rotinasAnalistas, lastDate: TODAY_STR, lastUpdate: new Date() }),
      saveToFirebase('history', { history, lastUpdate: new Date() }),
      saveToFirebase('config', { analistas, motivos, lastUpdate: new Date() }),
      saveToFirebase('governance', { log: governanceLog, lastUpdate: new Date() })
    ]);
  } catch (error) {
    console.error('Erro ao salvar dados:', error);
    showToast('Erro ao salvar. Dados salvos localmente.', 'warning');
    
    // Fallback para localStorage
    saveToLocalStorage('rotinas_pc', { rotinas: rotinasPC, lastDate: TODAY_STR });
    saveToLocalStorage('rotinas_analistas', { rotinas: rotinasAnalistas, lastDate: TODAY_STR });
    saveToLocalStorage('history', { history });
    saveToLocalStorage('config', { analistas, motivos });
    saveToLocalStorage('governance', { log: governanceLog });
  }
}

// ===========================
// LOGGING E GOVERNAN√áA
// ===========================

async function logGovernanceAction(action, details, target = null) {
  if (currentUserRole !== 'admin' && currentUserRole !== 'dev') return;
  
  const logEntry = {
    id: Date.now(),
    userId: currentUser.email,
    userName: currentUser.name,
    userRole: currentUser.displayRole,
    action,
    details,
    target,
    timestamp: new Date(),
    date: TODAY_STR
  };
  
  governanceLog.unshift(logEntry);
  
  // Manter apenas os √∫ltimos 100 logs
  if (governanceLog.length > 100) {
    governanceLog = governanceLog.slice(0, 100);
  }
  
  await saveToFirebase('governance', { log: governanceLog, lastUpdate: new Date() });
  
  if (currentView === 'governance') {
    renderGovernanceLog();
  }
}

function renderGovernanceLog() {
  const logContainer = document.getElementById('governanceLog');
  if (!logContainer) return;
  
  if (governanceLog.length === 0) {
    logContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Nenhuma a√ß√£o registrada</div>';
    return;
  }
  
  logContainer.innerHTML = governanceLog.map(log => {
    const timestamp = new Date(log.timestamp).toLocaleString('pt-BR');
    const roleColor = log.userRole === 'MASTER' ? 'color: #FFD700; font-weight: bold;' : 
                     log.userRole === 'ADMIN' ? 'color: var(--minerva-red);' : '';
    return `
      <div class="log-entry">
        <div>
          <div class="log-action">${log.action}</div>
          <div class="log-details">${log.details}</div>
          <small style="color:#888;">Por: <span style="${roleColor}">${log.userName} (${log.userRole})</span></small>
        </div>
        <div class="log-timestamp">${timestamp}</div>
      </div>
    `;
  }).join('');
  
  // Atualizar estat√≠sticas
  document.getElementById('totalActions').textContent = governanceLog.length;
  document.getElementById('todayActions').textContent = 
    governanceLog.filter(log => log.date === TODAY_STR).length;
}

async function exportGovernanceToExcel() {
  showToast('Exportando relat√≥rio de governan√ßa...', 'success');
}

async function clearGovernanceLog() {
  if (!confirm('Limpar todo o log de governan√ßa?')) return;
  
  governanceLog = [];
  await logGovernanceAction('CLEAR_LOG', 'Log de governan√ßa limpo');
  renderGovernanceLog();
  showToast('Log de governan√ßa limpo', 'success');
}

// ===========================
// GERENCIAMENTO DE ROTINAS
// ===========================

let currentContext = 'pc';
let currentEditId = null;

async function startTask(context, index) {
  const list = context === 'pc' ? rotinasPC : rotinasAnalistas;
  const task = list[index];
  
  const analistaSelect = document.getElementById(`analista-${context}-${index}`);
  if (!analistaSelect.value) {
    showToast('Selecione um analista!', 'warning');
    analistaSelect.focus();
    return;
  }
  
  task.inicio = new Date().toLocaleTimeString();
  task.status = 'in_progress';
  task.analista = analistaSelect.value;
  
  await saveData();
  render();
  showToast('Tarefa iniciada', 'success');
}

async function finishTask(context, index) {
  const list = context === 'pc' ? rotinasPC : rotinasAnalistas;
  const task = list[index];
  
  if (!task.inicio) {
    showToast('Rotina n√£o iniciada!', 'error');
    return;
  }
  
  const analistaSelect = document.getElementById(`analista-${context}-${index}`);
  const motivoSelect = document.getElementById(`motivo-${context}-${index}`);
  
  const analista = analistaSelect.value;
  let motivo = motivoSelect.value || "CONCLU√çDO";
  
  const fim = new Date().toLocaleTimeString();
  
  // Atualizar rotina
  task.fim = fim;
  task.status = 'done';
  
  // Salvar no hist√≥rico
  const historyEntry = {
    id: Date.now(),
    type: context,
    data: TODAY_STR,
    rotina: task.nome,
    analista,
    motivo,
    inicio: task.inicio,
    fim,
    duracao: calcDuration(task.inicio, fim),
    percent: '-',
    status: 'Conclu√≠do',
    prioridade: task.prioridade,
    timestamp: new Date()
  };
  
  history.unshift(historyEntry);
  
  await saveData();
  render();
  updateCharts();
  showToast('Tarefa conclu√≠da', 'success');
}

async function partialTask(context, index) {
  const list = context === 'pc' ? rotinasPC : rotinasAnalistas;
  const task = list[index];
  
  if (!task.inicio) {
    showToast('Rotina n√£o iniciada!', 'error');
    return;
  }
  
  const percentInput = document.querySelector(`#${context === 'pc' ? 'tasks' : 'tasksAnalistas'} .task:nth-child(${index + 1}) input[type="number"]`);
  const percent = percentInput.value;
  
  if (!percent) {
    showToast('Informe a porcentagem!', 'warning');
    percentInput.focus();
    return;
  }
  
  const analistaSelect = document.getElementById(`analista-${context}-${index}`);
  const motivoSelect = document.getElementById(`motivo-${context}-${index}`);
  
  const analista = analistaSelect.value;
  let motivo = motivoSelect.value;
  
  if (!motivo) {
    showToast('Selecione um motivo para finalizar como PARCIAL!', 'warning');
    motivoSelect.focus();
    return;
  }
  
  const fim = new Date().toLocaleTimeString();
  
  // Atualizar rotina
  task.fim = fim;
  task.status = 'partial';
  task.percent = percent;
  
  // Salvar no hist√≥rico
  const historyEntry = {
    id: Date.now(),
    type: context,
    data: TODAY_STR,
    rotina: task.nome,
    analista,
    motivo,
    inicio: task.inicio,
    fim,
    duracao: calcDuration(task.inicio, fim),
    percent: percent + '%',
    status: 'Parcial',
    prioridade: task.prioridade,
    timestamp: new Date()
  };
  
  history.unshift(historyEntry);
  
  await saveData();
  render();
  updateCharts();
  showToast('Tarefa marcada como parcial', 'success');
}

// ===========================
// INTERFACE E RENDERING
// ===========================

function openTab(id) {
  currentView = id;
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  
  const btns = document.querySelectorAll("nav button");
  if (id === 'pc') btns[0].classList.add("active");
  else if (id === 'analistas') btns[1].classList.add("active");
  else if (id === 'kpi') btns[2].classList.add("active");
  else if (id === 'governance') btns[3].classList.add("active");
  
  const histCard = document.getElementById("historyCard");
  if (id === 'kpi' || id === 'governance') {
    histCard.style.display = 'none';
    if (id === 'kpi') updateCharts();
    if (id === 'governance') renderGovernanceLog();
  } else {
    histCard.style.display = 'block';
    render();
  }
}

function render() {
  renderList('pc', rotinasPC, document.getElementById("tasks"));
  renderList('analistas', rotinasAnalistas, document.getElementById("tasksAnalistas"));
  document.getElementById("historyTitle").innerText = currentView === 'pc' ? 'OPERACIONAIS' : 'ANALISTAS';
  renderHistory();
}

function renderList(context, list, container) {
  container.innerHTML = "";
  const options = `<option value="">Selecione...</option>` + analistas.map(a => `<option value="${a}">${a}</option>`).join('');
  const motivosOptions = motivos.map(m => `<option value="${m}">${m}</option>`).join('');
  
  list.forEach((r, i) => {
    let rowClass = "task";
    if (r.status === 'done') rowClass += " row-done";
    else if (r.status === 'partial') rowClass += " row-partial";
    
    let badgeClass = "p-media";
    let badgeText = "M√©dia";
    if (r.prioridade === 'alta') { badgeClass = "p-alta"; badgeText = "ALTA"; }
    if (r.prioridade === 'baixa') { badgeClass = "p-baixa"; badgeText = "Baixa"; }
    
    const hasAdminAccess = currentUserRole === 'admin' || currentUserRole === 'dev';
    
    container.innerHTML += `
    <div class="${rowClass}">
      <span title="${r.nome}">${r.nome}</span>
      <select id="analista-${context}-${i}">${options}</select>
      <div class="prio-badge ${badgeClass}">${badgeText}</div>
      <select id="motivo-${context}-${i}" style="width:100%">
        <option value="">-- Selecione --</option>
        ${motivosOptions}
      </select>
      <span class="inicio">${r.inicio || "-"}</span>
      <span class="fim">${r.fim || "-"}</span>
      <input type="number" min="1" max="99" placeholder="%" value="${r.percent || ''}">
      <div>
        <button class="start" ${r.status !== 'pending' ? 'disabled style="display:none"' : ''} onclick="startTask('${context}', ${i})">Iniciar</button>
        <button class="partial" ${r.status === 'pending' ? 'disabled' : ''} onclick="partialTask('${context}', ${i})">Parcial</button>
        <button class="finish" ${r.status === 'pending' ? 'disabled' : ''} onclick="finishTask('${context}', ${i})">Finalizar</button>
        ${hasAdminAccess ? `
          <button class="edit" onclick="editRotina('${context}', ${i})">Editar</button>
          <button class="delete" onclick="removeRotina('${context}', ${i})">Excluir</button>
        ` : ''}
      </div>
    </div>`;
    
    // Definir valores selecionados
    setTimeout(() => {
      if (r.analista) {
        const sel = document.getElementById(`analista-${context}-${i}`);
        if (sel) sel.value = r.analista;
      }
    }, 100);
  });
}

function renderHistory() {
  const filteredHistory = history.filter(h => {
    if (currentView === 'pc') return !h.type || h.type === 'pc';
    return h.type === 'analistas';
  });
  
  document.getElementById("history").innerHTML = filteredHistory.map(h => `
    <tr>
      <td>${h.data}</td>
      <td>${h.rotina}</td>
      <td>${h.analista}</td>
      <td>${h.prioridade || '-'}</td>
      <td>${h.motivo || "-"}</td>
      <td>${h.inicio}</td>
      <td>${h.fim}</td>
      <td>${h.duracao}</td>
      <td>${h.percent}</td>
      <td>${h.status}</td>
    </tr>
  `).join("");
}

// ===========================
// MODAIS
// ===========================

const modal = document.getElementById("modal");
const panelModal = document.getElementById("panelModal");

function openModal(context) {
  if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
    showToast('Acesso negado', 'error');
    return;
  }
  
  currentContext = context;
  currentEditId = null;
  document.getElementById('rotinaInput').value = "";
  document.getElementById('rotinaPrio').value = "media";
  modal.style.display = "flex";
}

function closeModal() {
  modal.style.display = "none";
}

async function saveRotina() {
  const nome = document.getElementById('rotinaInput').value.trim();
  const prioridade = document.getElementById('rotinaPrio').value;
  
  if (!nome) {
    showToast('Informe o nome da rotina', 'error');
    return;
  }
  
  const list = currentContext === 'pc' ? rotinasPC : rotinasAnalistas;
  
  if (currentEditId !== null) {
    // Editar
    const task = list.find(t => t.id === currentEditId);
    if (task) {
      const oldName = task.nome;
      task.nome = nome;
      task.prioridade = prioridade;
      
      await logGovernanceAction('UPDATE_ROUTINE', `Rotina atualizada: ${oldName} -> ${nome}`, currentContext);
    }
  } else {
    // Nova
    const newTask = {
      id: currentContext + '_' + Date.now(),
      nome,
      prioridade,
      status: 'pending'
    };
    list.push(newTask);
    
    await logGovernanceAction('CREATE_ROUTINE', `Nova rotina criada: ${nome}`, currentContext);
  }
  
  closeModal();
  await saveData();
  render();
  showToast('Rotina salva com sucesso', 'success');
}

function editRotina(context, i) {
  if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
    showToast('Acesso negado', 'error');
    return;
  }
  
  const list = context === 'pc' ? rotinasPC : rotinasAnalistas;
  const task = list[i];
  
  currentContext = context;
  currentEditId = task.id;
  document.getElementById('rotinaInput').value = task.nome;
  document.getElementById('rotinaPrio').value = task.prioridade;
  modal.style.display = "flex";
}

async function removeRotina(context, i) {
  if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
    showToast('Acesso negado', 'error');
    return;
  }
  
  if (!confirm("Excluir rotina?")) return;
  
  const list = context === 'pc' ? rotinasPC : rotinasAnalistas;
  const task = list[i];
  
  list.splice(i, 1);
  
  await logGovernanceAction('DELETE_ROUTINE', `Rotina removida: ${task.nome}`, context);
  await saveData();
  render();
  showToast('Rotina removida', 'success');
}

async function resetRotinas(context) {
  if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
    showToast('Acesso negado', 'error');
    return;
  }
  
  if (!confirm(`Reiniciar todas as rotinas de ${context === 'pc' ? 'OPERACIONAIS' : 'ANALISTAS'}?`)) return;
  
  const list = context === 'pc' ? rotinasPC : rotinasAnalistas;
  
  list.forEach(r => {
    r.status = 'pending';
    delete r.inicio;
    delete r.fim;
    delete r.percent;
    delete r.analista;
  });
  
  await logGovernanceAction('RESET_ROUTINES', `Rotinas reiniciadas: ${context}`);
  await saveData();
  render();
  showToast('Rotinas reiniciadas', 'success');
}

async function clearHistory() {
  if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
    showToast('Acesso negado', 'error');
    return;
  }
  
  if (!confirm(`Apagar hist√≥rico da aba ${currentView === 'pc' ? 'OPERACIONAIS' : 'ANALISTAS'}?`)) return;
  
  const initialLength = history.length;
  history = history.filter(h => {
    if (currentView === 'pc') return h.type === 'analistas';
    return !h.type || h.type === 'pc';
  });
  
  const removedCount = initialLength - history.length;
  
  await logGovernanceAction('CLEAR_HISTORY', `Hist√≥rico limpo: ${currentView} (${removedCount} itens)`);
  await saveData();
  renderHistory();
  updateCharts();
  showToast('Hist√≥rico limpo', 'success');
}

// ===========================
// PAINEL GERENCIAL
// ===========================

function openManagementPanel(context) {
  if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
    showToast('Acesso negado', 'error');
    return;
  }
  
  currentContext = context;
  document.getElementById('panelContextTitle').innerText = context === 'pc' ? "OPERACIONAIS" : "ANALISTAS";
  
  renderPrioList();
  renderTeamList();
  renderMotivosList();
  
  panelModal.style.display = "flex";
}

async function closePanelModal() {
  panelModal.style.display = "none";
  await saveData();
}

function renderPrioList() {
  const list = currentContext === 'pc' ? rotinasPC : rotinasAnalistas;
  document.getElementById('prioList').innerHTML = list.map((r, i) => `
    <div class="list-item">
      <span style="font-size:12px;">${r.nome}</span>
      <select onchange="tempChangePriority('${r.id}', this.value)" style="width:100px; padding:4px;">
        <option value="alta" ${r.prioridade === 'alta' ? 'selected' : ''}>üî• Alta</option>
        <option value="media" ${r.prioridade === 'media' ? 'selected' : ''}>üü° M√©dia</option>
        <option value="baixa" ${r.prioridade === 'baixa' ? 'selected' : ''}>üîµ Baixa</option>
      </select>
    </div>
  `).join("");
}

function tempChangePriority(taskId, value) {
  const list = currentContext === 'pc' ? rotinasPC : rotinasAnalistas;
  const task = list.find(t => t.id === taskId);
  if (task) {
    task.prioridade = value;
  }
}

async function savePriorities() {
  await logGovernanceAction('UPDATE_PRIORITIES', `Prioridades atualizadas: ${currentContext}`);
  await saveData();
  render();
  showToast('Prioridades salvas!', 'success');
}

function renderTeamList() {
  document.getElementById('teamList').innerHTML = analistas.map((a, i) => `
    <div class="list-item">
      <span>${a}</span>
      <div>
        <button class="icon-btn btn-edit" onclick="editAnalista(${i})">Editar</button>
        <button class="icon-btn btn-del" onclick="deleteAnalista(${i})">X</button>
      </div>
    </div>
  `).join("");
}

function renderMotivosList() {
  document.getElementById('motivosList').innerHTML = motivos.map((m, i) => `
    <div class="list-item">
      <span>${m}</span>
      <button class="icon-btn btn-del" onclick="deleteMotivo(${i})">X</button>
    </div>
  `).join("");
}

async function addAnalista() {
  const input = document.getElementById('newAnalistaInput');
  const nome = input.value.trim().toUpperCase();
  
  if (!nome) return;
  
  if (analistas.includes(nome)) {
    showToast('Analista j√° existe', 'warning');
    return;
  }
  
  analistas.push(nome);
  input.value = '';
  
  await logGovernanceAction('ADD_ANALYST', `Analista adicionado: ${nome}`);
  await saveData();
  renderTeamList();
  populateAnalystFilter();
  showToast('Analista adicionado', 'success');
}

async function addMotivo() {
  const input = document.getElementById('newMotivoInput');
  const motivo = input.value.trim().toUpperCase();
  
  if (!motivo) return;
  
  if (motivos.includes(motivo)) {
    showToast('Motivo j√° existe', 'warning');
    return;
  }
  
  motivos.push(motivo);
  input.value = '';
  
  await logGovernanceAction('ADD_REASON', `Motivo adicionado: ${motivo}`);
  await saveData();
  renderMotivosList();
  showToast('Motivo adicionado', 'success');
}

async function deleteAnalista(i) {
  if (!confirm("Remover analista?")) return;
  
  const name = analistas[i];
  analistas.splice(i, 1);
  
  await logGovernanceAction('DELETE_ANALYST', `Analista removido: ${name}`);
  await saveData();
  renderTeamList();
  populateAnalystFilter();
  showToast('Analista removido', 'success');
}

async function deleteMotivo(i) {
  if (!confirm("Remover motivo?")) return;
  
  const motivo = motivos[i];
  motivos.splice(i, 1);
  
  await logGovernanceAction('DELETE_REASON', `Motivo removido: ${motivo}`);
  await saveData();
  renderMotivosList();
  showToast('Motivo removido', 'success');
}

async function editAnalista(i) {
  const nome = prompt("Nome:", analistas[i]);
  if (nome) {
    const oldName = analistas[i];
    analistas[i] = nome.toUpperCase();
    
    await logGovernanceAction('EDIT_ANALYST', `Analista editado: ${oldName} -> ${nome}`);
    await saveData();
    renderTeamList();
    populateAnalystFilter();
    showToast('Analista editado', 'success');
  }
}

// ===========================
// EXPORT EXCEL
// ===========================

function exportToExcel() {
  if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
    showToast('Acesso negado', 'error');
    return;
  }
  
  const filteredHistory = history.filter(h => {
    if (currentView === 'pc') return !h.type || h.type === 'pc';
    return h.type === 'analistas';
  });
  
  let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
    <head><meta charset="utf-8"></head>
    <body>
      <table border="1">
        <thead>
          <tr style="background-color:#7A1417; color:#fff;">
            <th>Data</th><th>Rotina</th><th>Analista</th><th>Prioridade</th><th>Status/Justificativa</th>
            <th>In√≠cio</th><th>Fim</th><th>Dura√ß√£o</th><th>%</th><th>Status</th>
          </tr>
        </thead>
        <tbody>`;
  
  filteredHistory.forEach(h => {
    html += `<tr>
      <td>${h.data}</td><td>${h.rotina}</td><td>${h.analista}</td><td>${h.prioridade || "-"}</td>
      <td>${h.motivo || ""}</td><td>${h.inicio}</td><td>${h.fim}</td><td>${h.duracao}</td>
      <td>${h.percent}</td><td>${h.status}</td>
    </tr>`;
  });
  
  html += `</tbody></table></body></html>`;
  
  const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const contextName = currentView === 'pc' ? 'OPERACIONAIS' : 'ANALISTAS';
  a.download = `Relatorio_${contextName}_${TODAY_STR.replace(/\//g, '-')}.xls`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function exportKpiDashboardToExcel() {
  if (currentUserRole !== 'admin' && currentUserRole !== 'dev') {
    showToast('Acesso negado', 'error');
    return;
  }
  
  showToast('Exportando dashboard KPI...', 'success');
}

// ===========================
// KPI E CHARTS
// ===========================

function setupKpiFilters() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('kpiDateStart').value = today;
  document.getElementById('kpiDateEnd').value = today;
  
  populateAnalystFilter();
}

function populateAnalystFilter() {
  const select = document.getElementById('kpiAnalista');
  if (!select) return;
  
  const currentValue = select.value;
  select.innerHTML = '<option value="">Todos</option>';
  
  analistas.forEach(a => {
    const option = document.createElement('option');
    option.value = a;
    option.textContent = a;
    select.appendChild(option);
  });
  
  if (currentValue) select.value = currentValue;
}

function updateCharts() {
  const filteredHistory = filterHistoryForKpi();
  
  let countDone = 0, countPartial = 0;
  const rankingMap = {};
  const motivosMap = {};
  let totalSeconds = 0, slaCount = 0;
  
  filteredHistory.forEach(h => {
    if (h.status === 'Conclu√≠do') countDone++;
    else if (h.status === 'Parcial') countPartial++;
    
    // Ranking
    if (!rankingMap[h.analista]) rankingMap[h.analista] = 0;
    rankingMap[h.analista]++;
    
    // Motivos
    const motivo = h.motivo || "";
    if (motivo !== "CONCLU√çDO" && motivo !== "PARCIAL" && motivo !== "") {
      if (!motivosMap[motivo]) motivosMap[motivo] = 0;
      motivosMap[motivo]++;
    }
    
    // SLA
    if (h.status === 'Conclu√≠do' && h.duracao !== "-") {
      const durStr = h.duracao;
      let hours = 0, mins = 0, secs = 0;
      let hMatch = durStr.match(/(\d+)h/); 
      if (hMatch) hours = parseInt(hMatch[1]);
      let mMatch = durStr.match(/(\d+)m/); 
      if (mMatch) mins = parseInt(mMatch[1]);
      let sMatch = durStr.match(/(\d+)s/); 
      if (sMatch) secs = parseInt(sMatch[1]);
      
      if (hours > 0 || mins > 0 || secs > 0) {
        totalSeconds += (hours * 3600) + (mins * 60) + secs;
        slaCount++;
      }
    }
  });
  
  // Update status legend
  document.getElementById("statusLegend").innerHTML = `
    <div class="legend-item"><span style="background:#0f5132"></span>Conclu√≠das: ${countDone}</div>
    <div class="legend-item"><span style="background:#f9a825"></span>Parciais: ${countPartial}</div>
  `;
  
  // Update SLA
  if (slaCount > 0) {
    const avg = totalSeconds / slaCount;
    const h = Math.floor(avg / 3600);
    const m = Math.floor((avg % 3600) / 60);
    const s = Math.floor(avg % 60);
    document.getElementById("slaValue").innerText = 
      `${h.toString().padStart(2, '0')}h ${m.toString().padStart(2, '0')}m ${s.toString().padStart(2, '0')}s`;
  } else {
    document.getElementById("slaValue").innerText = "00h 00m 00s";
  }
  
  // Update charts
  updateStatusChart(countDone, countPartial);
  updateRankingChart(rankingMap);
  updateMotivosChart(motivosMap);
}

function filterHistoryForKpi() {
  const dateStart = document.getElementById('kpiDateStart').value;
  const dateEnd = document.getElementById('kpiDateEnd').value;
  const typeFilter = document.getElementById('kpiFilter').value;
  const analistaFilter = document.getElementById('kpiAnalista').value;
  const statusFilter = document.getElementById('kpiStatus').value;
  const prioFilter = document.getElementById('kpiPrioridade').value;
  
  return history.filter(h => {
    // Filtro de data
    if (dateStart || dateEnd) {
      const hDate = parseDatePTBR(h.data);
      if (dateStart && hDate < parseDateInput(dateStart)) return false;
      if (dateEnd && hDate > parseDateInput(dateEnd)) return false;
    }
    
    // Filtro de tipo
    if (typeFilter === 'pc' && h.type === 'analistas') return false;
    if (typeFilter === 'analistas' && (!h.type || h.type === 'pc')) return false;
    
    // Filtro de analista
    if (analistaFilter && h.analista !== analistaFilter) return false;
    
    // Filtro de status
    if (statusFilter === 'done' && h.status !== 'Conclu√≠do') return false;
    if (statusFilter === 'partial' && h.status !== 'Parcial') return false;
    
    // Filtro de prioridade
    if (prioFilter !== 'all' && h.prioridade !== prioFilter) return false;
    
    return true;
  });
}

function updateStatusChart(done, partial) {
  const ctx = document.getElementById('chartStatus');
  
  if (chartStatus) chartStatus.destroy();
  chartStatus = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Conclu√≠das', 'Parciais'],
      datasets: [{
        data: [done, partial],
        backgroundColor: ['#0f5132', '#f9a825']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } }
    }
  });
}

function updateRankingChart(rankingMap) {
  const ctx = document.getElementById('chartRanking');
  const sorted = Object.entries(rankingMap).sort((a, b) => b[1] - a[1]);
  
  if (chartRanking) chartRanking.destroy();
  chartRanking = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(x => x[0]),
      datasets: [{
        label: 'Tarefas',
        data: sorted.map(x => x[1]),
        backgroundColor: '#7A1417'
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      scales: { x: { ticks: { stepSize: 1 } } }
    }
  });
}

function updateMotivosChart(motivosMap) {
  const ctx = document.getElementById('chartMotivos');
  const sorted = Object.entries(motivosMap).sort((a, b) => b[1] - a[1]);
  
  if (chartMotivos) chartMotivos.destroy();
  
  if (sorted.length === 0) {
    chartMotivos = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Sem dados'],
        datasets: [{ data: [1], backgroundColor: ['#e0e0e0'] }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  } else {
    chartMotivos = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: sorted.map(x => x[0]),
        datasets: [{
          data: sorted.map(x => x[1]),
          backgroundColor: ['#dc3545', '#ffc107', '#6c757d', '#17a2b8']
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }
}

// ===========================
// UTILIT√ÅRIOS
// ===========================

function calcDuration(start, end) {
  if (!start || start === "-" || !end) return "-";
  
  const d1 = new Date("01/01/2020 " + start);
  const d2 = new Date("01/01/2020 " + end);
  let diff = (d2 - d1) / 1000;
  if (diff < 0) diff = 0;
  
  const h = Math.floor(diff / 3600);
  const m = Math.floor((diff % 3600) / 60);
  const s = diff % 60;
  
  let result = "";
  if (h > 0) result += `${h.toString().padStart(2, '0')}h `;
  if (m > 0 || h > 0) result += `${m.toString().padStart(2, '0')}m `;
  result += `${s.toString().padStart(2, '0')}s`;
  
  return result;
}

function parseDatePTBR(str) {
  if (!str) return null;
  const parts = str.split('/');
  return new Date(parts[2], parts[1] - 1, parts[0]);
}

function parseDateInput(str) {
  if (!str) return null;
  const parts = str.split('-');
  return new Date(parts[0], parts[1] - 1, parts[2]);
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

// ===========================
// INICIALIZA√á√ÉO
// ===========================

window.onload = function() {
  console.log('Sistema Minerva Foods com Firebase carregado!');
  console.log('Usu√°rios dispon√≠veis:');
  Object.entries(DEMO_USERS).forEach(([email, user]) => {
    console.log(`- ${email} (${user.displayRole})`);
  });
  
  // Tentar conectar com Firebase
  if (isFirebaseConnected) {
    console.log('‚úÖ Firebase conectado com sucesso!');
    updateConnectionStatus(true, 'Online - Conectado');
  } else {
    console.log('‚ùå Firebase n√£o conectado. Usando modo offline.');
    updateConnectionStatus(false, 'Offline - Configure o Firebase');
  }
};

// Cleanup ao fechar a p√°gina
window.addEventListener('beforeunload', () => {
  destroyRealtimeListeners();
});
</script>

</body>
</html>
